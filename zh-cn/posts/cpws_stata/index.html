<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>裁判文书清洗指南 - 滑翔闪&#39;S BLOG</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="裁判文书清洗指南" />
<meta property="og:description" content="裁判文书清洗指南" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-01-13T18:52:19+08:00" />
<meta property="article:modified_time" content="2025-01-13T20:50:49+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="裁判文书清洗指南"/>
<meta name="twitter:description" content="裁判文书清洗指南"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" /><link rel="prev" href="https://blog.huaxiangshan.com/zh-cn/posts/econ_math/" /><link rel="next" href="https://blog.huaxiangshan.com/zh-cn/posts/fzqy/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "裁判文书清洗指南",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.huaxiangshan.com\/zh-cn\/posts\/cpws_stata\/"
        },"genre": "posts","keywords": "Stata, Python","wordcount":  12567 ,
        "url": "https:\/\/blog.huaxiangshan.com\/zh-cn\/posts\/cpws_stata\/","datePublished": "2025-01-13T18:52:19+08:00","dateModified": "2025-01-13T20:50:49+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "滑翔闪"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper">








<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakana 小组件集成</title>
    <style>
         
        #sakana-widget-container {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 268px;   
            height: 268px;  
        }
        #sakana-widget {
            width: 100%;
            height: 100%;
        }

         
        @media screen and (max-width: 600px) {
            #sakana-widget-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="sakana-widget-container">
        <div id="sakana-widget"></div>
    </div>

    <script>
        function initSakanaWidget() {
            new SakanaWidget({
                size: 300,  
                autoFit: true,  
                character: 'chisato',  
                controls: true,  
                rod: true,  
                draggable: true,  
                stroke: {
                    color: '#b4b4b4',  
                    width: 10  
                },
                threshold: 0.1,  
                rotate: 0,  
                title: false  
            }).mount('#sakana-widget');
        }

        
        function checkScreenWidth() {
            var screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            var container = document.getElementById('sakana-widget-container');
            if (screenWidth <= 960) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
            }
        }

        
        checkScreenWidth();

        
        window.addEventListener('resize', checkScreenWidth);

        
        initSakanaWidget();
    </script>
    <script
        async
        onload="initSakanaWidget()"
        src="https://cdn.jsdelivr.net/npm/sakana-widget@2.2.2/lib/sakana.min.js"
    ></script>
</body>
</html>



<script type="text/javascript" color="0,174,255" opacity='0.7' zIndex="-2" count="200" src="https://www.liuzehe.top/upload/bkjs/bj.js"></script><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/zh-cn/" title="滑翔闪&#39;S BLOG"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/%E7%9F%9B%E7%9B%BE.png"
        data-srcset="/images/%E7%9F%9B%E7%9B%BE.png, /images/%E7%9F%9B%E7%9B%BE.png 1.5x, /images/%E7%9F%9B%E7%9B%BE.png 2x"
        data-sizes="auto"
        alt="/images/%E7%9F%9B%E7%9B%BE.png"
        title="/images/%E7%9F%9B%E7%9B%BE.png" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/zh-cn/posts/" title="书中自有黄金屋"><i class='fa fa-solid fa-book'></i> 文章 </a><a class="menu-item" href="/zh-cn/tags/" title="定义文章，不定义世界"><i class='fa fa-tag'></i> 标签 </a><a class="menu-item" href="/zh-cn/categories/" title="分类是种视角"><i class='fa fa-archive'></i> 分类 </a><a class="menu-item" href="/zh-cn/friends/" title="有朋自远方来"><i class='fa fa-user-group'></i> 友链  </a><a class="menu-item" href="/zh-cn/about/" title="人穷其一生寻找自己"> <i class='fa fa-address-card'></i> 关于 </a><a class="menu-item" href="https://www.travellings.cn/go.html" title="漫长的列车驶向未来" rel="noopener noreffer" target="_blank"><i class='fa fa-train-subway'></i> 开往  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="吾将上下而求索" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="选择语言">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/zh-cn/posts/cpws_stata/" selected>简体中文</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/zh-cn/" title="滑翔闪&#39;S BLOG"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/%E7%9F%9B%E7%9B%BE.png"
        data-srcset="/images/%E7%9F%9B%E7%9B%BE.png, /images/%E7%9F%9B%E7%9B%BE.png 1.5x, /images/%E7%9F%9B%E7%9B%BE.png 2x"
        data-sizes="auto"
        alt="/images/%E7%9F%9B%E7%9B%BE.png"
        title="/images/%E7%9F%9B%E7%9B%BE.png" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="吾将上下而求索" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/zh-cn/posts/" title="书中自有黄金屋"><i class='fa fa-solid fa-book'></i>文章</a><a class="menu-item" href="/zh-cn/tags/" title="定义文章，不定义世界"><i class='fa fa-tag'></i>标签</a><a class="menu-item" href="/zh-cn/categories/" title="分类是种视角"><i class='fa fa-archive'></i>分类</a><a class="menu-item" href="/zh-cn/friends/" title="有朋自远方来"><i class='fa fa-user-group'></i>友链 </a><a class="menu-item" href="/zh-cn/about/" title="人穷其一生寻找自己"> <i class='fa fa-address-card'></i>关于</a><a class="menu-item" href="https://www.travellings.cn/go.html" title="漫长的列车驶向未来" rel="noopener noreffer" target="_blank"><i class='fa fa-train-subway'></i>开往 </a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/zh-cn/posts/cpws_stata/" selected>简体中文</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><script>
			(function(){
				if( 1450169683 ){
					if (prompt('请输入文章密码') !=  1450169683 ){
						alert('密码错误！');
						if (history.length === 1) {
							window.opener = null;
							window.open('', '_self');
							window.close();
						} else {
							history.back();
						}
					}
				}
			})();
		</script><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">裁判文书清洗指南</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/hzp2333/hzp2333.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>滑翔闪</a></span>&nbsp;<span class="post-category">收录于 <a href="/zh-cn/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%B9%A0/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>经济学习</a></span></div>

            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-01-13">2025-01-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 12567 字
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 26 分钟&nbsp;
    

    
        

        
        
            <span id="busuanzi_container_value_page_pv"><i class="far fa-eye fa-fw"></i>
                
                <span id="busuanzi_value_page_pv"></span>&nbsp;次阅读</span>
        
    

</div>

        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp"
        data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp 2x"
        data-sizes="auto"
        alt="/img/裁判文书清洗指南.zh-cn-20250113205250946.webp"
        title="/img/裁判文书清洗指南.zh-cn-20250113205250946.webp" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#裁判文书资源">裁判文书资源</a></li>
    <li><a href="#txt-文件的处理">txt 文件的处理</a>
      <ul>
        <li><a href="#一些建议">一些建议</a></li>
        <li><a href="#乱码文档">乱码文档</a></li>
      </ul>
    </li>
    <li><a href="#例子-1python-提取案件号序列">例子 1：python 提取案件号序列</a>
      <ul>
        <li><a href="#思路">思路</a></li>
        <li><a href="#单个-txt-的处理">单个 txt 的处理</a></li>
        <li><a href="#批量处理">批量处理</a></li>
      </ul>
    </li>
    <li><a href="#例子-2python-提取法条和移动文件夹">例子 2：python 提取法条和移动文件夹</a>
      <ul>
        <li><a href="#多个-txt">多个 txt</a></li>
        <li><a href="#移动-txt">移动 txt</a></li>
      </ul>
    </li>
    <li><a href="#dta-数据的匹配">dta 数据的匹配</a>
      <ul>
        <li><a href="#标识的去重">标识的去重</a></li>
        <li><a href="#文本匹配标识的格式转化">文本匹配标识的格式转化</a></li>
        <li><a href="#匹配命令的选择">匹配命令的选择</a></li>
        <li><a href="#循环匹配命令">循环匹配命令</a></li>
        <li><a href="#匹配速度的优化">匹配速度的优化</a></li>
      </ul>
    </li>
    <li><a href="#dta-数据的清洗">dta 数据的清洗</a>
      <ul>
        <li><a href="#常用文本处理函数">常用文本处理函数</a>
          <ul>
            <li><a href="#去除空格">去除空格</a></li>
            <li><a href="#筛选特定字符">筛选特定字符</a></li>
            <li><a href="#去除特殊字符">去除特殊字符</a></li>
          </ul>
        </li>
        <li><a href="#正则表达式提取">正则表达式提取</a>
          <ul>
            <li><a href="#字符筛选">字符筛选</a></li>
            <li><a href="#数字提取">数字提取</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#dta-时间修正">dta 时间修正</a></li>
    <li><a href="#例子3-python-跨行匹配">例子3 ：python 跨行匹配</a>
      <ul>
        <li><a href="#任务与思路">任务与思路</a></li>
        <li><a href="#代码">代码</a></li>
        <li><a href="#提醒">提醒</a></li>
      </ul>
    </li>
    <li><a href="#例子-4-python-提取上诉法官过去和现在的特征均值">例子 4 ：python 提取上诉法官过去和现在的特征均值</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="裁判文书清洗手册">裁判文书清洗手册</h1>
<p>作者：滑翔闪</p>
<ul>
<li>这个文档既是目前工作的汇报，也是一些经验的总结。</li>
<li>或许能方便后面的同学更快上手裁判文书的清洗工作。</li>
<li>希望未来的同学能重视工程技巧的优化总结与文档分享。</li>
</ul>
<p><strong>思考如何优化工程，优化团队协作，让积累和输出成为一种能力</strong>。</p>
<p>世界不但需要输入，也需要输出，知识的分享与传递才是人类文明不断进步的纽带。</p>
<p>关于 AI 工具的推荐：</p>
<p><a href="https://tongyi.aliyun.com/" target="_blank" rel="noopener noreffer ">通义千问</a>：<strong>上下文记忆能力长</strong>，能让它改善长代码。</p>
<p><a href="https://chat.openai.com/auth/login" target="_blank" rel="noopener noreffer ">GPT</a> ：<strong>更了解 stata 的函数</strong>。在我处理字符串变量时，通义千问经常用复杂的命令处理，通常还报错，而 GPT 知道很多 stata 的不常用函数，一行代码就可以轻松搞定。</p>
<p><a href="https://chat.deepseek.com/" target="_blank" rel="noopener noreffer ">deepseek</a> :国内新秀。 语言表达很不错。能很快理解使用者的意思。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #7d637a; background-color: #f6edf5; border-color: #f1e4f0;">
&#x1F4AC
    <b> 备注：裁判文书的清洗需要交替处理中文和数字。本文档会多提一些 python 和 stata 的常用正则表达式。
</b></div>
<p>AI 虽然掌握了很多函数，但它不知道怎么组合。</p>
<p>谋篇布局的算法理解才是我们的最大优势。</p>
<p>提问时要替 AI 理顺代码的算法。</p>
<p>有了 AI 后——知道什么包能实现什么功能，在算法下有什么作用，比掌握细节更重要。</p>
<h2 id="裁判文书资源">裁判文书资源</h2>
<p><strong>原始文本数据</strong>：一堆 txt 文件。每一行是一条裁判文书信息，Txt 文件以 “万”作为文件名，因此下面使用整数部分的数字代表每个 txt 文件。</p>
<p>配套的文档是压缩包、文书字典、变量含义表格。
​

<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113205914854.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113205914854.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p><strong>提示</strong>😍：每个 txt 文件都很大，一般软件打不开。个人推荐使用 <a href="https://www.emeditor.com/" target="_blank" rel="noopener noreffer ">EmEditor</a> 软件查看。积极使用 <a href="https://www.emeditor.com/" target="_blank" rel="noopener noreffer ">EmEditor</a> 软件查看例子，能让我们更好地了解乱码情况和裁判文书的书写规则，以便改进我们的文本处理代码。</p>
<ul>
<li><strong>Dta 数据</strong>：前辈们清洗好的 stata 文件。拆分为了 ans 1—ans 83。格式刷 stata 的 <code>.dta</code>格式</li>
</ul>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210027701.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210027701.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p>一套完整的清洗流程就是：</p>
<p>从原始的 txt 中筛选提取我们需要的信息，最终成为能导入 stata 使用的数据。</p>
<h2 id="txt-文件的处理">txt 文件的处理</h2>
<p>Txt 的裁判文书大部分已经处理为了 json格式，python 读取其实较为方便。</p>
<p>其中，大部分裁判文书 txt 文件是下方的 s 系列命名结构：</p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp" title="重要的信息都在第三列，s*系列包含的数据结构当中" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210107895.webp" data-sub-html="<h2> </h2><p>重要的信息都在第三列，s*系列包含的数据结构当中</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210107895.webp" />
    </a><figcaption class="image-caption">重要的信息都在第三列，s*系列包含的数据结构当中</figcaption>
    </figure></p>
<p>重要的信息都在第三列，s*系列包含的数据结构当中</p>
<p>但跑通了一到三份 txt 文件不等于能跑通所有。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #a94442; background-color: #f2dede; border-color: #ebccd1;">
&#x26D4<b> Txt 的裁判文书还存在一些其他格式：
<ul>
<li>有些 txt 文件格式为 DocInfoVo 开头的。</li>
<li>有些 txt 文件格式为 title 开头的。</li>
<li>有些 txt 文件格式夹杂着 HTML 语言。</li>
<li>有些 txt 文件格式是纯粹的乱码。</li>
<li>有些格式中 s 系列和 DocInfoVo 格式混在一起，导致循环代码被打断。
</b></div></li>
</ul>
<p>因此处理时得考虑<strong>代码的兼容性和全面性</strong>，分开写处理代码，然后对这种 txt 文件处理两次。</p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210203690.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210203690.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210207504.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210207504.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<h3 id="一些建议">一些建议</h3>
<p>由于循环容易被打断，用 txt 进行处理处理时，建议参考如下逻辑：</p>
<p>1、将乱码的 txt（附在后文）和 s 系列的 txt 分开处理</p>
<p>2、原始文件为 txt，清洗处理后生成新的 cleaned_txt。</p>
<p>3、由于清洗循环命令容易被打断，最好多写一个命令：对比 txt 和 cleaned_txt 的文件名。</p>
<p>4、多写一个步骤：将处理完成的 txt 文档移动到另一个文件夹，修改报错代码后继续循环。</p>
<blockquote>
<p>Python 默认读取文件的顺序是 txt 1 txt 10 text 111&hellip; 而不是 1、2、3&hellip;</p>
</blockquote>
<h3 id="乱码文档">乱码文档</h3>
<p>不只是 s 系列格式的 txt 文件有：</p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210248250.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210248250.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<h2 id="例子-1python-提取案件号序列">例子 1：python 提取案件号序列</h2>
<h3 id="思路">思路</h3>
<p>python 读取 txt 的 json 格式。</p>
<p>提取第三列 <code>CourtInfo</code> 数据。</p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210332387.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210332387.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p>s 23 变量所有案件号，以此追踪<strong>一审二审再审终审</strong>。</p>
<p>例如 <code>（2016）沪0104民初33043号</code> ，其实就是一个裁判文书案件的身份证号。</p>
<p>正则表达式筛选：按照 <code>（年份）初\终\再 号</code> 的规则提取满足要求的字符串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;[（(]\d</span><span class="si">{4}</span><span class="s2">[)）][^号]*?(?:初|终|再)[^号]*?号&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>提取后去除重、排除包含“<code>['X', 'x', 'Ｘ', '执', '不动产', '-', '第']</code>”的案件号。</p>
<blockquote>
<p>如果继续使用这种方法提取，排除时最好加入 <strong>辖</strong>。</p>
<p>这种案号也有辖初、辖再、辖终，但只表示法院在管理权上的划分。</p>
<p>（或许以后还有人能想到用这个特征做研究？👍）</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;Ｘ&#39;</span><span class="p">,</span> <span class="s1">&#39;执&#39;</span><span class="p">,</span> <span class="s1">&#39;不动产&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;第&#39;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>排序，优先按照案号中的 (年份) 进行排序。 删除案号数量大于等于 5 的所有行。</p>
<p>一个案子最多是如下的顺序：</p>
<p>初审，不服申请上诉，再审，终审，不服再进行上诉，终审。</p>
<p>可以直接从初审跳到终审，终审后还有最后一次再审机会，再审结束后一般就不会更改了。</p>
<blockquote>
<p>个人的排序逻辑：（此处最大的漏洞是我想不到怎么完美识别“再”案号的位置）</p>
<p>生成 m 1——m 4 四个变量 带有初的案号归类到 m 1，带有终的案号归类到 m 3。</p>
<p>带有再的情况：</p>
<p>如果只有初和再，再归类到 m 2</p>
<p>如果只再，我默认放在 m 4</p>
<p>如果同时有终、再，根据相对位置判断再是 m 2 还是 m 4。</p>
<p>后面发现：【辖终】会干扰顺序，所以先将包含辖的案号清除，然后和被其挤到 m 4 的【终】案号交换顺序。</p>
<p>这就是大数据最麻烦的点：</p>
<p><strong>如果前面工作没有完美做好，后面返工成本会越来越高。 最糟糕的是——大数据总是很难穷尽所有乱码可能。</strong></p>
</blockquote>
<h3 id="单个-txt-的处理">单个 txt 的处理</h3>
<p>以下代码只针对 <strong>s 系列</strong>命名的文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">json</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 读取数据  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;F:/桌面/裁判文书数据库/test/test.txt&#34;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看前几行数据  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 假设 CourtInfo 列中包含 JSON 字符串  </span>
</span></span><span class="line"><span class="cl"> <span class="n">json_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 解析 JSON 数据  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 应用解析函数  </span>
</span></span><span class="line"><span class="cl"> <span class="n">parsed_prac_c</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_json</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 将 JSON 字典转换为 DataFrame，并处理缺失值  </span>
</span></span><span class="line"><span class="cl"> <span class="n">json_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">parsed_prac_c</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看转换后的 DataFrame  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">json_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 正则表达式模式  </span>
</span></span><span class="line"><span class="cl"> <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;[（(]\d</span><span class="si">{4}</span><span class="s2">[）)]\s*.*?号&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 使用findall提取所有匹配项  </span>
</span></span><span class="line"><span class="cl"> <span class="n">matches</span> <span class="o">=</span> <span class="n">json_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看转换后的 DataFrame  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 创建新的 DataFrame，将更新后的 &#39;s23&#39; 列保存  </span>
</span></span><span class="line"><span class="cl"> <span class="n">matches_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;s23&#39;</span><span class="p">:</span> <span class="n">matches</span>  
</span></span><span class="line"><span class="cl"> <span class="p">})</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看转换后的 DataFrame  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">matches_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># print(matches_df)  </span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 选择要合并的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">selected_data_columns</span> <span class="o">=</span> <span class="p">[]</span>   
</span></span><span class="line"><span class="cl"> <span class="n">selected_json_df_columns</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 合并选择的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">selected_data_columns</span><span class="p">],</span> <span class="n">json_df</span><span class="p">[</span><span class="n">selected_json_df_columns</span><span class="p">],</span><span class="n">matches_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># 将列表转换为字符串，元素之间用逗号和空格分隔  </span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;[]&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl">         <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">cleaned_text</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 切割并生成列名  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">split_and_rename</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">content</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">split_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;m</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_content</span><span class="p">))</span> <span class="k">if</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">result</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 应用函数  </span>
</span></span><span class="line"><span class="cl"> <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_and_rename</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看结果  </span>
</span></span><span class="line"><span class="cl"> <span class="c1"># print(&#34;Expanded DataFrame:&#34;)  </span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 提取年份的函数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">extract_year</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[（(](\d</span><span class="si">{4}</span><span class="s1">)[）)]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="k">match</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 清洗和排序函数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">clean_and_sort</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 过滤掉非字符串类型的值  </span>
</span></span><span class="line"><span class="cl">     <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 去除重复项并保持顺序  </span>
</span></span><span class="line"><span class="cl">     <span class="n">unique_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 按年份排序  </span>
</span></span><span class="line"><span class="cl">     <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 需要排除的关键字列表  </span>
</span></span><span class="line"><span class="cl"> <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;Ｘ&#39;</span><span class="p">,</span> <span class="s1">&#39;执&#39;</span><span class="p">,</span> <span class="s1">&#39;不动产&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;第&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 筛选所有 m* 列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">m_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 对每一行应用清洗和排序函数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 获取 m* 列的内容  </span>
</span></span><span class="line"><span class="cl">     <span class="n">row_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_columns</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 扁平化列表  </span>
</span></span><span class="line"><span class="cl">     <span class="n">flattened</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">row_values</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sublist</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">sublist</span><span class="p">])]</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 处理并排序  </span>
</span></span><span class="line"><span class="cl">     <span class="n">sorted_items</span> <span class="o">=</span> <span class="n">clean_and_sort</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 应用到数据框的每一行  </span>
</span></span><span class="line"><span class="cl"> <span class="n">sorted_results</span> <span class="o">=</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">process_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 创建新的数据框  </span>
</span></span><span class="line"><span class="cl"> <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="n">sorted_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">)])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 打印结果  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">sorted_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 合并到原数据  </span>
</span></span><span class="line"><span class="cl"> <span class="n">combined_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">combined_df</span><span class="p">,</span> <span class="n">sorted_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看结果  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">combined_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 检查 &#39;m_sorted_5&#39; 列是否存在，并删除非空行  </span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="s1">&#39;m_sorted_5&#39;</span> <span class="ow">in</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="p">[</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 如果列不存在，则保留原数据框  </span>
</span></span><span class="line"><span class="cl">     <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 打印结果  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取所有 m_sorted_* 列的名称  </span>
</span></span><span class="line"><span class="cl"> <span class="n">m_sorted_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m_sorted_&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 过滤出索引大于等于 5 的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_sorted_columns</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 删除指定的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_drop</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 打印结果以检查清理后的数据框  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="n">combined_df2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;F:/桌面/combined_df.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="批量处理">批量处理</h3>
<p>个人选择的批量处理思路是循环处理一个文件夹下面的所有文档。</p>
<p>循环容易被打断，建议写一个报错记录，和处理完一个文档便移动的命令。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">json</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义输入和输出文件夹路径  </span>
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义输入和输出文件夹路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">input_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/数据/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">output_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/清洗结果/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 如果输出文件夹不存在，则创建它  </span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 遍历输入文件夹中的所有 .txt 文件  </span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">input_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 读取数据  </span>
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前3行数据以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processing file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 解析JSON字段  </span>
</span></span><span class="line"><span class="cl">         <span class="n">json_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="n">parsed_prac_c</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_json</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 将解析后的JSON转换为DataFrame  </span>
</span></span><span class="line"><span class="cl">         <span class="n">json_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">parsed_prac_c</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前20行以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">json_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 定义匹配模式  </span>
</span></span><span class="line"><span class="cl">         <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;[（(]\d</span><span class="si">{4}</span><span class="s2">[）)]\s*.*?号&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 查找匹配项  </span>
</span></span><span class="line"><span class="cl">         <span class="n">matches</span> <span class="o">=</span> <span class="n">json_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前3行匹配结果以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 将匹配结果转换为DataFrame  </span>
</span></span><span class="line"><span class="cl">         <span class="n">matches_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;s23&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">})</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前10行匹配结果DataFrame以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">matches_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 选择要保留的数据列  </span>
</span></span><span class="line"><span class="cl">         <span class="n">selected_data_columns</span> <span class="o">=</span> <span class="p">[]</span>   
</span></span><span class="line"><span class="cl">         <span class="n">selected_json_df_columns</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 合并原始数据、解析后的JSON数据以及匹配结果  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">selected_data_columns</span><span class="p">],</span> <span class="n">json_df</span><span class="p">[</span><span class="n">selected_json_df_columns</span><span class="p">],</span> <span class="n">matches_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 清洗文本函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;[]&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                     <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="n">cleaned_text</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 分割并重命名函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">split_and_rename</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="n">content</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="n">split_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;m</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_content</span><span class="p">))</span> <span class="k">if</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">result</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 展开匹配结果  </span>
</span></span><span class="line"><span class="cl">         <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_and_rename</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 提取年份函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">extract_year</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[（(](\d</span><span class="si">{4}</span><span class="s1">)[）)]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="k">match</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 清洗并排序函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">clean_and_sort</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">             <span class="n">unique_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">             <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 排除关键词列表  </span>
</span></span><span class="line"><span class="cl">         <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;Ｘ&#39;</span><span class="p">,</span> <span class="s1">&#39;执&#39;</span><span class="p">,</span> <span class="s1">&#39;不动产&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;第&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 获取所有m开头的列名  </span>
</span></span><span class="line"><span class="cl">         <span class="n">m_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 处理每一行  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="n">row_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_columns</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">             <span class="n">flattened</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">row_values</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sublist</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">sublist</span><span class="p">])]</span>  
</span></span><span class="line"><span class="cl">             <span class="n">sorted_items</span> <span class="o">=</span> <span class="n">clean_and_sort</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="n">sorted_results</span> <span class="o">=</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">process_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 计算最大长度，并创建新的排序后的DataFrame  </span>
</span></span><span class="line"><span class="cl">         <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">         <span class="n">sorted_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">)])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 再次合并数据  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">combined_df</span><span class="p">,</span> <span class="n">sorted_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 过滤条件  </span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="s1">&#39;m_sorted_5&#39;</span> <span class="ow">in</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="p">[</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">         <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印清理后的前10行数据以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 获取所有m_sorted开头的列名  </span>
</span></span><span class="line"><span class="cl">         <span class="n">m_sorted_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m_sorted_&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 要删除的列名  </span>
</span></span><span class="line"><span class="cl">         <span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_sorted_columns</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 删除不需要的列  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_drop</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印最终前几行数据以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 保存到文件  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Processing complete.&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="例子-2python-提取法条和移动文件夹">例子 2：python 提取法条和移动文件夹</h2>
<p>法条数量可以衡量案件复杂度，法条本身也衡量了案件类型。</p>
<p>Txt 文档的 s 47 系列对应着文书的法条，里面是第二层 json 格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">fgmc</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fgmc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">tkx</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tkx&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(第.*?条)&#39;</span><span class="p">,</span> <span class="n">tkx</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>['s23', 's25', 's26', 's27']</code> 的中文字符加总就是裁判文书的正文字数。</p>
<blockquote>
<p>&ldquo;s7&rdquo;: &ldquo;案件号&rdquo;,&ldquo;s23&rdquo;: &ldquo;诉讼记录&rdquo;,&ldquo;s24&rdquo;: &ldquo;诉控辩&rdquo;,&ldquo;s25&rdquo;: &ldquo;事实&rdquo;,&ldquo;s26&rdquo;: &ldquo;理由&rdquo;,&ldquo;s27&rdquo;: &ldquo;判决结果&rdquo;。</p>
</blockquote>
<h3 id="多个-txt">多个 txt</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">json</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">glob</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">logging</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 配置日志记录  </span>
</span></span><span class="line"><span class="cl"> <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 明确指定输入文件夹和输出文件夹的路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">input_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/数据/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">output_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/清洗结果/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">log_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/日志/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 确保输出文件夹和日志文件夹存在  </span>
</span></span><span class="line"><span class="cl"> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 解析 JSON 数据  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">json_str</span>  
</span></span><span class="line"><span class="cl">         <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;未知数据类型: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">     <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;JSON 解析失败: </span><span class="si">{</span><span class="n">json_str</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 计算中文字符数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">count_chinese_chars</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\u4e00-\u9fff\u0030-\u0039\u3000-\u303f\uff00-\uffef]&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 提取和格式化条款  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">extract_clauses</span><span class="p">(</span><span class="n">s47_data</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">formatted_clauses</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">s47_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="n">parse_json</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">clauses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># 使用集合去重  </span>
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">fgmc</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fgmc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">tkx</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tkx&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(第.*?条)&#39;</span><span class="p">,</span> <span class="n">tkx</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">if</span> <span class="k">match</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                     <span class="n">clauses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">fgmc</span><span class="si">}{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="n">formatted_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">clauses</span><span class="p">))</span>  <span class="c1"># 保存每行提取的条款  </span>
</span></span><span class="line"><span class="cl">         <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">formatted_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>  <span class="c1"># 如果解析失败，则添加空列表  </span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">formatted_clauses</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 处理单个文件  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">process_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">log_folder</span><span class="p">,</span> <span class="n">total_rows</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 初始化一个空的列表来存储错误信息  </span>
</span></span><span class="line"><span class="cl">     <span class="n">error_logs</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="k">def</span> <span class="nf">bad_line_handler</span><span class="p">(</span><span class="n">bad_line</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">error_logs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">input_file</span><span class="p">,</span> <span class="n">bad_line</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">bad_line</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 读取数据  </span>
</span></span><span class="line"><span class="cl">     <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="n">bad_line_handler</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Read </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error reading file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 过滤掉 CourtInfo 列以 &#34;DocInfoVo&#34; 开头或无法解析为 JSON 的行  </span>
</span></span><span class="line"><span class="cl">     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#34;s1&#34;:&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parse_json</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">dict</span><span class="p">))]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Filtered out invalid rows from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 提取 JSON 数据  </span>
</span></span><span class="line"><span class="cl">     <span class="n">json_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 应用解析函数  </span>
</span></span><span class="line"><span class="cl">     <span class="n">parsed_prac_c</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_json</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Parsed JSON data from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 将 JSON 字典转换为 DataFrame，并处理缺失值  </span>
</span></span><span class="line"><span class="cl">     <span class="n">json_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">parsed_prac_c</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Normalized JSON data from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 选取特定列  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span> <span class="o">=</span> <span class="n">json_df</span><span class="p">[[</span><span class="s1">&#39;s7&#39;</span><span class="p">,</span> <span class="s1">&#39;s23&#39;</span><span class="p">,</span> <span class="s1">&#39;s25&#39;</span><span class="p">,</span> <span class="s1">&#39;s26&#39;</span><span class="p">,</span> <span class="s1">&#39;s27&#39;</span><span class="p">,</span> <span class="s1">&#39;s47&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 使用 .copy() 创建副本  </span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 计算 s26 列中“条”字的出现次数  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;count_tiao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;s26&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;条&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Calculated &#39;count_tiao&#39; from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 计算 s23, s25, s26, s27 列的总字数  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;total_chars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_columns</span><span class="p">[[</span><span class="s1">&#39;s23&#39;</span><span class="p">,</span> <span class="s1">&#39;s25&#39;</span><span class="p">,</span> <span class="s1">&#39;s26&#39;</span><span class="p">,</span> <span class="s1">&#39;s27&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">         <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_chinese_chars</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl">     <span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Calculated &#39;total_chars&#39; from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 提取和格式化条款  </span>
</span></span><span class="line"><span class="cl">     <span class="n">unique_clauses</span> <span class="o">=</span> <span class="n">extract_clauses</span><span class="p">(</span><span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;s47&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;unique_clauses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_clauses</span>  <span class="c1"># 使用 .loc 进行安全赋值  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;clause_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span> <span class="k">for</span> <span class="n">clauses</span> <span class="ow">in</span> <span class="n">unique_clauses</span><span class="p">]</span>  <span class="c1"># 每行的条款数量  </span>
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Extracted and formatted clauses from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 生成输出文件名  </span>
</span></span><span class="line"><span class="cl">     <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;cleaned_</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 将结果保存为 txt 文件  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[[</span><span class="s1">&#39;s7&#39;</span><span class="p">,</span> <span class="s1">&#39;count_tiao&#39;</span><span class="p">,</span> <span class="s1">&#39;total_chars&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_clauses&#39;</span><span class="p">,</span> <span class="s1">&#39;clause_count&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processed and saved to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 汇报进度  </span>
</span></span><span class="line"><span class="cl">     <span class="n">processed_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已完成处理文件: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">, 条目数: </span><span class="si">{</span><span class="n">processed_rows</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_rows</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 保存错误日志  </span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="n">error_logs</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;error_log_</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.txt&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">error_logs</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;File: </span><span class="si">{</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Line: </span><span class="si">{</span><span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, Content: </span><span class="si">{</span><span class="n">log</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error logs saved to: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 遍历输入文件夹中的所有文件  </span>
</span></span><span class="line"><span class="cl"> <span class="n">all_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="s2">&#34;*.txt&#34;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="n">processed_files</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="ow">not</span> <span class="n">all_files</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;No files found in the input folder.&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 汇报当前处理的文件进度  </span>
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;正在处理文件: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">processed_files</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">process_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_folder_path</span><span class="p">,</span> <span class="n">log_folder_path</span><span class="p">,</span> <span class="n">total_files</span><span class="p">)</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><p> ​</p>
<h3 id="移动-txt">移动 txt</h3>
<p>因为代码循环非常容易被打断，我建议设置<strong>三个文件夹</strong>：</p>
<p>原始文件夹存放原始数据，</p>
<p>结果文件夹存放处理完成的数据，统一改为 <code>cleaned_*</code> 的 txt 名字，</p>
<p>清洗完成的文件夹：把清洗完成的原始数据放到这里，便于循环打断后继续开始，</p>
<p>因此本代码的逻辑就是对照<strong>清洗完成的文件夹</strong>和<strong>原始文件夹</strong>，将名字有对应的 txt 文档进行移动。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">shutil</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义文件夹路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">source_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:/桌面/测试/清洗结果&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">data_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:/桌面/测试/数据&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">cleaned_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:/桌面/测试/完成提取&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取源文件夹中的所有.txt文件名（不含路径），并去除前缀 &#34;cleaned_&#34;，同时去除所有多余空格并转换为小写  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">standardize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取源文件夹中的文件名  </span>
</span></span><span class="line"><span class="cl"> <span class="n">source_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cleaned_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="n">standardized_source_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">standardize_filename</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">8</span><span class="p">:]):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source_files</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取数据文件夹中的文件名  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="n">standardized_data_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">standardize_filename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 找出数据文件夹中与源文件夹中相同的文件  </span>
</span></span><span class="line"><span class="cl"> <span class="n">common_files</span> <span class="o">=</span> <span class="n">standardized_source_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">standardized_data_files</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 移动相同的文件到清洗完成文件夹  </span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">common_files</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">original_filename</span> <span class="o">=</span> <span class="n">standardized_source_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">     <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">original_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cleaned_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="n">destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_folder</span><span class="p">,</span> <span class="n">original_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cleaned_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 确保目标文件夹存在  </span>
</span></span><span class="line"><span class="cl">     <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">destination_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Moved: </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">destination_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Process completed.&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dta-数据的匹配">dta 数据的匹配</h2>
<h3 id="标识的去重">标识的去重</h3>
<p>Txt 提取完成后，就是转化为 <code>.dta</code> 匹配到 <code>ans*.dta</code> 中。</p>
<p><strong>案号</strong>是理论上的唯一标识，但实际上可能出现重复的情况。</p>
<p>这时候建议使用以下逻辑，先历遍所有变量，生成非空数值总数，去重，在案号的重复行间保留非空数值最多的一行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">标记重复的</span> <span class="n">case_wid</span><span class="err">，</span><span class="n">并计算每组的数量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">bysort</span> <span class="n">case_wid</span><span class="p">:</span> <span class="n">gen</span> <span class="n">dup_count</span> <span class="o">=</span> <span class="n">_N</span>  
</span></span><span class="line"><span class="cl">     <span class="n">replace</span> <span class="n">dup_count</span> <span class="o">=</span> <span class="o">.</span> <span class="k">if</span> <span class="n">_n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">//</span> <span class="n">可选</span><span class="err">：</span><span class="n">只保留第一次出现的计数</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">创建一个包含所有要检查的变量的局部宏</span>  
</span></span><span class="line"><span class="cl">     <span class="n">local</span> <span class="n">varlist</span> <span class="n">var1</span> <span class="n">var2</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">使用循环创建标志变量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">foreach</span> <span class="n">var</span> <span class="n">of</span> <span class="n">local</span> <span class="n">varlist</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">         <span class="n">gen</span> <span class="n">flag_</span><span class="err">`</span><span class="n">var</span><span class="s1">&#39; = cond(missing(`var&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="p">}</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">计算每行中非空值的数量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">egen</span> <span class="n">non_missing</span> <span class="o">=</span> <span class="n">rowtotal</span><span class="p">(</span><span class="n">flag</span><span class="o">*</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">对每个</span> <span class="n">case_wid</span> <span class="n">按非空变量数量降序排序</span><span class="err">，</span><span class="n">并标记保留的观测值</span>  
</span></span><span class="line"><span class="cl">     <span class="n">bysort</span> <span class="n">case_wid</span> <span class="p">(</span><span class="n">non_missing</span><span class="p">):</span> <span class="n">gen</span> <span class="n">keep</span> <span class="o">=</span> <span class="p">(</span><span class="n">_n</span> <span class="o">==</span> <span class="n">_N</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">清理临时变量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">capture</span> <span class="n">drop</span> <span class="n">flag</span><span class="o">*</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">删除重复值</span><span class="err">，</span><span class="n">保留非空变量最多的行</span>  
</span></span><span class="line"><span class="cl">     <span class="n">drop</span> <span class="k">if</span> <span class="err">!</span><span class="n">keep</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">清理辅助变量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">drop</span> <span class="n">dup_count</span> <span class="n">non_missing</span> <span class="n">keep</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">保存处理后的文件</span><span class="err">，</span><span class="n">覆盖原有文件</span>  
</span></span><span class="line"><span class="cl">     <span class="n">save</span> <span class="s2">&#34;`input_file&#39;&#34;</span><span class="p">,</span> <span class="n">replace</span>  
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="文本匹配标识的格式转化">文本匹配标识的格式转化</h3>
<p><code>ans*.dta</code> 系列的文本格式都是 <code>strL</code>，含义为长字符串。Stata 的字符串匹配只能选择有具体长度的字符串格式，我们可以通过字符截取来改变变量格式。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #31708f; background-color: #d9edf7; border-color: #bce8f1;">
&#x1F50A<b> 重要：注意，英文字符的占位符和中文字符的占位符是不同的。</b>
</div>
<blockquote>
<p>例如“民初 730 号”，虽然只是六个字符，但可能实际上占了 15 个位置。</p>
<p>如果我们只截取 6 个长度，变量就会变成乱码。</p>
<p>个人观察到的案号占位符最长大概是 39 个位置，个人为了稳健直接选择的截取 88 个字符符号。</p>
<p>这也意味着： 我们需要在清理掉文本中的奇怪符号以后再转化。</p>
<p>例如有些法院名字是&quot;<code>广西壮族自治区柳州市鱼峰区人民法院</code>&quot;</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> # 截取字符  
</span></span><span class="line"><span class="cl"> gen judge_fin2 = substr(judge_fin, 1, 45)  
</span></span><span class="line"><span class="cl"> gen court_name2 = substr(court_name, 1, 88)  
</span></span><span class="line"><span class="cl"> drop judge_fin court_name  
</span></span><span class="line"><span class="cl"> rename judge_fin2  judge_fin  
</span></span><span class="line"><span class="cl"> rename court_name2 court_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="匹配命令的选择">匹配命令的选择</h3>
<p><strong>多（基础表格）对一时</strong>：<code>merge</code> 命令直接使用。</p>
<p><strong>一（基础表格）対多时</strong>：例如 txt 有一些重复记录，但是不同行的空缺值不同。我们可以使用 <code>merge</code> 的追加匹配 <code>update nogen force</code>，只在这一行有空缺时，将空缺值的变量匹配上去；非空缺的部分则不更改。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> clear   
</span></span><span class="line"><span class="cl"> forvalues j = 1/83 {  
</span></span><span class="line"><span class="cl">     use &#34;D:\数据合集\原始数据\ans`j&#39;.dta&#34;, clear  
</span></span><span class="line"><span class="cl">     merge 1:m case_wid_str using &#34;C:\Users\PC\Desktop\hzp_project_re\一审二审数据匹配\排序\面板数据\all.dta&#34;, update nogen force  
</span></span><span class="line"><span class="cl">     drop if case_wid == &#34;&#34;  
</span></span><span class="line"><span class="cl"> duplicates drop case_wid_str , force  
</span></span><span class="line"><span class="cl">     save &#34;C:\Users\PC\Desktop\hzp_project_re\一审二审数据匹配\排序\面板数据\ans`j&#39;.dta&#34;, replace  
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>多对多（基础表格）匹配时：此时使用 <code>merge</code> 不再合适，推荐 <code>joinby</code></p>
<p>详细可参考 <a href="https://mp.weixin.qq.com/s/bTFFvihL221zM2MYaGZcuA" target="_blank" rel="noopener noreffer ">Stata命令：joinby VS merge m:m常见问题</a></p>
<h3 id="循环匹配命令">循环匹配命令</h3>
<p>当我们写循环匹配命令时，数字可能是间断点，例如 data 1、data 3、data 5、data 7&hellip;</p>
<p>可以选择使用 python 直接更改文件名字按顺序排序，但容易破坏命名含义。</p>
<p>这里提供个人写的 stata 自然数循环命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> * 定义排除列表  
</span></span><span class="line"><span class="cl"> global exclude_list 22 50 54 58  105  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 初始化 valid_files 变量  
</span></span><span class="line"><span class="cl"> global valid_files  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 循环遍历文件编号范围，并检查是否在排除列表中  
</span></span><span class="line"><span class="cl"> forvalues i = 1/119 {  
</span></span><span class="line"><span class="cl">     local is_excluded 0  
</span></span><span class="line"><span class="cl">     foreach excl in $exclude_list {  
</span></span><span class="line"><span class="cl">         if `i&#39; == `excl&#39; {  
</span></span><span class="line"><span class="cl">             local is_excluded 1  
</span></span><span class="line"><span class="cl">             break  
</span></span><span class="line"><span class="cl">         }  
</span></span><span class="line"><span class="cl">     }  
</span></span><span class="line"><span class="cl">     if !`is_excluded&#39; {  
</span></span><span class="line"><span class="cl">         global valid_files $valid_files `i&#39;  
</span></span><span class="line"><span class="cl">     }  
</span></span><span class="line"><span class="cl"> }  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 显示有效的文件编号  
</span></span><span class="line"><span class="cl"> display &#34;Valid file numbers: $valid_files&#34;  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 循环处理有效的文件编号  
</span></span><span class="line"><span class="cl"> foreach i of global valid_files {  
</span></span><span class="line"><span class="cl">     *写入自己的循环匹配代码  
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="匹配速度的优化">匹配速度的优化</h3>
<p>正常匹配，应该是将 119 个 txt 转化的 dta 匹配，嵌套循环匹配到 ans 1-ans 83 上去。</p>
<p>如果直接嵌套循环匹配，可能需要 4 到 5 天。</p>
<p>匹配耗时过长的原因在于每一次嵌套循环的文件读取时间太长了，而且不同文件之间有重复值。</p>
<p>建议先将 119 个 dta 文件使用 <code>append</code> 命令纵向匹配到一起，然后循环匹配到 ans 1 到 ans 83 上去，这样最多只需要 2 天即可完成全部匹配。
​</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #7d637a; background-color: #f6edf5; border-color: #f1e4f0;">
&#x1F4AC<b> 备注：办公室电脑是 stata MP 版本，这个版本的特性是“计算速度根据电脑的核来分配资源”。目前 cpu 有足足 16 核，个人处理过的最大量峰值是 60 g。基本没有问题，只需要耐心等待处理过程中的卡顿。</b>
</div>
<h2 id="dta-数据的清洗">dta 数据的清洗</h2>
<h3 id="常用文本处理函数">常用文本处理函数</h3>
<h4 id="去除空格">去除空格</h4>
<p>例如裁判长（法官）变量，会出现以下情况 <code>四川 大学</code>， <code>四川大学</code>，<code>四 川 大 学</code>。</p>
<p>不同网站的空格符号并不相同，建议使用以下函数：</p>
<p> * 移除所有特殊字符，包括不可见字符、空白和标点符号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> replace judge_fin = ustrregexra(法官名字变量, &#34;[^\p{L}\p{N}]+&#34;, &#34;&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="筛选特定字符">筛选特定字符</h4>
<p>如果变量中含有特定字符则保留</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">keep</span> <span class="k">if</span> <span class="n">strpos</span><span class="p">(</span><span class="k">var</span><span class="p">,</span> <span class="s2">&#34;民初&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="去除特殊字符">去除特殊字符</h4>
<p>Ans 1 到 ans 83 的文本变量夹杂着各种非中文符号，可以使用以下函数去除：</p>
<p>以下是个人筛选出的乱码符号。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #7d637a; background-color: #f6edf5; border-color: #f1e4f0;">
&#x1F4AC<b> 备注：为什么要坚持排除法，而不选择只保留中文字符？ 因为个人尝试时，发现部分中文变量会因此变成乱码。</b>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 定义需要移除的符号列表（包括空格）  
</span></span><span class="line"><span class="cl">local symbols &#34;ⅩⅩⅩ Ｘ ? ; ；， 《 》 ． ＋ （ ） ( ) &amp; # 1 2 3 4 5 6 7 8 9 0 &amp; A-Z a-z ；？ ＊ ︰ ++  .   XX XXX   ______   ` - +  BRR H imestimes jzwjzwnjzwnjzwjzwnjzwnjzwnjzwjzwjzwjzwnjzwnjzwnjzwjzwnjzwnj jzwnjzwjzwjzwnjzwnjzwnjzwnjzwnjzwjzwjzwjzwnjzwjzwnjzwjzwj spemsp sp emsp ；； *  XX XXX Ｘ ＸＸＸ&#34;  
</span></span><span class="line"><span class="cl">​  
</span></span><span class="line"><span class="cl">* 遍历符号列表并移除每个符号及空格  
</span></span><span class="line"><span class="cl">foreach s of local symbols {  
</span></span><span class="line"><span class="cl">    replace judge_fin = subinstr(judge_fin, &#34;`s&#39;&#34;, &#34;&#34;, .)  
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="正则表达式提取">正则表达式提取</h3>
<h4 id="字符筛选">字符筛选</h4>
<p>以裁判长文本变量为例子，</p>
<p>明明变量应该是一个名字，结果出现了一个段落</p>
<blockquote>
<p>张三人民委托、张三于 2014 年进行审判、张三人民审判员进行裁决、张三代理裁判长进行庭审、张三李四熟记员进行开庭&hellip;&hellip;</p>
</blockquote>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp" title="再举例子——法院变量" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210847789.webp" data-sub-html="<h2> </h2><p>再举例子——法院变量</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210847789.webp" />
    </a><figcaption class="image-caption">再举例子——法院变量</figcaption>
    </figure>
换而言之，正确的文本字符应该是特定词汇的前面几个字。</p>
<p>先使用字符长度筛选例子，查看文本格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="o">*</span><span class="err">列出字符长度大于</span><span class="mi">14</span><span class="err">的变量行</span>  
</span></span><span class="line"><span class="cl"> <span class="n">list</span> <span class="k">var</span> <span class="k">if</span> <span class="n">ustrlen</span><span class="p">(</span><span class="n">judge_fin</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">14</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后根据情况<strong>只保留特定字符</strong>。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #a94442; background-color: #f2dede; border-color: #ebccd1;">
&#x26D4<b> 警告：注意顺序！</b>
</div>
<blockquote>
<p>例如有以下组合</p>
<p>张三<strong>于</strong> 2014 年进行庭审</p>
<p>张三<strong>代理</strong>审判长<strong>于</strong> 2014 年进行庭审</p>
<p>在该变量包含&quot;庭审&quot;两个字时，我们应该先都保留“于”以前的字符，再保留&quot;代理&quot;以前的字符。</p>
<p>条件筛选最好找两个字的特征词，这样叫“于庭审”的法官名字几乎不可能出现。</p>
</blockquote>
<p>个人使用的顺序，仅供参考：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;人民陪审员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;人民陪审员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;审判员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;审判员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;独任.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;独任&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;陪审员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;陪审员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;代理.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;代理&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;书记员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;书记员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;助理.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;助理&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;审判长.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;审判长&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;人民.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;人民&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;二.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;年&#34;) &gt; 0   
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;适用.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;适用&#34;) &gt; 0   
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;于.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;开庭&#34;) &gt; 0   
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;对.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;审理&#34;) &gt; 0 
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于爬虫有时候遇上网站加密，爬虫结果是 <code>陈*</code>,，完成以上清洗后只剩下 <code>陈</code>，删除单个字符行的函数命令是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> *删除只有一个字的，例如本来是*陈  
</span></span><span class="line"><span class="cl"> drop if ustrregexm(judge_fin, &#34;^[\p{Han}]$&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="数字提取">数字提取</h4>
<p>例如数据显示 <code>2.34435元</code>（需要是字符串变量），我们只想单独提取数字，可以使用以下代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">gen</span> <span class="n">num_var</span> <span class="o">=</span> <span class="o">.</span>  
</span></span><span class="line"><span class="cl"> <span class="n">replace</span> <span class="n">num_var</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">regexs</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">regexm</span><span class="p">(</span><span class="n">str_var</span><span class="p">,</span> <span class="s2">&#34;([0-9]+\.[0-9]+|[0-9]+)&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>顺便一提，如果没有 <code>real(regexs(1))</code> 这个参数则表示判断，只会返回 0 和 1，代表不符合或者符合格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">replace</span> <span class="n">num_var</span> <span class="o">=</span>  <span class="n">regexm</span><span class="p">(</span><span class="n">str_var</span><span class="p">,</span> <span class="s2">&#34;([0-9]+\.[0-9]+|[0-9]+)&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dta-时间修正">dta 时间修正</h2>
<p>在师门的招投标中，很多时间格式是混乱的。</p>
<p>例如标准的两种：
<code>2019-12-31 09:00:00</code>、
<code> 2019/12/30 09:30</code></p>
<p>但是也会出现 <code>20220516 09:30:00</code>、<code>2022051609:30:00</code>、<code>2022051609:30</code></p>
<p>例如缺少秒、月份位置写成 4 而不是 04。</p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250123143246038.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250123143246038.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure></p>
<p>下面的代码集中处理了这套时间编码。</p>
<p>一些中文符号转英文的预处理。</p>
<p>在日期和时间之间没有空格时（例如 <code>2022051609:30:00</code>），如果范围在对应年月内（比如 0-31）则优先取两位数，超过范围了则取前面的个位数。</p>
<p>最后兼容各种格式的时间提取。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*-----------------------------------------
</span></span><span class="line"><span class="cl">  日期提取转换方案（紧凑格式增强版）
</span></span><span class="line"><span class="cl">  版本：2.6
</span></span><span class="line"><span class="cl">  最后更新：2024-06-27
</span></span><span class="line"><span class="cl">-----------------------------------------*/
</span></span><span class="line"><span class="cl">version 17
</span></span><span class="line"><span class="cl">clear all
</span></span><span class="line"><span class="cl">set more off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">use &#34;F:\桌面\test.dta&#34;, clear
</span></span><span class="line"><span class="cl">keep time
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*        预处理阶段（增强）
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">// 基础清理
</span></span><span class="line"><span class="cl">replace time = ustrtrim(time)
</span></span><span class="line"><span class="cl">replace time = subinstr(time, char(92), &#34;-&#34;, .)
</span></span><span class="line"><span class="cl">replace time = subinstr(time, &#34;：&#34;, &#34;:&#34;, .) 
</span></span><span class="line"><span class="cl">replace time = subinstr(time, &#34; &#34;, &#34;&#34;, .)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      新增紧凑格式识别模块
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">// 识别YYYYMMDD-格式（核心改进）
</span></span><span class="line"><span class="cl">gen str8 compact_date = &#34;&#34;
</span></span><span class="line"><span class="cl">replace compact_date = substr(time, 1, 8) ///
</span></span><span class="line"><span class="cl">    if ustrregexm(time, &#34;^\d{8}-&#34;)  // 严格匹配8位数字+连字符格式
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 分离紧凑格式数据
</span></span><span class="line"><span class="cl">preserve
</span></span><span class="line"><span class="cl">keep if compact_date != &#34;&#34;
</span></span><span class="line"><span class="cl">gen date_stata = date(compact_date, &#34;YMD&#34;)
</span></span><span class="line"><span class="cl">format date_stata %tdCCYY-NN-DD
</span></span><span class="line"><span class="cl">tempfile compact
</span></span><span class="line"><span class="cl">save `compact&#39;
</span></span><span class="line"><span class="cl">restore
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 处理非紧凑格式数据
</span></span><span class="line"><span class="cl">keep if compact_date == &#34;&#34;
</span></span><span class="line"><span class="cl">drop compact_date
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      原有处理流程（优化）
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">// 统一分隔符处理
</span></span><span class="line"><span class="cl">foreach s in &#34;.&#34; &#34;_&#34; &#34;/&#34; {
</span></span><span class="line"><span class="cl">    replace time = subinstr(time, &#34;`s&#39;&#34;, &#34;-&#34;, .)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 日期部分提取
</span></span><span class="line"><span class="cl">gen str50 date_part = ustrregexs(1) if ustrregexm(time, &#34;(\d{4}-\d{1,2}-\d{2,})[^\d]&#34;)
</span></span><span class="line"><span class="cl">replace date_part = time if missing(date_part)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 智能日期处理
</span></span><span class="line"><span class="cl">gen str4 year = ustrregexs(1) if ustrregexm(date_part, &#34;^(\d{4})-\d+&#34;)
</span></span><span class="line"><span class="cl">gen str2 month = ustrregexs(1) if ustrregexm(date_part, &#34;-(\d{1,2})-&#34;)
</span></span><span class="line"><span class="cl">gen str5 raw_day = ustrregexs(1) if ustrregexm(date_part, &#34;-(\d+)$&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">replace month = cond(strlen(month) == 1, &#34;0&#34; + month, month)
</span></span><span class="line"><span class="cl">replace month = &#34;12&#34; if real(month) &gt; 12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gen str2 day = substr(raw_day,1,2)
</span></span><span class="line"><span class="cl">replace day = substr(day,1,1) if real(day) &gt; 31
</span></span><span class="line"><span class="cl">replace day = &#34;31&#34; if real(day) &gt; 31
</span></span><span class="line"><span class="cl">replace day = &#34;0&#34; + day if real(day) &lt; 10 &amp; strlen(day) == 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">replace date_part = year + &#34;-&#34; + month + &#34;-&#34; + day
</span></span><span class="line"><span class="cl">drop year month raw_day day
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gen date_stata = date(date_part, &#34;YMD&#34;)
</span></span><span class="line"><span class="cl">replace date_stata = date(ustrregexra(time, &#34;[^0-9]&#34;, &#34;&#34;), &#34;YMD&#34;) if missing(date_stata)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      合并处理结果
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">append using `compact&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      后处理与验证
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">format date_stata %tdCCYY-NN-DD
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="例子3-python-跨行匹配">例子3 ：python 跨行匹配</h2>
<h3 id="任务与思路">任务与思路</h3>
<p>这里，我需要完成以下工作：</p>
<p><strong>裁判文书是一个案件截面数据，这里试图还原为法官追踪数据。</strong></p>
<p>也就是基于时间，将一个法官审判的下一个案子特征，和他\她审理的下一个案件匹配到一起。</p>
<p>由于我需要精准定位到<strong>下一个</strong>案件，而 stata 的匹配并没有筛选功能，此时只能通过 python 操作。</p>
<blockquote>
<p>跨行处理是 stata 的最大短板。</p>
</blockquote>
<p>思路很简单，</p>
<p>生成空白变量，</p>
<p>按照<code>法院-法官</code>分组，提取案件时间戳；</p>
<p>（因此不能用分块读取优化速度，可能把同一组的数据块分割了）</p>
<p>在每个组别内部选取最近的时间戳进行赋值；</p>
<p>因为裁判文书只有月份，如果一个月有很多案子，这里我进行了随机分配。</p>
<h3 id="代码">代码</h3>
<p>以下做的唯一优化是提前设置数据格式。</p>
<p>在 stata 中 <code>describe</code> 命令一下，然后导出的 CSV 处理即可直接使用。</p>
<p>未来想要优化可以考虑平行处理，向量化运算。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 指定文件路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">file_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:\桌面\pluck样本.csv&#39;</span>  <span class="c1"># 注意这里改成了 .csv  </span>
</span></span><span class="line"><span class="cl"> <span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:\桌面\pluck样本结果.csv&#39;</span>   <span class="c1"># 输出文件也改成 .csv  </span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 根据 Stata 文件中定义的数据类型，创建 dtype 字典，并允许整数列包含 NA 值  </span>
</span></span><span class="line"><span class="cl"> <span class="n">dtype_dict</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;jud_year&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>  <span class="c1"># 注意大写的 I  </span>
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;jud_month&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;court&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;case_prov&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;case_city&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;counter_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;second_appeal&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;rehear&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;re_appeal&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;protest&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;claim_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;first_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;second_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;re_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;judge_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;first_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;second_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;re_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;pla_num&#39;</span><span class="p">:</span> <span class="s1">&#39;Int32&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;def_num&#39;</span><span class="p">:</span> <span class="s1">&#39;Int32&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;case_wid_str&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m_sorted_1&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m_sorted_2&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m_sorted_3&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m_sorted_4&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;count_tiao&#39;</span><span class="p">:</span> <span class="s1">&#39;Int32&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;total_chars&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;clause_count&#39;</span><span class="p">:</span> <span class="s1">&#39;Int32&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m1_jud_year&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m1_jud_month&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m1_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m1_judge_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m2_jud_year&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m2_jud_month&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m2_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m2_judge_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m2_m_sorted_1&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m3_jud_year&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m3_jud_month&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m3_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m3_judge_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m4_jud_year&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m4_jud_month&#39;</span><span class="p">:</span> <span class="s1">&#39;Int8&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m4_win&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;m4_judge_am&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;judge_fin&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;court_name&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;cumulative_co~t&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;work_experien~s&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;combo_count&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="p">}</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 尝试使用 utf-8 编码读取文件，并跳过有问题的行  </span>
</span></span><span class="line"><span class="cl">     <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s1">&#39;skip&#39;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">                        <span class="n">encoding_errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype_dict</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;文件成功加载（使用 UTF-8 编码，并跳过有问题的行）。&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;读取文件时发生错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">raise</span>  <span class="c1"># 抛出异常以停止程序执行，除非有进一步处理  </span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 初始化新列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>  
</span></span><span class="line"><span class="cl"> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y_case_wid_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>  
</span></span><span class="line"><span class="cl"> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义所有时间列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">time_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">,</span> <span class="s1">&#39;m1_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m1_jud_month&#39;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">                 <span class="s1">&#39;m2_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m2_jud_month&#39;</span><span class="p">,</span> <span class="s1">&#39;m3_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m3_jud_month&#39;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">                 <span class="s1">&#39;m4_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m4_jud_month&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取最晚上诉时间  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">get_latest_appeal_time</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">times</span> <span class="o">=</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>   
</span></span><span class="line"><span class="cl">         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_columns</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>  
</span></span><span class="line"><span class="cl">     <span class="p">]</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">if</span> <span class="n">times</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 创建每行的最晚上诉时间列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;latest_appeal_year&#39;</span><span class="p">,</span> <span class="s1">&#39;latest_appeal_month&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">     <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_latest_appeal_time</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 按法院、法官和时间排序  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 分组处理  </span>
</span></span><span class="line"><span class="cl"> <span class="n">grouped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_data</span><span class="p">)):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">current_case</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">         <span class="n">latest_appeal_year</span><span class="p">,</span> <span class="n">latest_appeal_month</span> <span class="o">=</span> <span class="n">current_case</span><span class="p">[</span><span class="s1">&#39;latest_appeal_year&#39;</span><span class="p">],</span> <span class="n">current_case</span><span class="p">[</span><span class="s1">&#39;latest_appeal_month&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 跳过无有效时间的情况  </span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">latest_appeal_year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">latest_appeal_month</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">continue</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 筛选下一个案件：年份大于或（年份相等且月份大于）  </span>
</span></span><span class="line"><span class="cl">         <span class="n">potential_next_cases</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>  
</span></span><span class="line"><span class="cl">         <span class="n">potential_next_cases</span> <span class="o">=</span> <span class="n">potential_next_cases</span><span class="p">[</span>  
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="n">potential_next_cases</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest_appeal_year</span><span class="p">)</span> <span class="o">|</span>  
</span></span><span class="line"><span class="cl">             <span class="p">((</span><span class="n">potential_next_cases</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">latest_appeal_year</span><span class="p">)</span> <span class="o">&amp;</span>   
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="n">potential_next_cases</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest_appeal_month</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">         <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="ow">not</span> <span class="n">potential_next_cases</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="c1"># 选择最早的一个案件，如果存在多个相同日期的案件，则随机选择一个  </span>
</span></span><span class="line"><span class="cl">             <span class="n">earliest_cases</span> <span class="o">=</span> <span class="n">potential_next_cases</span><span class="p">[</span>  
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="n">potential_next_cases</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">potential_next_cases</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;jud_year&#39;</span><span class="p">])</span> <span class="o">&amp;</span>  
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="n">potential_next_cases</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">potential_next_cases</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;jud_month&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">             <span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="ow">not</span> <span class="n">earliest_cases</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">selected_case</span> <span class="o">=</span> <span class="n">earliest_cases</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">current_case</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;y_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_case</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">current_case</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;y_case_wid_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_case</span><span class="p">[</span><span class="s1">&#39;case_wid_str&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">current_case</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;y_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_case</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 删除临时列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latest_appeal_year&#39;</span><span class="p">,</span> <span class="s1">&#39;latest_appeal_month&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 保存结果到新文件  </span>
</span></span><span class="line"><span class="cl"> <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>  <span class="c1"># 修改为逗号分隔  </span>
</span></span><span class="line"><span class="cl">     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;处理完成，结果已保存至: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;保存文件时发生错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="提醒">提醒</h3>
<p>建议先将 stata 数据导出为 csv 格式。</p>
<p>最大的问题是<strong>乱码</strong>。</p>
<p>
<figure><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113211041112.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113211041112.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure>
csv 乱码了。因为提取的 txt 不是 utf 8 格式。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #8a6d3b;; background-color: #fcf8e3; border-color: #faebcc;">
&#x1F628<b> 注意：一定要保证CSV 文件默认格式刷 UTF-8 ，然后进行处理。</b>
</div>
<h2 id="例子-4-python-提取上诉法官过去和现在的特征均值">例子 4 ：python 提取上诉法官过去和现在的特征均值</h2>
<p>例子 3 是逐行匹配，但是这样处理实在是太慢了。</p>
<p>现在我想要这样处理：</p>
<p>提取法官经历上诉前的 20 个案子，然后求罚款均值；同时提取法官经历上诉后的 20 个案子，然后求罚款的均值。</p>
<p>个人设计的算法逻辑如下：</p>
<ul>
<li>按照法院-法官的组合对数据进行分组。</li>
<li>每个数据都有初审到终审的时间，形成时间戳，并且每一行应该识别一系列时间中的最早时间和最晚时间。</li>
<li>当最早时间不等于最晚时间时，这条数据就是主干数据。</li>
<li>在每个组别内，只保留满足条件的样本。</li>
<li>在主干数据周围，当在主干数据最早数据之前还有 10 个案子，在主干数据之后也还有 10 个案子，最终只保留这 21 条数据。</li>
<li>如果一个组别同时有多个案子，则都保留满足要求的样本。</li>
<li>给满足周围存在对应数量案子的主干数据生成变量 a，标识为 1。</li>
<li>生成上诉前变量和上诉后变量，求数量对应案子的均值。</li>
</ul>
<div class="details admonition note">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>分解代码<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">为了更好地利用 ai，实际上这个算法我是拆成了两步。第一部分是筛选满足要求的所有样本；第二部是在满足要求的主干数据（a=1）处计算前后案件的均值。最周再整合两部分的代码。</div>
        </div>
    </div>
<p>我最终多设置了一个参数，关于主干案件周围需要有多少案子才保留。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 时间字段</span>
</span></span><span class="line"><span class="cl"><span class="n">time_columns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m1_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m1_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m2_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m2_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m3_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m3_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m4_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m4_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_timestamps</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;提取一行数据中的所有时间戳&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_columns</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">year</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="n">month</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">month</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">timestamps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_main_cases</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;筛选主干数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_cases</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">extract_timestamps</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">min_time</span> <span class="o">!=</span> <span class="n">max_time</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">main_cases</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span><span class="p">))</span>  <span class="c1"># 保存索引和时间范围</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">main_cases</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">before_n</span><span class="p">,</span> <span class="n">after_n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;处理每组数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_cases</span> <span class="o">=</span> <span class="n">get_main_cases</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">main_cases</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>  <span class="c1"># 如果没有主干数据，返回空</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">case_idx</span><span class="p">,</span> <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span> <span class="ow">in</span> <span class="n">main_cases</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 统计早于和晚于主干数据时间范围的记录</span>
</span></span><span class="line"><span class="cl">        <span class="n">before_condition</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">after_condition</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">before_records</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">before_condition</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">before_n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">after_records</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">after_condition</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">after_n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否满足条件</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">before_records</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">before_n</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">after_records</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">after_n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 标记主干数据</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">case_idx</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 标记为主干</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 保留主干数据及其前后样本</span>
</span></span><span class="line"><span class="cl">            <span class="n">main_record</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">case_idx</span><span class="p">]]</span>  <span class="c1"># 主干数据</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">before_records</span><span class="p">,</span> <span class="n">main_record</span><span class="p">,</span> <span class="n">after_records</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_means</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">main_cases</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;计算前后均值&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">main_row</span> <span class="ow">in</span> <span class="n">main_cases</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 主干数据的时间</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_year</span> <span class="o">=</span> <span class="n">main_row</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_month</span> <span class="o">=</span> <span class="n">main_row</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算之前的均值</span>
</span></span><span class="line"><span class="cl">        <span class="n">before_condition</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">main_year</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">main_year</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">main_month</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">bf_judge_am</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">before_condition</span><span class="p">,</span> <span class="s1">&#39;judge_am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算之后的均值</span>
</span></span><span class="line"><span class="cl">        <span class="n">after_condition</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">main_year</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">main_year</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">main_month</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">af_judge_am</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">after_condition</span><span class="p">,</span> <span class="s1">&#39;judge_am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 更新主干数据行</span>
</span></span><span class="line"><span class="cl">        <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;bf_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bf_judge_am</span>
</span></span><span class="line"><span class="cl">        <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;af_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">af_judge_am</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 主程序</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 加载数据</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;成功加载数据，总记录数：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;数据加载失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 添加 &#39;a&#39; 列，初始化为 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bf_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;af_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 分组处理</span>
</span></span><span class="line"><span class="cl">    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;处理进度&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">processed</span> <span class="o">=</span> <span class="n">process_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">before_n</span><span class="p">,</span> <span class="n">after_n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">processed</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 筛选标记为主干的数据</span>
</span></span><span class="line"><span class="cl">                <span class="n">main_cases</span> <span class="o">=</span> <span class="n">processed</span><span class="p">[</span><span class="n">processed</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 计算均值</span>
</span></span><span class="line"><span class="cl">                <span class="n">processed</span> <span class="o">=</span> <span class="n">calculate_means</span><span class="p">(</span><span class="n">processed</span><span class="p">,</span> <span class="n">main_cases</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 保存结果</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">结果已保存至：</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">警告：没有符合条件的记录&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 参数配置（移到最后）</span>
</span></span><span class="line"><span class="cl">    <span class="n">input_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:\桌面\测试.csv&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:\桌面\测试_结果.csv&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_n</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># 保留之前记录的条数</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_n</span> <span class="o">=</span> <span class="mi">20</span>   <span class="c1"># 保留之后记录的条数</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>以上代码如果不是在 jupyter 环境中运行而是在 pycharm 环境中运行，需要调整下输入参数的位置。</p>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2025-01-13</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/zh-cn/posts/cpws_stata/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南" data-hashtags="Stata,Python"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-hashtag="Stata"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南" data-image="/img/裁判文书清洗指南.zh-cn-20250113205250946.webp"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/zh-cn/tags/stata/">Stata</a>,&nbsp;<a href="/zh-cn/tags/python/">Python</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/zh-cn/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/zh-cn/posts/econ_math/" class="prev" rel="prev" title="经济学的数学史"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>经济学的数学史</a>
            <a href="/zh-cn/posts/fzqy/" class="next" rel="next" title="《富种起源》：千年暗室，一灯即明">《富种起源》：千年暗室，一灯即明<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app">Giscus</a>.
            </noscript></div></article></div>
            </main><script>
document.addEventListener('pjax:end', function() {
  document.querySelectorAll('meting-js').forEach(el => new Meting(el));
});
</script>



    
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-line">
                <span id="run-time" data-i18n="runtime"></span>
            </div><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.122.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreferrer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div>

            <div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/hzp2333/hzp2333.github.io" target="_blank">滑翔闪</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
            </div>

            <style>
                .footerImg {
                    height: 20px;
                }
            </style>
            <div class="footer-line custom">
                <a href="https://icp.gov.moe/?keyword=20244204" target="_blank">萌ICP备20244204号</a>
                <a style="text-decoration:none;color:#55bb8a;" href="https://travel.moe/go.html" title="异次元之旅-跃迁-我们一起去萌站成员的星球旅行吧！" target="_blank">
                    <img src="https://travel.moe/images/icon/icon64green.png" style="width:24px;height:24px" alt="异次元之旅">异次元之旅
                </a>
            </div>

            <div class="footer-line custom">
                <a href="https://www.travellings.cn/go.html" target="_blank">
                    <img src="https://www.travellings.cn/assets/logo.gif" class="footerImg" alt="开往-友链接力 v1.5" title="开往-友链接力 v1.5">
                </a>
                <a href="https://www.foreverblog.cn/" target="_blank">
                    <img src="https://img.foreverblog.cn/logo_en_default.png" class="footerImg" alt="Forever Blog">
                </a>
                <a href="https://www.foreverblog.cn/go.html" target="_blank">
                    <img src="https://img.foreverblog.cn/wormhole_2.gif" class="footerImg" alt="穿梭虫洞-随机访问十年之约友链博客" title="穿梭虫洞-随机访问十年之约友链博客">
                </a>
            </div>
    
        
        <script async src=" //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js "></script>
    

    
        
            <section>
                
                    <span id="busuanzi_container_value_site_pv"><i class="far fa-eye fa-fw"></i>
                        
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                

                
                    &nbsp;|&nbsp;              
                

                
                    <span id="busuanzi_container_value_site_uv"><i class="fa fa-user"></i>
                        
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
            </section>
        

        
        
    

</div>
    </footer>
 

    
    <script src="https://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js" 
        data-color="0,0,0" 
        data-count="150" 
        data-zIndex="-1">
    </script>
</body>
</html>



</div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"giscus":{"category":"Announcements","categoryId":"DIC_kwDOLbBjxM4Cdr0n","darkTheme":"dark_dimmed","emitMetadata":"0","inputPosition":"bottom","lang":"zh-CN","lazyLoading":false,"lightTheme":"light","mapping":"pathname","reactionsEnabled":"1","repo":"hzp2333/Giscus","repoId":"R_kgDOLbBjxA"}},"data":{"id-1":"滑翔闪'S BLOG","id-2":"滑翔闪'S BLOG"},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/zh-cn/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js"></script><script type="text/javascript" src="/js/custom.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-CYZVM6VVZ8', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-CYZVM6VVZ8" async></script></body>
</html>
