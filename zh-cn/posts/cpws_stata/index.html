<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>裁判文书清洗指南 - 滑翔闪&#39;S BLOG</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="裁判文书清洗指南" />
<meta property="og:description" content="裁判文书清洗指南" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-01-13T18:52:19+08:00" />
<meta property="article:modified_time" content="2025-01-13T20:50:49+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="裁判文书清洗指南"/>
<meta name="twitter:description" content="裁判文书清洗指南"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" /><link rel="prev" href="https://blog.huaxiangshan.com/zh-cn/posts/econ_math/" /><link rel="next" href="https://blog.huaxiangshan.com/zh-cn/posts/fzqy/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "裁判文书清洗指南",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.huaxiangshan.com\/zh-cn\/posts\/cpws_stata\/"
        },"genre": "posts","keywords": "Stata, Python","wordcount":  21920 ,
        "url": "https:\/\/blog.huaxiangshan.com\/zh-cn\/posts\/cpws_stata\/","datePublished": "2025-01-13T18:52:19+08:00","dateModified": "2025-01-13T20:50:49+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "滑翔闪"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper">












<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sakana 小组件集成</title>
  <style>
     
    #sakana-widget-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 268px;
      height: 268px;
    }
    #sakana-widget {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="sakana-widget-container">
    <div id="sakana-widget"></div>
  </div>

  <script>
    function initSakanaWidget() {
      new SakanaWidget({
        size: 300,
        autoFit: true,
        character: 'chisato',
        controls: true,
        rod: true,
        draggable: true,
        stroke: { color: '#b4b4b4', width: 10 },
        threshold: 0.1,
        rotate: 0,
        title: false
      }).mount('#sakana-widget');

      
      checkScreenWidth();
      window.addEventListener('resize', checkScreenWidth);
    }

    function checkScreenWidth() {
      var screenWidth = window.innerWidth;
      var container = document.getElementById('sakana-widget-container');
      if (screenWidth <= 960) {
        container.style.display = 'none';
      } else {
        container.style.display = 'block';
      }
    }
  </script>

  
  <script 
    async
    onload="initSakanaWidget()"
    src="https://cdn.jsdelivr.net/npm/sakana-widget@2.2.2/lib/sakana.min.js">
  </script>
</body>
</html>




<script type="text/javascript" color="0,174,255" opacity='0.7' zIndex="-2" count="200" src="https://www.liuzehe.top/upload/bkjs/bj.js"></script><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/zh-cn/" title="滑翔闪&#39;S BLOG"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/%E7%9F%9B%E7%9B%BE.png"
        data-srcset="/images/%E7%9F%9B%E7%9B%BE.png, /images/%E7%9F%9B%E7%9B%BE.png 1.5x, /images/%E7%9F%9B%E7%9B%BE.png 2x"
        data-sizes="auto"
        alt="/images/%E7%9F%9B%E7%9B%BE.png"
        title="/images/%E7%9F%9B%E7%9B%BE.png" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/zh-cn/posts/" title="书中自有黄金屋"><i class='fa fa-solid fa-book'></i> 文章 </a><a class="menu-item" href="/zh-cn/tags/" title="定义文章，不定义世界"><i class='fa fa-tag'></i> 标签 </a><a class="menu-item" href="/zh-cn/categories/" title="分类是种视角"><i class='fa fa-archive'></i> 分类 </a><a class="menu-item" href="/zh-cn/friends/" title="有朋自远方来"><i class='fa fa-user-group'></i> 友链  </a><a class="menu-item" href="/zh-cn/about/" title="人穷其一生寻找自己"> <i class='fa fa-address-card'></i> 关于 </a><a class="menu-item" href="https://www.travellings.cn/go.html" title="漫长的列车驶向未来" rel="noopener noreffer" target="_blank"><i class='fa fa-train-subway'></i> 开往  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="吾将上下而求索" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="选择语言">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/zh-cn/posts/cpws_stata/" selected>简体中文</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/zh-cn/" title="滑翔闪&#39;S BLOG"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/%E7%9F%9B%E7%9B%BE.png"
        data-srcset="/images/%E7%9F%9B%E7%9B%BE.png, /images/%E7%9F%9B%E7%9B%BE.png 1.5x, /images/%E7%9F%9B%E7%9B%BE.png 2x"
        data-sizes="auto"
        alt="/images/%E7%9F%9B%E7%9B%BE.png"
        title="/images/%E7%9F%9B%E7%9B%BE.png" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="吾将上下而求索" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/zh-cn/posts/" title="书中自有黄金屋"><i class='fa fa-solid fa-book'></i>文章</a><a class="menu-item" href="/zh-cn/tags/" title="定义文章，不定义世界"><i class='fa fa-tag'></i>标签</a><a class="menu-item" href="/zh-cn/categories/" title="分类是种视角"><i class='fa fa-archive'></i>分类</a><a class="menu-item" href="/zh-cn/friends/" title="有朋自远方来"><i class='fa fa-user-group'></i>友链 </a><a class="menu-item" href="/zh-cn/about/" title="人穷其一生寻找自己"> <i class='fa fa-address-card'></i>关于</a><a class="menu-item" href="https://www.travellings.cn/go.html" title="漫长的列车驶向未来" rel="noopener noreffer" target="_blank"><i class='fa fa-train-subway'></i>开往 </a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/zh-cn/posts/cpws_stata/" selected>简体中文</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><script>
			(function(){
				if( 1450169683 ){
					if (prompt('请输入文章密码') !=  1450169683 ){
						alert('密码错误！');
						if (history.length === 1) {
							window.opener = null;
							window.open('', '_self');
							window.close();
						} else {
							history.back();
						}
					}
				}
			})();
		</script><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">裁判文书清洗指南</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/hzp2333/hzp2333.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>滑翔闪</a></span>&nbsp;<span class="post-category">收录于 <a href="/zh-cn/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%B9%A0/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>经济学习</a></span></div>

            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-01-13">2025-01-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 21920 字
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 44 分钟&nbsp;
    

    
        

        
        
            <span id="busuanzi_container_value_page_pv"><i class="far fa-eye fa-fw"></i>
                
                <span id="busuanzi_value_page_pv"></span>&nbsp;次阅读</span>
        
    


</div>

        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp"
        data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205250946.webp 2x"
        data-sizes="auto"
        alt="/img/裁判文书清洗指南.zh-cn-20250113205250946.webp"
        title="/img/裁判文书清洗指南.zh-cn-20250113205250946.webp" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#关于裁判文书的网站">关于裁判文书的网站</a></li>
    <li><a href="#裁判文书资源">裁判文书资源</a></li>
    <li><a href="#txt-文件的处理">txt 文件的处理</a>
      <ul>
        <li><a href="#一些建议">一些建议</a></li>
        <li><a href="#乱码文档">乱码文档</a></li>
      </ul>
    </li>
    <li><a href="#python-例子-提取案件号序列">Python 例子 ：提取案件号序列</a>
      <ul>
        <li><a href="#思路">思路</a></li>
        <li><a href="#单个-txt-的处理">单个 txt 的处理</a></li>
        <li><a href="#批量处理">批量处理</a></li>
      </ul>
    </li>
    <li><a href="#python-例子-提取法条和移动文件夹">Python 例子 ：提取法条和移动文件夹</a>
      <ul>
        <li><a href="#多个-txt">多个 txt</a></li>
        <li><a href="#移动-txt">移动 txt</a></li>
      </ul>
    </li>
    <li><a href="#例子--裁判文书索引重新排序">例子 ： 裁判文书索引重新排序</a></li>
    <li><a href="#dta-数据的匹配">dta 数据的匹配</a>
      <ul>
        <li><a href="#关于案号">关于案号</a></li>
        <li><a href="#标识的去重">标识的去重</a></li>
        <li><a href="#索引值的去重">索引值的去重</a></li>
        <li><a href="#文本匹配标识的格式转化">文本匹配标识的格式转化</a></li>
        <li><a href="#匹配命令的选择">匹配命令的选择</a></li>
        <li><a href="#循环匹配命令">循环匹配命令</a></li>
        <li><a href="#匹配速度的优化">匹配速度的优化</a></li>
      </ul>
    </li>
    <li><a href="#dta-数据的清洗">dta 数据的清洗</a>
      <ul>
        <li><a href="#常用文本处理函数">常用文本处理函数</a>
          <ul>
            <li><a href="#去除空格">去除空格</a></li>
            <li><a href="#筛选特定字符">筛选特定字符</a></li>
            <li><a href="#去除特殊字符">去除特殊字符</a></li>
            <li><a href="#论文标签">论文标签</a></li>
          </ul>
        </li>
        <li><a href="#正则表达式提取">正则表达式提取</a>
          <ul>
            <li><a href="#字符筛选">字符筛选</a></li>
            <li><a href="#数字提取">数字提取</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#dta-时间修正">dta 时间修正</a>
      <ul>
        <li><a href="#提醒">提醒</a></li>
      </ul>
    </li>
    <li><a href="#python-例子--提取上诉法官过去和现在的特征均值">Python 例子 ： 提取上诉法官过去和现在的特征均值</a></li>
    <li><a href="#一些可以快速得到的裁判文书变量">一些可以快速得到的裁判文书变量</a></li>
    <li><a href="#python-例子-案件积压量">Python 例子 ：案件积压量</a></li>
    <li><a href="#stata-例子-法院-年份案件公开率">Stata 例子 ：法院-年份案件公开率</a></li>
    <li><a href="#python-例子大型数据的匹配">Python 例子：大型数据的匹配</a></li>
    <li><a href="#python-例子-案件类型的分类">python 例子 ：案件类型的分类</a></li>
    <li><a href="#python-例子-基于姓名预测性别">Python 例子 ：基于姓名预测性别</a></li>
    <li><a href="#描述统计">描述统计</a>
      <ul>
        <li><a href="#环状图">环状图</a></li>
        <li><a href="#条状图">条状图</a></li>
        <li><a href="#均值中位数分布图">均值中位数分布图</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>+++
Title = &rsquo; 标题名'
Slug = &lsquo;链接名&rsquo;
date = 2024-10-29T18:52:19+08:00
Draft = true
Math= false
OutdatedInfoWarning  = false
Lightgallery = true
FeaturedImage=&quot;/img/pythonGIS.zh-cn-20250524111143536.webp&quot;
Tags = [&ldquo;标签&rdquo;,&ldquo;ass&rdquo; ]
Categories= [&ldquo;Movies&rdquo;,&ldquo;test&rdquo;]
Summary=&rsquo; 总结'
+++</p>
<meting-js url="/music/%E4%B8%89%E5%8F%B6%28%E4%B8%BB%E9%A2%98%E6%9B%B2%29%20-%20RADWIMPS-MengLuoRJ.m4s" name="三葉のテーマ" artist=" 君の名" cover="/images/%E4%B8%89%E8%91%89%E3%81%AE%E3%83%86%E3%83%BC%E3%83%9E.jpg" theme="#448aff"></meting-js>
<div class="details admonition note">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>This is a tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">类型：tip note bug abstract info success question  warning  failure danger example quote</div>
        </div>
    </div>
<p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/FO8Ngl57HRQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<div class="bilibili"><iframe src="//player.bilibili.com/player.html?bvid=BV1Qu4y1j7GS&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe></div>

<meting-js server="netease" type="song" id="1833805540" theme="#448aff"></meting-js></p>
<h1 id="裁判文书清洗手册">裁判文书清洗手册</h1>
<p>作者：滑翔闪</p>
<ul>
<li>这个文档既是目前工作的汇报，也是一些经验的总结。</li>
<li>或许能方便后面的同学更快上手裁判文书的清洗工作。</li>
<li>希望未来的同学能重视工程技巧的优化总结与文档分享。</li>
</ul>
<p><strong>思考如何优化工程，优化团队协作，让积累和输出成为一种能力</strong>。</p>
<p>世界不但需要输入，也需要输出，知识的分享与传递才是人类文明不断进步的纽带。</p>
<p>关于 AI 工具的推荐：</p>
<p><a href="https://tongyi.aliyun.com/" target="_blank" rel="noopener noreffer ">通义千问</a>：<strong>上下文记忆能力长</strong>，能让它改善长代码。</p>
<p><a href="https://chat.openai.com/auth/login" target="_blank" rel="noopener noreffer ">GPT</a> ：<strong>更了解 stata 的函数</strong>。在我处理字符串变量时，通义千问经常用复杂的命令处理，通常还报错，而 GPT 知道很多 stata 的不常用函数，一行代码就可以轻松搞定。</p>
<p><a href="https://chat.deepseek.com/" target="_blank" rel="noopener noreffer ">deepseek</a> :国内新秀。语言表达很不错。能很快理解使用者的意思。虽然 GPT 的代码能力更加优秀，但 deepseek 更能听懂要求，建议 deepseek 生产基础代码，gpt 进行优化。</p>
<h2 id="关于裁判文书的网站">关于裁判文书的网站</h2>
<p>不建议去裁判文书网查询案例，反应卡顿，验证频繁</p>
<p>推荐<a href="https://home.pkulaw.com/" target="_blank" rel="noopener noreffer ">北大法宝</a>和<a href="%e5%a8%81%e7%a7%91%e5%85%88%e8%a1%8c" rel="">威科先行</a>（自带可视化和便捷查询）</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #7d637a; background-color: #f6edf5; border-color: #f1e4f0;">
&#x1F4AC
    <b> 备注：裁判文书的清洗需要交替处理中文和数字。本文档会多提一些 python 和 stata 的常用正则表达式。
</b></div>
<p>AI 虽然掌握了很多函数，但它不知道怎么组合。</p>
<p>谋篇布局的算法理解才是我们的最大优势。</p>
<p>提问时要替 AI 理顺代码的算法。</p>
<p>有了 AI 后——知道什么包能实现什么功能，在算法下有什么作用，比掌握细节更重要。</p>
<h2 id="裁判文书资源">裁判文书资源</h2>
<p><strong>原始文本数据</strong>：一堆 txt 文件。每一行是一条裁判文书信息，Txt 文件以 “万”作为文件名，因此下面使用整数部分的数字代表每个 txt 文件。</p>
<p>配套的文档是压缩包、文书字典、变量含义表格。
​

<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113205914854.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113205914854.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113205914854.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p><strong>提示</strong>😍：每个 txt 文件都很大，一般软件打不开。个人推荐使用 <a href="https://www.emeditor.com/" target="_blank" rel="noopener noreffer ">EmEditor</a> 软件查看。积极使用 <a href="https://www.emeditor.com/" target="_blank" rel="noopener noreffer ">EmEditor</a> 软件查看例子，能让我们更好地了解乱码情况和裁判文书的书写规则，以便改进我们的文本处理代码。</p>
<ul>
<li><strong>Dta 数据</strong>：前辈们清洗好的 stata 文件。拆分为了 ans 1—ans 83。格式刷 stata 的 <code>.dta</code>格式</li>
</ul>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210027701.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210027701.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210027701.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p>一套完整的清洗流程就是：</p>
<p>从原始的 txt 中筛选提取我们需要的信息，最终成为能导入 stata 使用的数据。</p>
<h2 id="txt-文件的处理">txt 文件的处理</h2>
<p>Txt 的裁判文书大部分已经处理为了 json格式，python 读取其实较为方便。</p>
<p>其中，大部分裁判文书 txt 文件是下方的 s 系列命名结构：</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp" title="重要的信息都在第三列，s*系列包含的数据结构当中" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210107895.webp" data-sub-html="<h2> </h2><p>重要的信息都在第三列，s*系列包含的数据结构当中</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210107895.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210107895.webp" />
    </a><figcaption class="image-caption">重要的信息都在第三列，s*系列包含的数据结构当中</figcaption>
    </figure></p>
<p>重要的信息都在第三列，s*系列包含的数据结构当中</p>
<p>但跑通了一到三份 txt 文件不等于能跑通所有。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #a94442; background-color: #f2dede; border-color: #ebccd1;">
&#x26D4<b> Txt 的裁判文书还存在一些其他格式：
<ul>
<li>有些 txt 文件格式为 DocInfoVo 开头的。</li>
<li>有些 txt 文件格式为 title 开头的。</li>
<li>有些 txt 文件格式夹杂着 HTML 语言。</li>
<li>有些 txt 文件格式是纯粹的乱码。</li>
<li>有些格式中 s 系列和 DocInfoVo 格式混在一起，导致循环代码被打断。
</b></div></li>
</ul>
<p>因此处理时得考虑<strong>代码的兼容性和全面性</strong>，分开写处理代码，然后对这种 txt 文件处理两次。</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210203690.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210203690.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210203690.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210207504.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210207504.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210207504.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<h3 id="一些建议">一些建议</h3>
<p>由于循环容易被打断，用 txt 进行处理处理时，建议参考如下逻辑：</p>
<p>1、将乱码的 txt（附在后文）和 s 系列的 txt 分开处理</p>
<p>2、原始文件为 txt，清洗处理后生成新的 cleaned_txt。</p>
<p>3、由于清洗循环命令容易被打断，最好多写一个命令：对比 txt 和 cleaned_txt 的文件名。</p>
<p>4、多写一个步骤：将处理完成的 txt 文档移动到另一个文件夹，修改报错代码后继续循环。</p>
<blockquote>
<p>Python 默认读取文件的顺序是 txt 1 txt 10 text 111&hellip; 而不是 1、2、3&hellip;</p>
</blockquote>
<h3 id="乱码文档">乱码文档</h3>
<p>不只是 s 系列格式的 txt 文件有：</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210248250.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210248250.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210248250.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<h2 id="python-例子-提取案件号序列">Python 例子 ：提取案件号序列</h2>
<h3 id="思路">思路</h3>
<p>python 读取 txt 的 json 格式。</p>
<p>提取第三列 <code>CourtInfo</code> 数据。</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp" title="例子" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210332387.webp" data-sub-html="<h2> </h2><p>例子</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210332387.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210332387.webp" />
    </a><figcaption class="image-caption">例子</figcaption>
    </figure></p>
<p>s 23 变量所有案件号，以此追踪<strong>一审二审再审终审</strong>。</p>
<p>例如 <code>（2016）沪0104民初33043号</code> ，其实就是一个裁判文书案件的身份证号。</p>
<p>正则表达式筛选：按照 <code>（年份）初\终\再 号</code> 的规则提取满足要求的字符串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;[（(]\d</span><span class="si">{4}</span><span class="s2">[)）][^号]*?(?:初|终|再)[^号]*?号&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>提取后去除重、排除包含“<code>['X', 'x', 'Ｘ', '执', '不动产', '-', '第']</code>”的案件号。</p>
<blockquote>
<p>如果继续使用这种方法提取，排除时最好加入 <strong>辖</strong>。</p>
<p>这种案号也有辖初、辖再、辖终，但只表示法院在管理权上的划分。</p>
<p>（或许以后还有人能想到用这个特征做研究？👍）</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;Ｘ&#39;</span><span class="p">,</span> <span class="s1">&#39;执&#39;</span><span class="p">,</span> <span class="s1">&#39;不动产&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;第&#39;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>排序，优先按照案号中的 (年份) 进行排序。 删除案号数量大于等于 5 的所有行。</p>
<p>一个案子最多是如下的顺序：</p>
<p>初审，不服申请上诉，再审，终审，不服再进行上诉，终审。</p>
<p>可以直接从初审跳到终审，终审后还有最后一次再审机会，再审结束后一般就不会更改了。</p>
<blockquote>
<p>个人的排序逻辑：（此处最大的漏洞是我想不到怎么完美识别“再”案号的位置）</p>
<p>生成 m 1——m 4 四个变量 带有初的案号归类到 m 1，带有终的案号归类到 m 3。</p>
<p>带有再的情况：</p>
<p>如果只有初和再，再归类到 m 2</p>
<p>如果只再，我默认放在 m 4</p>
<p>如果同时有终、再，根据相对位置判断再是 m 2 还是 m 4。</p>
<p>后面发现：【辖终】会干扰顺序，所以先将包含辖的案号清除，然后和被其挤到 m 4 的【终】案号交换顺序。</p>
<p>这就是大数据最麻烦的点：</p>
<p><strong>如果前面工作没有完美做好，后面返工成本会越来越高。 最糟糕的是——大数据总是很难穷尽所有乱码可能。</strong></p>
</blockquote>
<h3 id="单个-txt-的处理">单个 txt 的处理</h3>
<p>以下代码只针对 <strong>s 系列</strong>命名的文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">json</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 读取数据  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;F:/桌面/裁判文书数据库/test/test.txt&#34;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看前几行数据  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 假设 CourtInfo 列中包含 JSON 字符串  </span>
</span></span><span class="line"><span class="cl"> <span class="n">json_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 解析 JSON 数据  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 应用解析函数  </span>
</span></span><span class="line"><span class="cl"> <span class="n">parsed_prac_c</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_json</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 将 JSON 字典转换为 DataFrame，并处理缺失值  </span>
</span></span><span class="line"><span class="cl"> <span class="n">json_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">parsed_prac_c</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看转换后的 DataFrame  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">json_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 正则表达式模式  </span>
</span></span><span class="line"><span class="cl"> <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;[（(]\d</span><span class="si">{4}</span><span class="s2">[）)]\s*.*?号&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 使用findall提取所有匹配项  </span>
</span></span><span class="line"><span class="cl"> <span class="n">matches</span> <span class="o">=</span> <span class="n">json_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看转换后的 DataFrame  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 创建新的 DataFrame，将更新后的 &#39;s23&#39; 列保存  </span>
</span></span><span class="line"><span class="cl"> <span class="n">matches_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">     <span class="s1">&#39;s23&#39;</span><span class="p">:</span> <span class="n">matches</span>  
</span></span><span class="line"><span class="cl"> <span class="p">})</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看转换后的 DataFrame  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">matches_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># print(matches_df)  </span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 选择要合并的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">selected_data_columns</span> <span class="o">=</span> <span class="p">[]</span>   
</span></span><span class="line"><span class="cl"> <span class="n">selected_json_df_columns</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 合并选择的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">selected_data_columns</span><span class="p">],</span> <span class="n">json_df</span><span class="p">[</span><span class="n">selected_json_df_columns</span><span class="p">],</span><span class="n">matches_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># 将列表转换为字符串，元素之间用逗号和空格分隔  </span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;[]&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl">         <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">cleaned_text</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 切割并生成列名  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">split_and_rename</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">content</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">split_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;m</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_content</span><span class="p">))</span> <span class="k">if</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">result</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 应用函数  </span>
</span></span><span class="line"><span class="cl"> <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_and_rename</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看结果  </span>
</span></span><span class="line"><span class="cl"> <span class="c1"># print(&#34;Expanded DataFrame:&#34;)  </span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 提取年份的函数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">extract_year</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[（(](\d</span><span class="si">{4}</span><span class="s1">)[）)]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="k">match</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 清洗和排序函数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">clean_and_sort</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 过滤掉非字符串类型的值  </span>
</span></span><span class="line"><span class="cl">     <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 去除重复项并保持顺序  </span>
</span></span><span class="line"><span class="cl">     <span class="n">unique_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 按年份排序  </span>
</span></span><span class="line"><span class="cl">     <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 需要排除的关键字列表  </span>
</span></span><span class="line"><span class="cl"> <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;Ｘ&#39;</span><span class="p">,</span> <span class="s1">&#39;执&#39;</span><span class="p">,</span> <span class="s1">&#39;不动产&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;第&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 筛选所有 m* 列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">m_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 对每一行应用清洗和排序函数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 获取 m* 列的内容  </span>
</span></span><span class="line"><span class="cl">     <span class="n">row_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_columns</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 扁平化列表  </span>
</span></span><span class="line"><span class="cl">     <span class="n">flattened</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">row_values</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sublist</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">sublist</span><span class="p">])]</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 处理并排序  </span>
</span></span><span class="line"><span class="cl">     <span class="n">sorted_items</span> <span class="o">=</span> <span class="n">clean_and_sort</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 应用到数据框的每一行  </span>
</span></span><span class="line"><span class="cl"> <span class="n">sorted_results</span> <span class="o">=</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">process_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 创建新的数据框  </span>
</span></span><span class="line"><span class="cl"> <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="n">sorted_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">)])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 打印结果  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">sorted_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 合并到原数据  </span>
</span></span><span class="line"><span class="cl"> <span class="n">combined_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">combined_df</span><span class="p">,</span> <span class="n">sorted_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 查看结果  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">combined_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 检查 &#39;m_sorted_5&#39; 列是否存在，并删除非空行  </span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="s1">&#39;m_sorted_5&#39;</span> <span class="ow">in</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="p">[</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 如果列不存在，则保留原数据框  </span>
</span></span><span class="line"><span class="cl">     <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 打印结果  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取所有 m_sorted_* 列的名称  </span>
</span></span><span class="line"><span class="cl"> <span class="n">m_sorted_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m_sorted_&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 过滤出索引大于等于 5 的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_sorted_columns</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 删除指定的列  </span>
</span></span><span class="line"><span class="cl"> <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_drop</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 打印结果以检查清理后的数据框  </span>
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="n">combined_df2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;F:/桌面/combined_df.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="批量处理">批量处理</h3>
<p>个人选择的批量处理思路是循环处理一个文件夹下面的所有文档。</p>
<p>循环容易被打断，建议写一个报错记录，和处理完一个文档便移动的命令。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">json</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义输入和输出文件夹路径  </span>
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义输入和输出文件夹路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">input_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/数据/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">output_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/清洗结果/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 如果输出文件夹不存在，则创建它  </span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 遍历输入文件夹中的所有 .txt 文件  </span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">input_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 读取数据  </span>
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前3行数据以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processing file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 解析JSON字段  </span>
</span></span><span class="line"><span class="cl">         <span class="n">json_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="n">parsed_prac_c</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_json</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 将解析后的JSON转换为DataFrame  </span>
</span></span><span class="line"><span class="cl">         <span class="n">json_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">parsed_prac_c</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前20行以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">json_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 定义匹配模式  </span>
</span></span><span class="line"><span class="cl">         <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;[（(]\d</span><span class="si">{4}</span><span class="s2">[）)]\s*.*?号&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 查找匹配项  </span>
</span></span><span class="line"><span class="cl">         <span class="n">matches</span> <span class="o">=</span> <span class="n">json_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前3行匹配结果以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 将匹配结果转换为DataFrame  </span>
</span></span><span class="line"><span class="cl">         <span class="n">matches_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;s23&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">})</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印前10行匹配结果DataFrame以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">matches_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 选择要保留的数据列  </span>
</span></span><span class="line"><span class="cl">         <span class="n">selected_data_columns</span> <span class="o">=</span> <span class="p">[]</span>   
</span></span><span class="line"><span class="cl">         <span class="n">selected_json_df_columns</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 合并原始数据、解析后的JSON数据以及匹配结果  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">selected_data_columns</span><span class="p">],</span> <span class="n">json_df</span><span class="p">[</span><span class="n">selected_json_df_columns</span><span class="p">],</span> <span class="n">matches_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 清洗文本函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&#34;[]&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                     <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="n">cleaned_text</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="s1">&#39;&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 分割并重命名函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">split_and_rename</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="n">content</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="n">split_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;m</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_content</span><span class="p">))</span> <span class="k">if</span> <span class="n">split_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">result</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 展开匹配结果  </span>
</span></span><span class="line"><span class="cl">         <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;s23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_and_rename</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 提取年份函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">extract_year</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[（(](\d</span><span class="si">{4}</span><span class="s1">)[）)]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="k">match</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 清洗并排序函数  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">clean_and_sort</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">             <span class="n">unique_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">             <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 排除关键词列表  </span>
</span></span><span class="line"><span class="cl">         <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;Ｘ&#39;</span><span class="p">,</span> <span class="s1">&#39;执&#39;</span><span class="p">,</span> <span class="s1">&#39;不动产&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;第&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 获取所有m开头的列名  </span>
</span></span><span class="line"><span class="cl">         <span class="n">m_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 处理每一行  </span>
</span></span><span class="line"><span class="cl">         <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="n">row_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_columns</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">             <span class="n">flattened</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">row_values</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sublist</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">sublist</span><span class="p">])]</span>  
</span></span><span class="line"><span class="cl">             <span class="n">sorted_items</span> <span class="o">=</span> <span class="n">clean_and_sort</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">sorted_items</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="n">sorted_results</span> <span class="o">=</span> <span class="n">expanded_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">process_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 计算最大长度，并创建新的排序后的DataFrame  </span>
</span></span><span class="line"><span class="cl">         <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">         <span class="n">sorted_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sorted_results</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">)])</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 再次合并数据  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">combined_df</span><span class="p">,</span> <span class="n">sorted_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 过滤条件  </span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="s1">&#39;m_sorted_5&#39;</span> <span class="ow">in</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="p">[</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined_df2</span><span class="p">[</span><span class="s1">&#39;m_sorted_5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">         <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印清理后的前10行数据以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 获取所有m_sorted开头的列名  </span>
</span></span><span class="line"><span class="cl">         <span class="n">m_sorted_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;m_sorted_&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 要删除的列名  </span>
</span></span><span class="line"><span class="cl">         <span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">m_sorted_columns</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 删除不需要的列  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df2_cleaned</span> <span class="o">=</span> <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_drop</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 打印最终前几行数据以检查  </span>
</span></span><span class="line"><span class="cl">         <span class="nb">print</span><span class="p">(</span><span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 保存到文件  </span>
</span></span><span class="line"><span class="cl">         <span class="n">combined_df2_cleaned</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Processing complete.&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="python-例子-提取法条和移动文件夹">Python 例子 ：提取法条和移动文件夹</h2>
<p>法条数量可以衡量案件复杂度，法条本身也衡量了案件类型。</p>
<p>Txt 文档的 s 47 系列对应着文书的法条，里面是第二层 json 格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">fgmc</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fgmc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">tkx</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tkx&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(第.*?条)&#39;</span><span class="p">,</span> <span class="n">tkx</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>['s23', 's25', 's26', 's27']</code> 的中文字符加总就是裁判文书的正文字数。</p>
<blockquote>
<p>&ldquo;s7&rdquo;: &ldquo;案件号&rdquo;,&ldquo;s23&rdquo;: &ldquo;诉讼记录&rdquo;,&ldquo;s24&rdquo;: &ldquo;诉控辩&rdquo;,&ldquo;s25&rdquo;: &ldquo;事实&rdquo;,&ldquo;s26&rdquo;: &ldquo;理由&rdquo;,&ldquo;s27&rdquo;: &ldquo;判决结果&rdquo;。</p>
</blockquote>
<h3 id="多个-txt">多个 txt</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">json</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">glob</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">logging</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 配置日志记录  </span>
</span></span><span class="line"><span class="cl"> <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 明确指定输入文件夹和输出文件夹的路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">input_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/数据/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">output_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/清洗结果/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">log_folder_path</span> <span class="o">=</span> <span class="s2">&#34;C:/Users/PC/Desktop/hzp_project/二审和一审/日志/&#34;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 确保输出文件夹和日志文件夹存在  </span>
</span></span><span class="line"><span class="cl"> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 解析 JSON 数据  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">json_str</span>  
</span></span><span class="line"><span class="cl">         <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;未知数据类型: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">     <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;JSON 解析失败: </span><span class="si">{</span><span class="n">json_str</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 计算中文字符数  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">count_chinese_chars</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\u4e00-\u9fff\u0030-\u0039\u3000-\u303f\uff00-\uffef]&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 提取和格式化条款  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">extract_clauses</span><span class="p">(</span><span class="n">s47_data</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="n">formatted_clauses</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">s47_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="n">parse_json</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">clauses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># 使用集合去重  </span>
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">fgmc</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fgmc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">tkx</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tkx&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(第.*?条)&#39;</span><span class="p">,</span> <span class="n">tkx</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                 <span class="k">if</span> <span class="k">match</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                     <span class="n">clauses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">fgmc</span><span class="si">}{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="n">formatted_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">clauses</span><span class="p">))</span>  <span class="c1"># 保存每行提取的条款  </span>
</span></span><span class="line"><span class="cl">         <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="n">formatted_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>  <span class="c1"># 如果解析失败，则添加空列表  </span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">formatted_clauses</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 处理单个文件  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">process_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">log_folder</span><span class="p">,</span> <span class="n">total_rows</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 初始化一个空的列表来存储错误信息  </span>
</span></span><span class="line"><span class="cl">     <span class="n">error_logs</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="k">def</span> <span class="nf">bad_line_handler</span><span class="p">(</span><span class="n">bad_line</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">         <span class="n">error_logs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">input_file</span><span class="p">,</span> <span class="n">bad_line</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">bad_line</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 读取数据  </span>
</span></span><span class="line"><span class="cl">     <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="n">bad_line_handler</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Read </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error reading file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">return</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 过滤掉 CourtInfo 列以 &#34;DocInfoVo&#34; 开头或无法解析为 JSON 的行  </span>
</span></span><span class="line"><span class="cl">     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#34;s1&#34;:&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parse_json</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">dict</span><span class="p">))]</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Filtered out invalid rows from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 提取 JSON 数据  </span>
</span></span><span class="line"><span class="cl">     <span class="n">json_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CourtInfo&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 应用解析函数  </span>
</span></span><span class="line"><span class="cl">     <span class="n">parsed_prac_c</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_json</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Parsed JSON data from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 将 JSON 字典转换为 DataFrame，并处理缺失值  </span>
</span></span><span class="line"><span class="cl">     <span class="n">json_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">parsed_prac_c</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Normalized JSON data from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 选取特定列  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span> <span class="o">=</span> <span class="n">json_df</span><span class="p">[[</span><span class="s1">&#39;s7&#39;</span><span class="p">,</span> <span class="s1">&#39;s23&#39;</span><span class="p">,</span> <span class="s1">&#39;s25&#39;</span><span class="p">,</span> <span class="s1">&#39;s26&#39;</span><span class="p">,</span> <span class="s1">&#39;s27&#39;</span><span class="p">,</span> <span class="s1">&#39;s47&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 使用 .copy() 创建副本  </span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 计算 s26 列中“条”字的出现次数  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;count_tiao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;s26&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;条&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Calculated &#39;count_tiao&#39; from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 计算 s23, s25, s26, s27 列的总字数  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;total_chars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_columns</span><span class="p">[[</span><span class="s1">&#39;s23&#39;</span><span class="p">,</span> <span class="s1">&#39;s25&#39;</span><span class="p">,</span> <span class="s1">&#39;s26&#39;</span><span class="p">,</span> <span class="s1">&#39;s27&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">         <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_chinese_chars</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl">     <span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Calculated &#39;total_chars&#39; from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 提取和格式化条款  </span>
</span></span><span class="line"><span class="cl">     <span class="n">unique_clauses</span> <span class="o">=</span> <span class="n">extract_clauses</span><span class="p">(</span><span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;s47&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;unique_clauses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_clauses</span>  <span class="c1"># 使用 .loc 进行安全赋值  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[</span><span class="s1">&#39;clause_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span> <span class="k">for</span> <span class="n">clauses</span> <span class="ow">in</span> <span class="n">unique_clauses</span><span class="p">]</span>  <span class="c1"># 每行的条款数量  </span>
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Extracted and formatted clauses from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 生成输出文件名  </span>
</span></span><span class="line"><span class="cl">     <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;cleaned_</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 将结果保存为 txt 文件  </span>
</span></span><span class="line"><span class="cl">     <span class="n">selected_columns</span><span class="p">[[</span><span class="s1">&#39;s7&#39;</span><span class="p">,</span> <span class="s1">&#39;count_tiao&#39;</span><span class="p">,</span> <span class="s1">&#39;total_chars&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_clauses&#39;</span><span class="p">,</span> <span class="s1">&#39;clause_count&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processed and saved to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 汇报进度  </span>
</span></span><span class="line"><span class="cl">     <span class="n">processed_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已完成处理文件: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">, 条目数: </span><span class="si">{</span><span class="n">processed_rows</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_rows</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl">     <span class="c1"># 保存错误日志  </span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="n">error_logs</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;error_log_</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.txt&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">error_logs</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;File: </span><span class="si">{</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Line: </span><span class="si">{</span><span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, Content: </span><span class="si">{</span><span class="n">log</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error logs saved to: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 遍历输入文件夹中的所有文件  </span>
</span></span><span class="line"><span class="cl"> <span class="n">all_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="s2">&#34;*.txt&#34;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"> <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="n">processed_files</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="ow">not</span> <span class="n">all_files</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;No files found in the input folder.&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">         <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">         <span class="c1"># 汇报当前处理的文件进度  </span>
</span></span><span class="line"><span class="cl">         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;正在处理文件: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">processed_files</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">         <span class="n">process_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_folder_path</span><span class="p">,</span> <span class="n">log_folder_path</span><span class="p">,</span> <span class="n">total_files</span><span class="p">)</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><p> ​</p>
<h3 id="移动-txt">移动 txt</h3>
<p>因为代码循环非常容易被打断，我建议设置<strong>三个文件夹</strong>：</p>
<p>原始文件夹存放原始数据，</p>
<p>结果文件夹存放处理完成的数据，统一改为 <code>cleaned_*</code> 的 txt 名字，</p>
<p>清洗完成的文件夹：把清洗完成的原始数据放到这里，便于循环打断后继续开始，</p>
<p>因此本代码的逻辑就是对照<strong>清洗完成的文件夹</strong>和<strong>原始文件夹</strong>，将名字有对应的 txt 文档进行移动。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="nn">shutil</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 定义文件夹路径  </span>
</span></span><span class="line"><span class="cl"> <span class="n">source_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:/桌面/测试/清洗结果&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">data_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:/桌面/测试/数据&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="n">cleaned_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;F:/桌面/测试/完成提取&#39;</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取源文件夹中的所有.txt文件名（不含路径），并去除前缀 &#34;cleaned_&#34;，同时去除所有多余空格并转换为小写  </span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">standardize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取源文件夹中的文件名  </span>
</span></span><span class="line"><span class="cl"> <span class="n">source_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cleaned_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="n">standardized_source_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">standardize_filename</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">8</span><span class="p">:]):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source_files</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 获取数据文件夹中的文件名  </span>
</span></span><span class="line"><span class="cl"> <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"> <span class="n">standardized_data_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">standardize_filename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 找出数据文件夹中与源文件夹中相同的文件  </span>
</span></span><span class="line"><span class="cl"> <span class="n">common_files</span> <span class="o">=</span> <span class="n">standardized_source_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">standardized_data_files</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="c1"># 移动相同的文件到清洗完成文件夹  </span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">common_files</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">     <span class="n">original_filename</span> <span class="o">=</span> <span class="n">standardized_source_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">     <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">original_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cleaned_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">     <span class="n">destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_folder</span><span class="p">,</span> <span class="n">original_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cleaned_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="c1"># 确保目标文件夹存在  </span>
</span></span><span class="line"><span class="cl">     <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">destination_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">     <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Moved: </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">destination_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="err">​</span>  
</span></span><span class="line"><span class="cl"> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Process completed.&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="例子--裁判文书索引重新排序">例子 ： 裁判文书索引重新排序</h2>
<p><strong>初审案号最早的排在前（m_sorted_1）</strong></p>
<p><strong>终审案号最晚的排在后（m_sorted_3）</strong></p>
<p><strong>再审案件按照“终审前最早、终审后最晚”安排（m_sorted_2, m_sorted_4）</strong></p>
<p><strong>其余案号按时间顺序补充空位（m_sorted_5）</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="n">year_str</span><span class="p">,</span> <span class="n">month_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;将年份、月份字符串转换为日期对象，若转换失败返回 None&#34;&#34;&#34;</span>    <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month_str</span><span class="p">)</span> <span class="k">if</span> <span class="n">month_str</span> <span class="ow">and</span> <span class="n">month_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&#34;&#34;</span> <span class="k">else</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reorder_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="c1"># 要一起移动的额外字段列表（除了 m_sorted_i 之外的其它关联变量）  </span>
</span></span><span class="line"><span class="cl">    <span class="n">extra_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;court&#39;</span><span class="p">,</span> <span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_am&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 遍历原有 5 组数据，构造每组条目（只有当 m*_judge_am 和 m*_jud_year 均有值时认为该组有效）  </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">judge_am</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_judge_am&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">jud_year</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_jud_year&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">judge_am</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">jud_year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">judge_am</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">jud_year</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">        <span class="n">case_str</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">case_str</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">case_str</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">        <span class="n">jud_month</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_jud_month&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">dt</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">jud_year</span><span class="p">,</span> <span class="n">jud_month</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1"># 判断案号类型  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;初&#34;</span> <span class="ow">in</span> <span class="n">case_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&#34;chu&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="s2">&#34;终&#34;</span> <span class="ow">in</span> <span class="n">case_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&#34;zhong&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="s2">&#34;再&#34;</span> <span class="ow">in</span> <span class="n">case_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&#34;zai&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&#34;other&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1"># 收集其它相关字段  </span>
</span></span><span class="line"><span class="cl">        <span class="n">fields_data</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">extra_fields</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">fields_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;orig_index&#34;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>  <span class="c1"># 原来的组号  </span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;case&#34;</span><span class="p">:</span> <span class="n">case_str</span><span class="p">,</span>  <span class="c1"># 案号字符串  </span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;date&#34;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>  <span class="c1"># 转换后的日期（可能为 None）  </span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="n">typ</span><span class="p">,</span>  <span class="c1"># 案号类型：chu / zhong / zai / other  </span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;fields&#34;</span><span class="p">:</span> <span class="n">fields_data</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 若没有有效条目，则返回所有新组为空  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="sa">f</span><span class="s2">&#34;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 定位“初”：从所有包含“初”的条目中取日期最早的  </span>
</span></span><span class="line"><span class="cl">    <span class="n">chu_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;chu&#34;</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">initial_entry</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chu_entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">])</span> <span class="k">if</span> <span class="n">chu_entries</span> <span class="k">else</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 定位“终”：从所有包含“终”的条目中取日期最大的  </span>
</span></span><span class="line"><span class="cl">    <span class="n">zhong_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;zhong&#34;</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">terminal_entry</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">zhong_entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">])</span> <span class="k">if</span> <span class="n">zhong_entries</span> <span class="k">else</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取所有“再”的条目  </span>
</span></span><span class="line"><span class="cl">    <span class="n">zai_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;zai&#34;</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化新排序位置字典，表示最终放置在 m_sorted_1～m_sorted_5 中的条目  </span>
</span></span><span class="line"><span class="cl">    <span class="n">new_positions</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># m_sorted_1 始终放“初”案  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">initial_entry</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">new_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_entry</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">terminal_entry</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果存在终案，则 m_sorted_3 固定放终案  </span>
</span></span><span class="line"><span class="cl">        <span class="n">new_positions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">terminal_entry</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1"># 分组：终案之前的“再”  </span>
</span></span><span class="line"><span class="cl">        <span class="n">re_before</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">zai_entries</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">terminal_entry</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]]</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># 分组：终案之后的“再”  </span>
</span></span><span class="line"><span class="cl">        <span class="n">re_after</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">zai_entries</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">terminal_entry</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1"># 日期早于终案的“再”中取最早的放入 m_sorted_2        if re_before:  </span>
</span></span><span class="line"><span class="cl">            <span class="n">new_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">re_before</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1"># 日期晚于终案的“再”中取最晚的放入 m_sorted_4        if re_after:  </span>
</span></span><span class="line"><span class="cl">            <span class="n">new_positions</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">re_after</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果不存在终案，即只有“初”与“再”  </span>
</span></span><span class="line"><span class="cl">        <span class="n">zai_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zai_entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zai_sorted</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">new_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zai_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">zai_sorted</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1"># 最早的放入 m_sorted_2，最晚的放入 m_sorted_4            new_positions[2] = zai_sorted[0]  </span>
</span></span><span class="line"><span class="cl">            <span class="n">new_positions</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">zai_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 将剩余未分配的条目（包括类型为 other 或未被选中的其他）按日期排序后填入剩余空位（例如 m_sorted_5）  </span>
</span></span><span class="line"><span class="cl">    <span class="n">assigned_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">[</span><span class="s2">&#34;orig_index&#34;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_positions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;orig_index&#34;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assigned_indices</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">remaining_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&#34;date&#34;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">new_positions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">remaining_sorted</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">new_positions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">remaining_sorted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1"># 构造返回的 Series：按新的组号 1～5 写入 m_sorted_i 与对应的关联字段  </span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">new_group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">new_positions</span><span class="p">[</span><span class="n">new_group</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">entry</span> <span class="o">=</span> <span class="n">new_positions</span><span class="p">[</span><span class="n">new_group</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;m_sorted_</span><span class="si">{</span><span class="n">new_group</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&#34;case&#34;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">extra_fields</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">new_group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&#34;fields&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;m_sorted_</span><span class="si">{</span><span class="n">new_group</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">extra_fields</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">new_group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># 读取数据（注意路径中使用原始字符串防止反斜杠转义问题）  </span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;C:\Users\PC\Desktop\案号排序.txt&#34;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&#34;,&#34;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># 对每一行调用 reorder_row，得到重新排序后的 m* 系列数据  </span>
</span></span><span class="line"><span class="cl"><span class="n">df_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">reorder_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># 将重新排序后的变量更新回原 DataFrame（包括 m_sorted_1～m_sorted_5 及各组的关联字段）  </span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;m_sorted_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">new_group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;court&#39;</span><span class="p">,</span> <span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_am&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;m</span><span class="si">{</span><span class="n">new_group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># 保存结果到新文件  </span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;C:\Users\PC\Desktop\结果_案号排序.txt&#34;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dta-数据的匹配">dta 数据的匹配</h2>
<h3 id="关于案号">关于案号</h3>
<p>裁判文书的案号分为裁定文书、判决文书、其他文书（监督、执行、保证&hellip;.）</p>
<p>裁定文书是审判程序上的问题，例如这个问题不该xx法院管，移交到xx法院去。</p>
<p>判决文书是实体问题，也就是判决的最终结果。</p>
<p>注意！判决文书和裁判文书是可能共享一个案号的！</p>
<p>同时在这里分享一些个人看到的奇葩裁判文书案号，有一些奇怪的符号可能是别人用过了然后再加符号作为区分。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2018（）皖02民终1098号  
</span></span><span class="line"><span class="cl">2016湘06民终2392号  
</span></span><span class="line"><span class="cl">（（2017）豫0481民再10号 
</span></span><span class="line"><span class="cl">一（2017）粤0605民初10499号 
</span></span><span class="line"><span class="cl">(2015)芙民初字第7479、7601号 
</span></span><span class="line"><span class="cl">（2015）芙民初字第7478.7603号 
</span></span><span class="line"><span class="cl">（2019）粤0305民初1382号-1429号 
</span></span><span class="line"><span class="cl">（2019）鲁1724民初195号- 018）
</span></span><span class="line"><span class="cl">苏0509民初6820号 
</span></span><span class="line"><span class="cl">ｌｏｚ2016ｌｏｚ赣1030民初220号  
</span></span><span class="line"><span class="cl">一亿二千三百四十五万（2016）粤0605民初14359号 
</span></span><span class="line"><span class="cl">（2018）土地承包经营权转让浙0523民初2386号 
</span></span><span class="line"><span class="cl">2016闽0525民初3798号2016闽0525民初3798号 
</span></span><span class="line"><span class="cl">（空一行行距15磅）（2014）滨港民初字第307号
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于中英文括号的问题，建议可以去除括号，但是不建议采用只保留中文和数字的筛选方式，很多时候短横线神秘字符也有标识作用。</p>
<p>个人匹配的筛选如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">sort</span> <span class="n">case_wid</span>
</span></span><span class="line"><span class="cl"><span class="n">drop</span> <span class="k">if</span> <span class="n">case_wid</span> <span class="o">==</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">foreach</span> <span class="k">var</span> <span class="n">of</span> <span class="n">varlist</span> <span class="n">case_wid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span> <span class="err">去除空格变量、括号、其他符号</span>
</span></span><span class="line"><span class="cl">	<span class="n">replace</span> <span class="err">`</span><span class="k">var</span><span class="s1">&#39; = ustrregexra(`var&#39;</span><span class="p">,</span><span class="s2">&#34;[^\p{L}\p{N}]&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">sort</span> <span class="n">case_wid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gen</span> <span class="n">case_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">case_wid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">summarize</span> <span class="n">case_length</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">drop</span> <span class="k">if</span>  <span class="n">case_length</span> <span class="o">&gt;</span> <span class="mi">66</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">drop</span> <span class="n">case_length</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="标识的去重">标识的去重</h3>
<p>Txt 提取完成后，就是转化为 <code>.dta</code> 匹配到 <code>ans*.dta</code> 中。</p>
<p><strong>案号</strong>是理论上的唯一标识，但实际上可能出现重复的情况。</p>
<p>这时候建议使用以下逻辑，先历遍所有变量，生成非空数值总数，去重，在案号的重复行间保留非空数值最多的一行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">标记重复的</span> <span class="n">case_wid</span><span class="err">，</span><span class="n">并计算每组的数量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">bysort</span> <span class="n">case_wid</span><span class="p">:</span> <span class="n">gen</span> <span class="n">dup_count</span> <span class="o">=</span> <span class="n">_N</span>  
</span></span><span class="line"><span class="cl">     <span class="n">replace</span> <span class="n">dup_count</span> <span class="o">=</span> <span class="o">.</span> <span class="k">if</span> <span class="n">_n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">//</span> <span class="n">可选</span><span class="err">：</span><span class="n">只保留第一次出现的计数</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">创建一个包含所有要检查的变量的局部宏</span>  
</span></span><span class="line"><span class="cl">     <span class="n">local</span> <span class="n">varlist</span> <span class="n">var1</span> <span class="n">var2</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">使用循环创建标志变量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">foreach</span> <span class="n">var</span> <span class="n">of</span> <span class="n">local</span> <span class="n">varlist</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">         <span class="n">gen</span> <span class="n">flag_</span><span class="err">`</span><span class="n">var</span><span class="s1">&#39; = cond(missing(`var&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="p">}</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">计算每行中非空值的数量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">egen</span> <span class="n">non_missing</span> <span class="o">=</span> <span class="n">rowtotal</span><span class="p">(</span><span class="n">flag</span><span class="o">*</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">对每个</span> <span class="n">case_wid</span> <span class="n">按非空变量数量降序排序</span><span class="err">，</span><span class="n">并标记保留的观测值</span>  
</span></span><span class="line"><span class="cl">     <span class="n">bysort</span> <span class="n">case_wid</span> <span class="p">(</span><span class="n">non_missing</span><span class="p">):</span> <span class="n">gen</span> <span class="n">keep</span> <span class="o">=</span> <span class="p">(</span><span class="n">_n</span> <span class="o">==</span> <span class="n">_N</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">清理临时变量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">capture</span> <span class="n">drop</span> <span class="n">flag</span><span class="o">*</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">删除重复值</span><span class="err">，</span><span class="n">保留非空变量最多的行</span>  
</span></span><span class="line"><span class="cl">     <span class="n">drop</span> <span class="k">if</span> <span class="err">!</span><span class="n">keep</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">清理辅助变量</span>  
</span></span><span class="line"><span class="cl">     <span class="n">drop</span> <span class="n">dup_count</span> <span class="n">non_missing</span> <span class="n">keep</span>  
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">保存处理后的文件</span><span class="err">，</span><span class="n">覆盖原有文件</span>  
</span></span><span class="line"><span class="cl">     <span class="n">save</span> <span class="s2">&#34;`input_file&#39;&#34;</span><span class="p">,</span> <span class="n">replace</span>  
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="索引值的去重">索引值的去重</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* 对第二个变量，若与第一个变量相同则清空
</span></span><span class="line"><span class="cl">replace m_sorted_2 = &#34;&#34; if m_sorted_2 == m_sorted_1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 对第三个变量，若与前面任一变量相同则清空
</span></span><span class="line"><span class="cl">replace m_sorted_3 = &#34;&#34; if m_sorted_3 == m_sorted_2 | m_sorted_3 == m_sorted_1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 对第四个变量，若与前面任一变量相同则清空
</span></span><span class="line"><span class="cl">replace m_sorted_4 = &#34;&#34; if m_sorted_4 == m_sorted_3 | m_sorted_4 == m_sorted_2 | m_sorted_4 == m_sorted_1
</span></span><span class="line"><span class="cl">* 对第五个变量，若与前面任一变量相同则清空
</span></span><span class="line"><span class="cl">replace m_sorted_5 = &#34;&#34; if  m_sorted_5 == m_sorted_4 | m_sorted_5 == m_sorted_3 | m_sorted_5 == m_sorted_2 | m_sorted_5 == m_sorted_1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="文本匹配标识的格式转化">文本匹配标识的格式转化</h3>
<p><code>ans*.dta</code> 系列的文本格式都是 <code>strL</code>，含义为长字符串。Stata 的字符串匹配只能选择有具体长度的字符串格式，我们可以通过字符截取来改变变量格式。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #31708f; background-color: #d9edf7; border-color: #bce8f1;">
&#x1F50A<b> 重要：注意，英文字符的占位符和中文字符的占位符是不同的。</b>
</div>
<blockquote>
<p>例如“民初 730 号”，虽然只是六个字符，但可能实际上占了 15 个位置。</p>
<p>如果我们只截取 6 个长度，变量就会变成乱码。</p>
<p>个人观察到的案号占位符最长大概是 39 个位置，个人为了稳健直接选择的截取 88 个字符符号。</p>
<p>这也意味着： 我们需要在清理掉文本中的奇怪符号以后再转化。</p>
<p>例如有些法院名字是&quot;<code>广西壮族自治区柳州市鱼峰区人民法院</code>&quot;</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="c1"># 截取字符  </span>
</span></span><span class="line"><span class="cl"> <span class="n">gen</span> <span class="n">judge_fin2</span> <span class="o">=</span> <span class="n">substr</span><span class="p">(</span><span class="n">judge_fin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="n">gen</span> <span class="n">court_name2</span> <span class="o">=</span> <span class="n">substr</span><span class="p">(</span><span class="n">court_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">88</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"> <span class="n">drop</span> <span class="n">judge_fin</span> <span class="n">court_name</span>  
</span></span><span class="line"><span class="cl"> <span class="n">rename</span> <span class="n">judge_fin2</span>  <span class="n">judge_fin</span>  
</span></span><span class="line"><span class="cl"> <span class="n">rename</span> <span class="n">court_name2</span> <span class="n">court_name</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="c1"># 大于特定字符数量，例如66，的案号清洗为空值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">foreach</span> <span class="k">var</span> <span class="n">of</span> <span class="n">varlist</span> <span class="n">s7</span> <span class="n">m_sorted_1</span> <span class="n">m_sorted_2</span> <span class="n">m_sorted_3</span> <span class="n">m_sorted_4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">gen</span> <span class="n">case_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="err">`</span><span class="k">var</span><span class="s1">&#39;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">summarize</span> <span class="n">case_length</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">replace</span> <span class="err">`</span><span class="k">var</span><span class="s1">&#39; =  &#34;&#34; if  case_length &gt; 66</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">drop</span> <span class="n">case_length</span>		 
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="匹配命令的选择">匹配命令的选择</h3>
<p><strong>多（基础表格）对一时</strong>：<code>merge</code> 命令直接使用。</p>
<p><strong>一（基础表格）対多时</strong>：例如 txt 有一些重复记录，但是不同行的空缺值不同。我们可以使用 <code>merge</code> 的追加匹配 <code>update nogen force</code>，只在这一行有空缺时，将空缺值的变量匹配上去；非空缺的部分则不更改。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> clear   
</span></span><span class="line"><span class="cl"> forvalues j = 1/83 {  
</span></span><span class="line"><span class="cl">     use &#34;D:\数据合集\原始数据\ans`j&#39;.dta&#34;, clear  
</span></span><span class="line"><span class="cl">     merge 1:m case_wid_str using &#34;C:\Users\PC\Desktop\hzp_project_re\一审二审数据匹配\排序\面板数据\all.dta&#34;, update nogen force  
</span></span><span class="line"><span class="cl">     drop if case_wid == &#34;&#34;  
</span></span><span class="line"><span class="cl"> duplicates drop case_wid_str , force  
</span></span><span class="line"><span class="cl">     save &#34;C:\Users\PC\Desktop\hzp_project_re\一审二审数据匹配\排序\面板数据\ans`j&#39;.dta&#34;, replace  
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>多对多（基础表格）匹配时：此时使用 <code>merge</code> 不再合适，推荐 <code>joinby</code></p>
<p>详细可参考 <a href="https://mp.weixin.qq.com/s/bTFFvihL221zM2MYaGZcuA" target="_blank" rel="noopener noreffer ">Stata命令：joinby VS merge m:m常见问题</a></p>
<h3 id="循环匹配命令">循环匹配命令</h3>
<p>当我们写循环匹配命令时，数字可能是间断点，例如 data 1、data 3、data 5、data 7&hellip;</p>
<p>可以选择使用 python 直接更改文件名字按顺序排序，但容易破坏命名含义。</p>
<p>这里提供个人写的 stata 自然数循环命令：</p>
<blockquote>
<p>当然，其实可以通过扫描文件夹下面的文件名识别所有文件，然后循环，但是如果是存在一些文件需要手动排除可以参考下这个代码。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> * 定义排除列表  
</span></span><span class="line"><span class="cl"> global exclude_list 22 50 54 58  105  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 初始化 valid_files 变量  
</span></span><span class="line"><span class="cl"> global valid_files  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 循环遍历文件编号范围，并检查是否在排除列表中  
</span></span><span class="line"><span class="cl"> forvalues i = 1/119 {  
</span></span><span class="line"><span class="cl">     local is_excluded 0  
</span></span><span class="line"><span class="cl">     foreach excl in $exclude_list {  
</span></span><span class="line"><span class="cl">         if `i&#39; == `excl&#39; {  
</span></span><span class="line"><span class="cl">             local is_excluded 1  
</span></span><span class="line"><span class="cl">             break  
</span></span><span class="line"><span class="cl">         }  
</span></span><span class="line"><span class="cl">     }  
</span></span><span class="line"><span class="cl">     if !`is_excluded&#39; {  
</span></span><span class="line"><span class="cl">         global valid_files $valid_files `i&#39;  
</span></span><span class="line"><span class="cl">     }  
</span></span><span class="line"><span class="cl"> }  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 显示有效的文件编号  
</span></span><span class="line"><span class="cl"> display &#34;Valid file numbers: $valid_files&#34;  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> ​  
</span></span><span class="line"><span class="cl"> * 循环处理有效的文件编号  
</span></span><span class="line"><span class="cl"> foreach i of global valid_files {  
</span></span><span class="line"><span class="cl">     *写入自己的循环匹配代码  
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是如果遇到的完全乱码名字的文件怎么办？在文件名没有空格或者特殊符号的情况下，可以读取文件名存入 <code>local</code> 再加入循环。这个也是更加泛用的代码。</p>
<p>例如以下乱码：</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-1769873803723.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-1769873803723.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-1769873803723.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-1769873803723.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-1769873803723.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-1769873803723.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-1769873803723.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure></p>
<ul>
<li>我们可以利用 stata 的 fs 包读取所有名字</li>
<li>然后使用 local 直接储存名字进行循环</li>
<li>循环过程中可以嵌套一层循环，使得新文件按照顺序命名</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">==============================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="err">配置路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="o">==============================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="s2">&#34;F:\数据合集\刑事案件&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">outpath</span><span class="w"> </span><span class="s2">&#34;F:\数据合集\刑事案件简洁&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cd</span><span class="w"> </span><span class="s2">&#34;`path&#39;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">fs</span><span class="w"> </span><span class="s2">&#34;*.csv&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="o">==============================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="err">手动生成</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="err">文件列表到</span><span class="w"> </span><span class="k">local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="o">==============================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="s2">&#34; 080hfjsviunvohos.csv 749baig9gvbblcn.csv     97sytdv97goushd.csv 08cdhas0hvihikd.csv 7839yhcudaboce.csv      98ya08chiahnicn.csv 0s87d0hvcinowbv.csv 788tgd9cayh0c-9.csv 9a7gtdc97g08a0a.csv 1368bcohucg970.csv 797fshonlsnlfu98.csv 9f79sghuvjksbklk.csv 236797rbvlsbvoo.csv 79d7goadbco9hki.csv 9s7fhosivnlsnlnffr.csv 2489ndsujbovbo.csv 79s7dhnofnvlbns.csv a97dyc8udv8+hds9.csv 28638bvbsa7f93.csv 80sdhv08uisnvoh.csv i7sdhvu9hbosdv8.csv 2937hvoushcv8h.csv 89hdoshvoinsnnlj.csv oa7gc7agbkd78ad.csv 4689578yhkjsbd.csv 89s0fjisn7vgiskub.csv oc8ahhc89ha98g.csv 4790r8hvobosh7.csv 8y08h0chaicnil8o.csv os8dvyh089shdvi.csv 4792794bvoshc8.csv 94573hvsoidhv9y.csv s8oyvf08s09vu08.csv 479hu5nnv89007.csv 9473hgnvov9h7s.csv      u8ca0hc80ha00a.csv 4927bvogf92h011.csv 97atcg97ga0hc08.csv ughdso8h98989.csv 739g4foh8hv991.csv 97sgvc98dshv08.csv &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="o">==============================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="err">循环处理每个文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="o">==============================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="err">初始化计数器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="err">循环处理每个文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">foreach</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">di</span><span class="w"> </span><span class="s2">&#34;Processing file `i&#39;: `f&#39;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="err">导入</span><span class="w"> </span><span class="n">CSV</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">delimited</span><span class="w"> </span><span class="s2">&#34;`f&#39;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">varnames</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">encoding</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="err">数据清洗</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="err">处理部分</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="err">保存为数字顺序的</span><span class="w"> </span><span class="n">DTA</span><span class="w"> </span><span class="err">文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">save</span><span class="w"> </span><span class="s2">&#34;`outpath&#39;/`i&#39;.dta&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="err">计数器</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">local</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="匹配速度的优化">匹配速度的优化</h3>
<p>正常匹配，应该是将 119 个 txt 转化的 dta 匹配，嵌套循环匹配到 ans 1-ans 83 上去。</p>
<p>如果直接嵌套循环匹配，可能需要 4 到 5 天。</p>
<p>匹配耗时过长的原因在于每一次嵌套循环的文件读取时间太长了，而且不同文件之间有重复值。</p>
<p>建议先将 119 个 dta 文件使用 <code>append</code> 命令纵向匹配到一起，然后循环匹配到 ans 1 到 ans 83 上去，这样最多只需要 2 天即可完成全部匹配。
​</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #7d637a; background-color: #f6edf5; border-color: #f1e4f0;">
&#x1F4AC<b> 备注：办公室电脑是 stata MP 版本，这个版本的特性是“计算速度根据电脑的核来分配资源”。目前 cpu 有足足 16 核，个人处理过的最大量峰值是 60 g。基本没有问题，只需要耐心等待处理过程中的卡顿。</b>
</div>
<h2 id="dta-数据的清洗">dta 数据的清洗</h2>
<h3 id="常用文本处理函数">常用文本处理函数</h3>
<h4 id="去除空格">去除空格</h4>
<p>例如裁判长（法官）变量，会出现以下情况 <code>四川 大学</code>， <code>四川大学</code>，<code>四 川 大 学</code>。</p>
<p>不同网站的空格符号并不相同，建议使用以下函数：</p>
<p> * 移除所有特殊字符，包括不可见字符、空白和标点符号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> replace judge_fin = ustrregexra(法官名字变量, &#34;[^\p{L}\p{N}]+&#34;, &#34;&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="筛选特定字符">筛选特定字符</h4>
<p>如果变量中含有特定字符则保留</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">keep</span> <span class="k">if</span> <span class="n">strpos</span><span class="p">(</span><span class="k">var</span><span class="p">,</span> <span class="s2">&#34;民初&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果有两个变量，例如一个是规范的省份变量 a（四川省，内蒙古自治区），另外一个是不规范的省变量 b（四川，内蒙古）。如果要判断 a 变量是否包含了 b 变量，则可以使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gen localed = strpos(a, b) &gt; 0
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="去除特殊字符">去除特殊字符</h4>
<p>Ans 1 到 ans 83 的文本变量夹杂着各种非中文符号，可以使用以下函数去除：</p>
<p>以下是个人筛选出的乱码符号。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #7d637a; background-color: #f6edf5; border-color: #f1e4f0;">
&#x1F4AC<b> 备注：为什么要坚持排除法，而不选择只保留中文字符？ 因为个人尝试时，发现部分中文变量会因此变成乱码。</b>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 定义需要移除的符号列表（包括空格）  
</span></span><span class="line"><span class="cl">local symbols &#34;ⅩⅩⅩ Ｘ ? ; ；， 《 》 ． ＋ （ ） ( ) &amp; # 1 2 3 4 5 6 7 8 9 0 &amp; A-Z a-z ；？ ＊ ︰ ++  .   XX XXX   ______   ` - +  BRR H imestimes jzwjzwnjzwnjzwjzwnjzwnjzwnjzwjzwjzwjzwnjzwnjzwnjzwjzwnjzwnj jzwnjzwjzwjzwnjzwnjzwnjzwnjzwnjzwjzwjzwjzwnjzwjzwnjzwjzwj spemsp sp emsp ；； *  XX XXX Ｘ ＸＸＸ&#34;  
</span></span><span class="line"><span class="cl">​  
</span></span><span class="line"><span class="cl">* 遍历符号列表并移除每个符号及空格  
</span></span><span class="line"><span class="cl">foreach s of local symbols {  
</span></span><span class="line"><span class="cl">    replace judge_fin = subinstr(judge_fin, &#34;`s&#39;&#34;, &#34;&#34;, .)  
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="论文标签">论文标签</h4>
<p>有些时候，stata 数据只有变量名，同时另外有一个 excel 表格储存 label 值。
如何读取 excel 然后自动批量生成 <code>labal vars name</code> 呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="err">导入</span><span class="w"> </span><span class="n">Excel</span><span class="w"> </span><span class="err">对照表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">clear</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">import</span><span class="w"> </span><span class="n">excel</span><span class="w"> </span><span class="s2">&#34;基本情况代码对照表.xlsx&#34;</span><span class="p">,</span><span class="w"> </span><span class="o">///</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sheet</span><span class="p">(</span><span class="s2">&#34;支出1编码对照&#34;</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">rename</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">varname</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">rename</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">varlabel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="w"> </span><span class="err">生成命令（注意</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="n">quotes</span><span class="err">）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;label variable &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">varname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&#34; `&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">`</span><span class="s2">&#34;&#34;&#34;&#39; + varlabel + `&#34;&#34;&#34;</span><span class="s1">&#39; + &#34;&#39;</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">outsheet cmd using &#34;</span><span class="err">变量标签命令</span><span class="p">.</span><span class="n">txt</span><span class="s2">&#34;, noquote replace
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这样就会生成一个文件，储存所有 stata 对应的标签化命令。</p>
<blockquote>
<p>一切代码在自动化和透明度都有个取舍，个人比较偏好这种有中间产物的流程，便于检查和修正。</p>
</blockquote>
<h3 id="正则表达式提取">正则表达式提取</h3>
<h4 id="字符筛选">字符筛选</h4>
<p>以裁判长文本变量为例子，</p>
<p>明明变量应该是一个名字，结果出现了一个段落</p>
<blockquote>
<p>张三人民委托、张三于 2014 年进行审判、张三人民审判员进行裁决、张三代理裁判长进行庭审、张三李四熟记员进行开庭&hellip;&hellip;</p>
</blockquote>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp" title="再举例子——法院变量" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113210847789.webp" data-sub-html="<h2> </h2><p>再举例子——法院变量</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113210847789.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113210847789.webp" />
    </a><figcaption class="image-caption">再举例子——法院变量</figcaption>
    </figure>
换而言之，正确的文本字符应该是特定词汇的前面几个字。</p>
<p>先使用字符长度筛选例子，查看文本格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="o">*</span><span class="err">列出字符长度大于</span><span class="mi">14</span><span class="err">的变量行</span>  
</span></span><span class="line"><span class="cl"> <span class="n">list</span> <span class="k">var</span> <span class="k">if</span> <span class="n">ustrlen</span><span class="p">(</span><span class="n">judge_fin</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">14</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后根据情况<strong>只保留特定字符</strong>。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #a94442; background-color: #f2dede; border-color: #ebccd1;">
&#x26D4<b> 警告：注意顺序！</b>
</div>
<blockquote>
<p>例如有以下组合</p>
<p>张三<strong>于</strong> 2014 年进行庭审</p>
<p>张三<strong>代理</strong>审判长<strong>于</strong> 2014 年进行庭审</p>
<p>在该变量包含&quot;庭审&quot;两个字时，我们应该先都保留“于”以前的字符，再保留&quot;代理&quot;以前的字符。</p>
<p>条件筛选最好找两个字的特征词，这样叫“于庭审”的法官名字几乎不可能出现。</p>
</blockquote>
<p>个人使用的顺序，仅供参考：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;人民陪审员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;人民陪审员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;审判员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;审判员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;独任.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;独任&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;陪审员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;陪审员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;代理.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;代理&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;书记员.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;书记员&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;助理.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;助理&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;审判长.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;审判长&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;人民.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;人民&#34;) &gt; 0  
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;二.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;年&#34;) &gt; 0   
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;适用.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;适用&#34;) &gt; 0   
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;于.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;开庭&#34;) &gt; 0   
</span></span><span class="line"><span class="cl"> replace judge_fin = ustrregexra(judge_fin, &#34;对.*&#34;, &#34;&#34;) if  strpos(judge_fin, &#34;审理&#34;) &gt; 0 
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于爬虫有时候遇上网站加密，爬虫结果是 <code>陈*</code>,，完成以上清洗后只剩下 <code>陈</code>，删除单个字符行的函数命令是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> *删除只有一个字的，例如本来是*陈  
</span></span><span class="line"><span class="cl"> drop if ustrregexm(judge_fin, &#34;^[\p{Han}]$&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="数字提取">数字提取</h4>
<p>例如数据显示 <code>2.34435元</code>（需要是字符串变量），我们只想单独提取数字，可以使用以下代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">gen</span> <span class="n">num_var</span> <span class="o">=</span> <span class="o">.</span>  
</span></span><span class="line"><span class="cl"> <span class="n">replace</span> <span class="n">num_var</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">regexs</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">regexm</span><span class="p">(</span><span class="n">str_var</span><span class="p">,</span> <span class="s2">&#34;([0-9]+\.[0-9]+|[0-9]+)&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>顺便一提，如果没有 <code>real(regexs(1))</code> 这个参数则表示判断，只会返回 0 和 1，代表不符合或者符合格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">replace</span> <span class="n">num_var</span> <span class="o">=</span>  <span class="n">regexm</span><span class="p">(</span><span class="n">str_var</span><span class="p">,</span> <span class="s2">&#34;([0-9]+\.[0-9]+|[0-9]+)&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dta-时间修正">dta 时间修正</h2>
<p>在师门的招投标中，很多时间格式是混乱的。</p>
<p>例如标准的两种：
<code>2019-12-31 09:00:00</code>、
<code> 2019/12/30 09:30</code></p>
<p>但是也会出现 <code>20220516 09:30:00</code>、<code>2022051609:30:00</code>、<code>2022051609:30</code></p>
<p>例如缺少秒、月份位置写成 4 而不是 04。</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250123143246038.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250123143246038.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250123143246038.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure></p>
<p>下面的代码集中处理了这套时间编码。</p>
<p>一些中文符号转英文的预处理。</p>
<p>在日期和时间之间没有空格时（例如 <code>2022051609:30:00</code>），如果范围在对应年月内（比如 0-31）则优先取两位数，超过范围了则取前面的个位数。</p>
<p>最后兼容各种格式的时间提取。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*-----------------------------------------
</span></span><span class="line"><span class="cl">  日期提取转换方案（紧凑格式增强版）
</span></span><span class="line"><span class="cl">  版本：2.6
</span></span><span class="line"><span class="cl">  最后更新：2024-06-27
</span></span><span class="line"><span class="cl">-----------------------------------------*/
</span></span><span class="line"><span class="cl">version 17
</span></span><span class="line"><span class="cl">clear all
</span></span><span class="line"><span class="cl">set more off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">use &#34;F:\桌面\test.dta&#34;, clear
</span></span><span class="line"><span class="cl">keep time
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*        预处理阶段（增强）
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">// 基础清理
</span></span><span class="line"><span class="cl">replace time = ustrtrim(time)
</span></span><span class="line"><span class="cl">replace time = subinstr(time, char(92), &#34;-&#34;, .)
</span></span><span class="line"><span class="cl">replace time = subinstr(time, &#34;：&#34;, &#34;:&#34;, .) 
</span></span><span class="line"><span class="cl">replace time = subinstr(time, &#34; &#34;, &#34;&#34;, .)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      新增紧凑格式识别模块
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">// 识别YYYYMMDD-格式（核心改进）
</span></span><span class="line"><span class="cl">gen str8 compact_date = &#34;&#34;
</span></span><span class="line"><span class="cl">replace compact_date = substr(time, 1, 8) ///
</span></span><span class="line"><span class="cl">    if ustrregexm(time, &#34;^\d{8}-&#34;)  // 严格匹配8位数字+连字符格式
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 分离紧凑格式数据
</span></span><span class="line"><span class="cl">preserve
</span></span><span class="line"><span class="cl">keep if compact_date != &#34;&#34;
</span></span><span class="line"><span class="cl">gen date_stata = date(compact_date, &#34;YMD&#34;)
</span></span><span class="line"><span class="cl">format date_stata %tdCCYY-NN-DD
</span></span><span class="line"><span class="cl">tempfile compact
</span></span><span class="line"><span class="cl">save `compact&#39;
</span></span><span class="line"><span class="cl">restore
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 处理非紧凑格式数据
</span></span><span class="line"><span class="cl">keep if compact_date == &#34;&#34;
</span></span><span class="line"><span class="cl">drop compact_date
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      原有处理流程（优化）
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">// 统一分隔符处理
</span></span><span class="line"><span class="cl">foreach s in &#34;.&#34; &#34;_&#34; &#34;/&#34; {
</span></span><span class="line"><span class="cl">    replace time = subinstr(time, &#34;`s&#39;&#34;, &#34;-&#34;, .)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 日期部分提取
</span></span><span class="line"><span class="cl">gen str50 date_part = ustrregexs(1) if ustrregexm(time, &#34;(\d{4}-\d{1,2}-\d{2,})[^\d]&#34;)
</span></span><span class="line"><span class="cl">replace date_part = time if missing(date_part)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 智能日期处理
</span></span><span class="line"><span class="cl">gen str4 year = ustrregexs(1) if ustrregexm(date_part, &#34;^(\d{4})-\d+&#34;)
</span></span><span class="line"><span class="cl">gen str2 month = ustrregexs(1) if ustrregexm(date_part, &#34;-(\d{1,2})-&#34;)
</span></span><span class="line"><span class="cl">gen str5 raw_day = ustrregexs(1) if ustrregexm(date_part, &#34;-(\d+)$&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">replace month = cond(strlen(month) == 1, &#34;0&#34; + month, month)
</span></span><span class="line"><span class="cl">replace month = &#34;12&#34; if real(month) &gt; 12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gen str2 day = substr(raw_day,1,2)
</span></span><span class="line"><span class="cl">replace day = substr(day,1,1) if real(day) &gt; 31
</span></span><span class="line"><span class="cl">replace day = &#34;31&#34; if real(day) &gt; 31
</span></span><span class="line"><span class="cl">replace day = &#34;0&#34; + day if real(day) &lt; 10 &amp; strlen(day) == 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">replace date_part = year + &#34;-&#34; + month + &#34;-&#34; + day
</span></span><span class="line"><span class="cl">drop year month raw_day day
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gen date_stata = date(date_part, &#34;YMD&#34;)
</span></span><span class="line"><span class="cl">replace date_stata = date(ustrregexra(time, &#34;[^0-9]&#34;, &#34;&#34;), &#34;YMD&#34;) if missing(date_stata)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      合并处理结果
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">append using `compact&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">*      后处理与验证
</span></span><span class="line"><span class="cl">*===============================
</span></span><span class="line"><span class="cl">format date_stata %tdCCYY-NN-DD
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="提醒">提醒</h3>
<p>建议先将 stata 数据导出为 csv 格式。</p>
<p>最大的问题是<strong>乱码</strong>。</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250113211041112.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250113211041112.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250113211041112.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure>
csv 乱码了。因为提取的 txt 不是 utf 8 格式。</p>
<div style="padding: 15px; border: 1px solid transparent; border-color: transparent; margin-bottom: 20px; border-radius: 4px; color: #8a6d3b;; background-color: #fcf8e3; border-color: #faebcc;">
&#x1F628<b> 注意：一定要保证CSV 文件默认格式刷 UTF-8 ，然后进行处理。</b>
</div>
<h2 id="python-例子--提取上诉法官过去和现在的特征均值">Python 例子 ： 提取上诉法官过去和现在的特征均值</h2>
<p>例子 3 是逐行匹配，但是这样处理实在是太慢了。</p>
<p>现在我想要这样处理：</p>
<p>提取法官经历上诉前的 20 个案子，然后求罚款均值；同时提取法官经历上诉后的 20 个案子，然后求罚款的均值。</p>
<p>个人设计的算法逻辑如下：</p>
<ul>
<li>按照法院-法官的组合对数据进行分组。</li>
<li>每个数据都有初审到终审的时间，形成时间戳，并且每一行应该识别一系列时间中的最早时间和最晚时间。</li>
<li>当最早时间不等于最晚时间时，这条数据就是主干数据。</li>
<li>在每个组别内，只保留满足条件的样本。</li>
<li>在主干数据周围，当在主干数据最早数据之前还有 10 个案子，在主干数据之后也还有 10 个案子，最终只保留这 21 条数据。</li>
<li>如果一个组别同时有多个案子，则都保留满足要求的样本。</li>
<li>给满足周围存在对应数量案子的主干数据生成变量 a，标识为 1。</li>
<li>生成上诉前变量和上诉后变量，求数量对应案子的均值。</li>
</ul>
<div class="details admonition note">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>分解代码<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">为了更好地利用 ai，实际上这个算法我是拆成了两步。第一部分是筛选满足要求的所有样本；第二部是在满足要求的主干数据（a=1）处计算前后案件的均值。最周再整合两部分的代码。</div>
        </div>
    </div>
<p>我最终多设置了一个参数，关于主干案件周围需要有多少案子才保留。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 参数配置</span>
</span></span><span class="line"><span class="cl"><span class="n">input_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\PC\Desktop\hzp_project_re\re_论文开始\最终面板数据\去极端值交通民事上诉样本.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\PC\Desktop\hzp_project_re\re_论文开始\最终面板数据\去极端值交通民事上诉样本_论文去0_45_民诉样本.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">before_n</span> <span class="o">=</span> <span class="mi">45</span>  <span class="c1"># 保留之前记录的条数</span>
</span></span><span class="line"><span class="cl"><span class="n">after_n</span> <span class="o">=</span> <span class="mi">45</span>   <span class="c1"># 保留之后记录的条数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 时间字段配置</span>
</span></span><span class="line"><span class="cl"><span class="n">time_columns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m1_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m1_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m2_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m2_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m3_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m3_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;m4_jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;m4_jud_month&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_timestamps</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;提取每行的时间戳（最早和最晚时间）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_columns</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">year</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="n">month</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">time_columns</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">month</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_main_case</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;判断是否为主干数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m1_judge_am&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m2_judge_am&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m1_judge_am&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m3_judge_am&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m1_judge_am&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m4_judge_am&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m2_judge_am&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m3_judge_am&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m2_judge_am&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m4_judge_am&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m3_judge_am&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;m4_judge_am&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">filter_valid_judge</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;过滤有效金额（非0非空）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">())]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_means</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">main_case_idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    计算主干数据的 judge_sum, bf_judge_sum 和 af_judge_sum（均排除0值和空值）
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="n">extract_timestamps</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_case_idx</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">min_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 计算judge_sum</span>
</span></span><span class="line"><span class="cl">    <span class="n">judge_data</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">main_case_idx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">valid_judge</span> <span class="o">=</span> <span class="n">filter_valid_judge</span><span class="p">(</span><span class="n">judge_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_case_idx</span><span class="p">,</span> <span class="s1">&#39;judge_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_judge</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_judge</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 计算bf_judge_sum</span>
</span></span><span class="line"><span class="cl">    <span class="n">bf_cond</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">main_case_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">valid_bf</span> <span class="o">=</span> <span class="n">filter_valid_judge</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">bf_cond</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_case_idx</span><span class="p">,</span> <span class="s1">&#39;bf_judge_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_bf</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_bf</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 计算af_judge_sum</span>
</span></span><span class="line"><span class="cl">    <span class="n">af_cond</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">main_case_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">valid_af</span> <span class="o">=</span> <span class="n">filter_valid_judge</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">af_cond</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main_case_idx</span><span class="p">,</span> <span class="s1">&#39;af_judge_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_af</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_af</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_group</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;处理单个分组并生成特征&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建新列的 DataFrame</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_columns</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">before_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_count_tiao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_total_chars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_clause_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">after_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_count_tiao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_total_chars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_columns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_clause_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;judge_sum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;bf_judge_sum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;af_judge_sum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 将新列一次性添加到 group 中</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_columns_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">group</span><span class="p">,</span> <span class="n">new_columns_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 筛选主干数据</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_cases</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">is_main_case</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">main_cases</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">main_cases</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="n">extract_timestamps</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_time</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">max_time</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">group</span> <span class="o">=</span> <span class="n">calculate_means</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取有效上下文数据</span>
</span></span><span class="line"><span class="cl">        <span class="n">before_data</span> <span class="o">=</span> <span class="n">filter_valid_judge</span><span class="p">(</span><span class="n">group</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">after_data</span> <span class="o">=</span> <span class="n">filter_valid_judge</span><span class="p">(</span><span class="n">group</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;jud_year&#39;</span><span class="p">,</span> <span class="s1">&#39;jud_month&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 填充前向特征</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">before_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">before_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">row_data</span> <span class="o">=</span> <span class="n">before_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_count_tiao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;count_tiao&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_total_chars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;total_chars&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;bf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_clause_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;clause_count&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 填充后向特征</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">after_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">after_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">row_data</span> <span class="o">=</span> <span class="n">after_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_judge_am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;judge_am&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_count_tiao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;count_tiao&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_total_chars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;total_chars&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;af_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_clause_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;clause_count&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;成功加载数据：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">条&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;数据加载失败：</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">final_dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;处理进度&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">court</span><span class="p">,</span> <span class="n">judge</span><span class="p">),</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">final_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_group</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_dfs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 结果验证</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_data</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">生成主干数据：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">条&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;字段验证（应无0值和空值）：&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">main_data</span><span class="p">[[</span><span class="s1">&#39;judge_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;bf_judge_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;af_judge_sum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>以上代码如果不是在 jupyter 环境中运行而是在 pycharm 环境中运行，需要调整下输入参数的位置。</p>
</blockquote>
<h2 id="一些可以快速得到的裁判文书变量">一些可以快速得到的裁判文书变量</h2>
<ul>
<li>工作经验：第一次出现的时间和最后一次出现的时间段</li>
<li>共同案件：在样本中一共处理了多少案件</li>
<li>累计案件：这是目前处理的第几起案件。由于样本是以月为单位，累计计数应当是1、1、3、3、5、6&hellip;&hellip;</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 生成唯一行号 id
</span></span><span class="line"><span class="cl">gen id = _n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 确保数据按法院、法官、年份、月份、案件顺序排序
</span></span><span class="line"><span class="cl">sort court_name judge_fin jud_year jud_month id
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 创建案件计数变量（每一行默认计数为 1）
</span></span><span class="line"><span class="cl">gen case_count = 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 按法院和法官分组，并对案件计数进行累计
</span></span><span class="line"><span class="cl">bysort court_name judge_fin (jud_year jud_month): gen cumulative_count = sum(case_count)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 修正为同月累计数相同
</span></span><span class="line"><span class="cl">bysort court_name judge_fin jud_year jud_month (cumulative_count): replace cumulative_count = cumulative_count[_N]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 转换年份和月份为单一时间点（以月份为单位）
</span></span><span class="line"><span class="cl">gen time = jud_year * 12 + jud_month
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 计算首次时间点（每个法官在某法院处理第一个案件的时间）
</span></span><span class="line"><span class="cl">bysort court_name judge_fin (jud_year jud_month): gen first_time = time[1]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 计算工作经验（单位：月份）
</span></span><span class="line"><span class="cl">gen work_experience_months = time - first_time + 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* 删除不需要的临时变量
</span></span><span class="line"><span class="cl">drop id case_count time first_time
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">egen combo_count = count(court_name + judge_fin), by(court_name judge_fin)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="python-例子-案件积压量">Python 例子 ：案件积压量</h2>
<p>在裁判文书中有两个时间，案件判决时间( jud 开头)和案件立案( acc 开头)时间。</p>
<p>案件积压量是指立案时间早于当前年月，判决年饭晚于当前年份的所有案件。这种涉及跨行变量识别处理的操作就是 stata 的弱点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_backlog</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 构造时间字段（以月份为单位）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;acc_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;acc_year&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;acc_month&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;jud_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;jud_year&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;jud_month&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化 backlog 列</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;backlog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 按法院+法官分组处理</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;court_name&#39;</span><span class="p">,</span> <span class="s1">&#39;judge_fin&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;共有分组数量：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 遍历每组</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">court</span><span class="p">,</span> <span class="n">judge</span><span class="p">),</span> <span class="n">group_df</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;Processing court-judge groups&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">idx</span> <span class="o">=</span> <span class="n">group_df</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">jud_times</span> <span class="o">=</span> <span class="n">group_df</span><span class="p">[</span><span class="s1">&#39;jud_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">acc_times</span> <span class="o">=</span> <span class="n">group_df</span><span class="p">[</span><span class="s1">&#39;acc_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 初始化 backlog 结果</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">backlog_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">jud_time_i</span> <span class="o">=</span> <span class="n">jud_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 积压条件：立案时间 &lt; 当前判决时间，且 其他案件的判决时间 &gt; 当前判决时间</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">backlog_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc_times</span> <span class="o">&lt;</span> <span class="n">jud_time_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">jud_times</span> <span class="o">&gt;</span> <span class="n">jud_time_i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">backlog_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">backlog_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 更新结果</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;backlog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backlog_counts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">处理完成，总耗时：</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 秒&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;读取数据中...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">encoding_errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;数据读取完成，共有 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> 条记录。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df_result</span> <span class="o">=</span> <span class="n">calculate_backlog</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;保存结果到：</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;保存完成。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 请根据你的环境修改输入输出路径</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">input_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\PC\Desktop\hzp_project_re\re_论文开始\案件积压\案件积压计算.csv&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\PC\Desktop\hzp_project_re\re_论文开始\案件积压\论文_案件积压计算.csv&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="stata-例子-法院-年份案件公开率">Stata 例子 ：法院-年份案件公开率</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">**********</span><span class="err">思路</span><span class="o">*************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">由于每年案件编号为
</span></span></span><span class="line"><span class="cl"><span class="cm">民初（2020）**号，**号按照顺序编号。
</span></span></span><span class="line"><span class="cl"><span class="cm">有可能样本只有1、3、5、7号，
</span></span></span><span class="line"><span class="cl"><span class="cm">通过极大似然法估计产生的“坦克公式”估计公开率（二战坦克缴获率）
</span></span></span><span class="line"><span class="cl"><span class="cm">最终计算每年每个法院对应的公开率
</span></span></span><span class="line"><span class="cl"><span class="cm">考虑去掉公开率低的法院（等同于去掉公开率低的地区）
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">**********</span><span class="err">变量说明</span><span class="o">*************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">case_num_str：裁判文书案号
</span></span></span><span class="line"><span class="cl"><span class="cm">court_name：法院名称
</span></span></span><span class="line"><span class="cl"><span class="cm">jud_year：判决年份
</span></span></span><span class="line"><span class="cl"><span class="cm">public_rate：公开率
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">**********</span><span class="err">参考文献</span><span class="o">*************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">1公式的提出，还有其他估计公开率的方法
</span></span></span><span class="line"><span class="cl"><span class="cm">Augmenting serialized bureaucratic data: the case of Chinese courts（2022，工作论文）
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">2应用例子
</span></span></span><span class="line"><span class="cl"><span class="cm">Suing the government under weak rule of law: Evidence from administrative litigation reform in China（2023，jpube）
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">case_num_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ustrregexs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ustrregexm</span><span class="p">(</span><span class="n">case_wid_str</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;民[^0-9]*([0-9]+)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">case_num_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ustrregexra</span><span class="p">(</span><span class="n">case_num_str</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;^0+&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">destring</span><span class="w"> </span><span class="n">case_num_str</span><span class="p">,</span><span class="w"> </span><span class="n">gen</span><span class="p">(</span><span class="n">case_num</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">drop</span><span class="w"> </span><span class="n">case_num_str</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="n">case_wid_str</span><span class="w"> </span><span class="n">case_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bysort</span><span class="w"> </span><span class="n">court_name</span><span class="w"> </span><span class="n">jud_year</span><span class="p">:</span><span class="w"> </span><span class="n">egen</span><span class="w"> </span><span class="n">max_case_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">case_num</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bysort</span><span class="w"> </span><span class="n">court_name</span><span class="w"> </span><span class="n">jud_year</span><span class="p">:</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="n">case_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_N</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="n">max_case_N</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bysort</span><span class="w"> </span><span class="n">court_name</span><span class="w"> </span><span class="n">jud_year</span><span class="p">:</span><span class="w"> </span><span class="n">egen</span><span class="w"> </span><span class="n">max_case_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">case_count</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">case_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_case_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">public_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_case_N</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">max_case_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="n">max_case_N</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">sum</span><span class="w"> </span><span class="n">public_rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">keep</span><span class="w"> </span><span class="n">court_name</span><span class="w"> </span><span class="n">jud_year</span><span class="w"> </span><span class="n">public_rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">duplicates</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="n">court_name</span><span class="w"> </span><span class="n">jud_year</span><span class="p">,</span><span class="w"> </span><span class="k">force</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">duplicates</span><span class="w"> </span><span class="n">report</span><span class="w">  </span><span class="n">court_name</span><span class="w"> </span><span class="n">jud_year</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="python-例子大型数据的匹配">Python 例子：大型数据的匹配</h2>
<p>现在比较流行工商注册数据和其他企业数据库的匹配，几乎就是 5000 万条有效数据起步。</p>
<p>Stata 的 <code>merge</code> 命令在匹配时非常消耗内存，因为其临时副本的原因会轻松在内存损耗上翻倍。因此个人推荐都导出 <code>.csv</code> 文件使用 python 的 <code>duckdb</code>（<code>pandas</code> 匹配只是比 stata <code>merge</code> 略微好一点而已。）</p>
<p>下面这个例子就是 <code>duckdb</code> 的例子，代码作用和 stata 的 <code>merge m:1</code> 效果相同，但更优化内存：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">duckdb</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;DROP TABLE IF EXISTS using_tbl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;DROP TABLE IF EXISTS main_tbl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;DROP TABLE IF EXISTS merged&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># =====================</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 路径（按你自己实际路径改）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># =====================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MAIN_CSV</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;C:\Users\PC\Desktop\中国招投标\论文代码\回归数据.csv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">USING_CSV</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;C:\Users\PC\Desktop\中国招投标\论文代码\注册数据.csv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">OUT_CSV</span>  <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;C:\Users\PC\Desktop\中国招投标\论文代码\merged.csv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">DB_FILE</span>  <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;C:\Users\PC\Desktop\中国招投标\论文代码\merge.duckdb&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># =====================</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 连接 DuckDB（落盘，防 OOM）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># =====================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">con</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># （可选）限制内存，更稳</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;PRAGMA memory_limit=&#39;16GB&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;PRAGMA threads=8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;1️⃣ 读取 using 表（1.8 亿）&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">CREATE TABLE using_tbl AS
</span></span></span><span class="line"><span class="cl"><span class="s2">SELECT *
</span></span></span><span class="line"><span class="cl"><span class="s2">FROM read_csv_auto(
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#39;</span><span class="si">{</span><span class="n">USING_CSV</span><span class="si">}</span><span class="s2">&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">    SAMPLE_SIZE=1000000,
</span></span></span><span class="line"><span class="cl"><span class="s2">    parallel=true
</span></span></span><span class="line"><span class="cl"><span class="s2">)
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;2️⃣ 读取 main 表（2000 万）&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">CREATE TABLE main_tbl AS
</span></span></span><span class="line"><span class="cl"><span class="s2">SELECT *
</span></span></span><span class="line"><span class="cl"><span class="s2">FROM read_csv_auto(
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#39;</span><span class="si">{</span><span class="n">MAIN_CSV</span><span class="si">}</span><span class="s2">&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">    SAMPLE_SIZE=500000,
</span></span></span><span class="line"><span class="cl"><span class="s2">    parallel=true
</span></span></span><span class="line"><span class="cl"><span class="s2">)
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;3️⃣ LEFT JOIN（m:1）&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">CREATE TABLE merged AS
</span></span></span><span class="line"><span class="cl"><span class="s2">SELECT
</span></span></span><span class="line"><span class="cl"><span class="s2">    m.*,
</span></span></span><span class="line"><span class="cl"><span class="s2">    u.*
</span></span></span><span class="line"><span class="cl"><span class="s2">FROM main_tbl m
</span></span></span><span class="line"><span class="cl"><span class="s2">LEFT JOIN using_tbl u
</span></span></span><span class="line"><span class="cl"><span class="s2">ON m.credit_code = u.credit_code
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;4️⃣ 导出结果&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">COPY merged
</span></span></span><span class="line"><span class="cl"><span class="s2">TO &#39;</span><span class="si">{</span><span class="n">OUT_CSV</span><span class="si">}</span><span class="s2">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">(HEADER, DELIMITER &#39;,&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;✅ 完成&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="python-例子-案件类型的分类">python 例子 ：案件类型的分类</h2>
<p>参考了论文《<a href="https://academic.oup.com/restud/advance-article/doi/10.1093/restud/rdaf066/8220859" target="_blank" rel="noopener noreffer ">Women in the Courtroom: Technology and Justice</a>》。裁判文书案件类型太多怎么办？通过LDA模型聚类到50个案件类型。</p>
<p>此处代码是假设你已经有了一个案件面板（<code>.csv</code>） 案件号-案件类型名称。接下来可以通过机器学习分类简化为 50 个案件类型。</p>
<p>应用例子可以参考 <a href="https://blog.huaxiangshan.com/zh-cn/posts/lda_gephi/" target="_blank" rel="noopener noreffer ">LDA 主题模型与 Gephi 可视化</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ast</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jieba</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">corpora</span><span class="p">,</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0. 全局设置</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 忽略警告</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jieba</span><span class="o">.</span><span class="n">setLogLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 初始化 jieba，避免在进度条中打印日志</span>
</span></span><span class="line"><span class="cl"><span class="n">jieba</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 用户可配置参数 (User Configurable Parameters)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置要生成的主题数量。请在此处修改主题数，例如 20, 50, 100 等。</span>
</span></span><span class="line"><span class="cl"><span class="n">NUM_TOPICS</span> <span class="o">=</span> <span class="mi">50</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># 设置用于过滤低频词的最小出现次数。例如，no_below=100 表示只保留出现次数 &gt;= 100 的词汇。</span>
</span></span><span class="line"><span class="cl"><span class="n">MIN_WORD_COUNT</span> <span class="o">=</span> <span class="mi">100</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># LDA 训练的迭代次数 (Passes)</span>
</span></span><span class="line"><span class="cl"><span class="n">NUM_PASSES</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 文件路径设置 (文件名为动态生成，包含主题数量)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">input_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;/root/案件类型.csv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;/root/案件类型_</span><span class="si">{}</span><span class="s2">类别结果.csv&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NUM_TOPICS</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">topic_words_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;/root/主题</span><span class="si">{}</span><span class="s2">词汇.csv&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NUM_TOPICS</span><span class="p">)</span>       
</span></span><span class="line"><span class="cl"><span class="n">doc_topic_words_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;/root/文档主题词_</span><span class="si">{}</span><span class="s2">主题.csv&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NUM_TOPICS</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义常用且低区分度的停用词</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 目标是强制模型关注案件的主体名词（如：买卖、金融、商标、继承）</span>
</span></span><span class="line"><span class="cl"><span class="n">CHINESE_STOPWORDS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;纠纷&#39;</span><span class="p">,</span> <span class="s1">&#39;责任&#39;</span><span class="p">,</span> <span class="s1">&#39;案件&#39;</span><span class="p">,</span> <span class="s1">&#39;争议&#39;</span><span class="p">,</span> <span class="s1">&#39;纠纷案件&#39;</span><span class="p">,</span> <span class="s1">&#39;追偿&#39;</span><span class="p">,</span> <span class="s1">&#39;纠葛&#39;</span><span class="p">,</span> <span class="s1">&#39;诉讼&#39;</span><span class="p">,</span> <span class="s1">&#39;法律&#39;</span><span class="p">,</span> <span class="s1">&#39;与&#39;</span><span class="p">,</span> <span class="s1">&#39;及&#39;</span><span class="p">,</span> <span class="s1">&#39;的&#39;</span><span class="p">,</span> <span class="s1">&#39;是&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;一&#39;</span><span class="p">,</span> <span class="s1">&#39;二&#39;</span><span class="p">,</span> <span class="s1">&#39;三&#39;</span><span class="p">,</span> <span class="s1">&#39;四&#39;</span><span class="p">,</span> <span class="s1">&#39;等&#39;</span><span class="p">,</span> <span class="s1">&#39;其他&#39;</span><span class="p">,</span> <span class="s1">&#39;之&#39;</span><span class="p">,</span> <span class="s1">&#39;因&#39;</span><span class="p">,</span> <span class="s1">&#39;中&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 新增加的通用法律词汇，这些词汇在各类案件中都可能出现，降低了主题区分度</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;权&#39;</span><span class="p">,</span> <span class="s1">&#39;损害&#39;</span><span class="p">,</span> <span class="s1">&#39;赔偿&#39;</span><span class="p">,</span> <span class="s1">&#39;物&#39;</span><span class="p">,</span> <span class="s1">&#39;行为&#39;</span><span class="p">,</span> <span class="s1">&#39;权利&#39;</span><span class="p">,</span> <span class="s1">&#39;民事&#39;</span><span class="p">,</span> <span class="s1">&#39;确认&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;正在读取数据: </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> ...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1. 读取数据</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2. 清洗 type 字段</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">clean_type</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 移除所有非中文字符，确保只保留中文案由名称</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\u4e00-\u9fa5\s]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;[&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;]&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;&#39;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&#34;清洗数据&#34;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="s2">&#34;type_clean&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="n">clean_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3. 中文分词和停用词过滤</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;正在进行分词和停用词过滤...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cut_words_and_filter</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 分词</span>
</span></span><span class="line"><span class="cl">    <span class="n">words</span> <span class="o">=</span> <span class="n">jieba</span><span class="o">.</span><span class="n">lcut</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 过滤空词和停用词</span>
</span></span><span class="line"><span class="cl">    <span class="n">filtered_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHINESE_STOPWORDS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">filtered_words</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&#34;分词处理&#34;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="s2">&#34;words&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&#34;type_clean&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="n">cut_words_and_filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 过滤空文本</span>
</span></span><span class="line"><span class="cl"><span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&#34;words&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;有效文本数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">original_len</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">texts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&#34;words&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4. 构建字典和语料</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;构建字典和语料...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dictionary</span> <span class="o">=</span> <span class="n">corpora</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 过滤掉出现次数少于 MIN_WORD_COUNT 次的词汇</span>
</span></span><span class="line"><span class="cl"><span class="n">dictionary</span><span class="o">.</span><span class="n">filter_extremes</span><span class="p">(</span><span class="n">no_below</span><span class="o">=</span><span class="n">MIN_WORD_COUNT</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;生成语料&#34;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 5. LDA训练 (使用 LdaMulticore 加速)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">num_topics</span> <span class="o">=</span> <span class="n">NUM_TOPICS</span> <span class="c1"># 使用用户设置的主题参数</span>
</span></span><span class="line"><span class="cl"><span class="n">passes</span> <span class="o">=</span> <span class="n">NUM_PASSES</span>    <span class="c1"># 使用用户设置的迭代次数参数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 自动设置核心数，使用所有核心 - 1</span>
</span></span><span class="line"><span class="cl"><span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;开始 LDA Multicore 训练 (主题数=</span><span class="si">{</span><span class="n">num_topics</span><span class="si">}</span><span class="s2">, 轮数=</span><span class="si">{</span><span class="n">passes</span><span class="si">}</span><span class="s2">, 核心数=</span><span class="si">{</span><span class="n">workers</span><span class="si">}</span><span class="s2">)...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 切换到 LdaMulticore，使用多核并行计算</span>
</span></span><span class="line"><span class="cl"><span class="n">lda</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LdaMulticore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">corpus</span><span class="o">=</span><span class="n">corpus</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">id2word</span><span class="o">=</span><span class="n">dictionary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_topics</span><span class="o">=</span><span class="n">num_topics</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">passes</span><span class="o">=</span><span class="n">passes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span> <span class="c1"># 使用多核心并行计算</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span>   <span class="c1"># 增大块大小以优化性能</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 6. 输出主题高频词</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">topn</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="n">topic_words</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_topics</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">topic_words</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">lda</span><span class="o">.</span><span class="n">show_topic</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">topn</span><span class="o">=</span><span class="n">topn</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_topic_words</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;topic&#34;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">topic_words</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;words&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wlist</span><span class="p">)</span> <span class="k">for</span> <span class="n">wlist</span> <span class="ow">in</span> <span class="n">topic_words</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">df_topic_words</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">topic_words_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8-sig&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已输出主题高频词到：</span><span class="si">{</span><span class="n">topic_words_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 7. 文本 → 主题映射（保证相同文本同主题，并输出主题词）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">text2topic</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">topic_list</span> <span class="o">=</span> <span class="p">[]</span> 
</span></span><span class="line"><span class="cl"><span class="n">doc_topic_words_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 存放每条文档对应主题的前 N 个词</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">正在进行文档主题预测...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># total=len(corpus) 确保 tqdm 正确计算进度</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">t_clean</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&#34;type_clean&#34;</span><span class="p">],</span> <span class="n">corpus</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;主题预测&#34;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">t_clean</span> <span class="ow">in</span> <span class="n">text2topic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">best_topic</span> <span class="o">=</span> <span class="n">text2topic</span><span class="p">[</span><span class="n">t_clean</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tp</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">get_document_topics</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 取概率最大的主题ID</span>
</span></span><span class="line"><span class="cl">            <span class="n">best_topic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">best_topic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 缓存结果</span>
</span></span><span class="line"><span class="cl">        <span class="n">text2topic</span><span class="p">[</span><span class="n">t_clean</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_topic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">topic_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_topic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">best_topic</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">doc_topic_words_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topic_words</span><span class="p">[</span><span class="n">best_topic</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">doc_topic_words_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用动态列名，例如 topic50</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;topic</span><span class="si">{</span><span class="n">NUM_TOPICS</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">topic_list</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="s2">&#34;topic_words&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc_topic_words_list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 8. 保存结果</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">output_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;words&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="n">output_columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8-sig&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;完成！已输出最终结果到：</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 9. 保存文档对应主题词 CSV</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 调整列名以保持清晰</span>
</span></span><span class="line"><span class="cl"><span class="n">data_doc_topic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&#34;type_clean&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;topic</span><span class="si">{</span><span class="n">NUM_TOPICS</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;topic_words&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">data_doc_topic</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;type_clean&#34;</span><span class="p">,</span> <span class="s2">&#34;topic_id&#34;</span><span class="p">,</span> <span class="s2">&#34;topic_words&#34;</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="n">data_doc_topic</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">doc_topic_words_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8-sig&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文档主题词已输出到：</span><span class="si">{</span><span class="n">doc_topic_words_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="python-例子-基于姓名预测性别">Python 例子 ：基于姓名预测性别</h2>
<p>由于法官没有公布性别，可以通过姓名预测性别。Python 包调用即可。参考论文《<a href="https://academic.oup.com/restud/advance-article/doi/10.1093/restud/rdaf066/8220859" target="_blank" rel="noopener noreffer ">Women in the Courtroom: Technology and Justice</a>》，下面使用的是 <code>ngender</code> 包。</p>
<p>这个包也存在缺陷，使用的是贝叶斯估计训练的参数，因此假设名字字符是独立的。例如王胜男，每个字单独看起来偏男性，但是个典型女性名字，但是基于贝叶斯估计，这个包会将其识别为男性。</p>
<p>如果想要进一步做严谨，个人推荐了解一个 github 仓库<a href="https://github.com/jaaack-wang/gender-predictor" target="_blank" rel="noopener noreffer ">预测中文姓名的性别</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ngender</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load the CSV file</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;F:\桌面\性别预测测试\测试.csv&#39;</span><span class="p">)</span>  <span class="c1"># Replace with your actual CSV file name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to predict gender</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">predict_gender</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">ngender</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>  <span class="c1"># Returns (gender, probability)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Extract gender (&#39;male&#39;, &#39;female&#39;, or &#39;neutral&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>  <span class="c1"># Handle invalid names</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add predicted gender column</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;预测性别&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">predict_gender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Save the updated CSV</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;output.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Gender predictions added to &#39;output.csv&#39;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="描述统计">描述统计</h2>
<h3 id="环状图">环状图</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">aquarel</span> <span class="kn">import</span> <span class="n">load_theme</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加载并应用主题</span>
</span></span><span class="line"><span class="cl"><span class="n">theme</span> <span class="o">=</span> <span class="n">load_theme</span><span class="p">(</span><span class="s2">&#34;boxy_light&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">theme</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置中文字体</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STZhongsong&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 数据处理</span>
</span></span><span class="line"><span class="cl"><span class="n">types</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">top_types</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 颜色配置</span>
</span></span><span class="line"><span class="cl"><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FF6347&#39;</span><span class="p">,</span> <span class="s1">&#39;#4682B4&#39;</span><span class="p">,</span> <span class="s1">&#39;#008000&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="s1">&#39;#8B0000&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;#FFFF00&#39;</span><span class="p">,</span> <span class="s1">&#39;#9400D3&#39;</span><span class="p">,</span> <span class="s1">&#39;#FF1493&#39;</span><span class="p">,</span> <span class="s1">&#39;#00FA9A&#39;</span><span class="p">,</span> <span class="s1">&#39;#1E90FF&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建画布</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 绘制环状图</span>
</span></span><span class="line"><span class="cl"><span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_types</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">pctdistance</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">wedgeprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">colors</span><span class="o">=</span><span class="n">colors</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建自定义图例</span>
</span></span><span class="line"><span class="cl"><span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">)&#34;</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top_types</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">top_types</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">wedges</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">legend_labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span><span class="o">=</span><span class="s2">&#34;案件类型&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">loc</span><span class="o">=</span><span class="s2">&#34;center left&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加统计信息</span>
</span></span><span class="line"><span class="cl"><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.35</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.35</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;总样本数: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="se">\n</span><span class="s2">前10类型覆盖率: </span><span class="si">{</span><span class="n">top_types</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 调整布局</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;数量前10案件类型分布&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235548472.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250329235548472.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235548472.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235548472.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235548472.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235548472.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250329235548472.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure></p>
<h3 id="条状图">条状图</h3>
<p>优化了数字排列方式不重叠</p>
<p>规定了民初、再、终案号的排列顺序</p>
<p>使用了 python 包 <code>pip install aquarel</code> 优化了绘图风格。</p>
<p><a href="https://github.com/lgienapp/aquarel" target="_blank" rel="noopener noreffer ">Aquarel</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">mpl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置中文字体和解决负号显示问题</span>
</span></span><span class="line"><span class="cl"><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STZhongsong&#39;</span><span class="p">]</span>    <span class="c1"># 指定默认字体：解决plot不能显示中文问题</span>
</span></span><span class="line"><span class="cl"><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># 解决保存图像是负号&#39;-&#39;显示为方块的问题</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加载数据</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\Users\PC\Desktop\hzp_project_re\re_论文开始\最终面板数据\民事上诉样本.csv&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 从case_wid_str中提取案件类型</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;case_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;case_wid_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(民初|民终|民再)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 统计每种案件类型在不同法院级别的分布情况</span>
</span></span><span class="line"><span class="cl"><span class="n">distribution</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;court&#39;</span><span class="p">,</span> <span class="s1">&#39;case_type&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 只保留特定的法院级别，但只包括实际存在的法院级别</span>
</span></span><span class="line"><span class="cl"><span class="n">desired_courts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">existing_courts</span> <span class="o">=</span> <span class="p">[</span><span class="n">court</span> <span class="k">for</span> <span class="n">court</span> <span class="ow">in</span> <span class="n">desired_courts</span> <span class="k">if</span> <span class="n">court</span> <span class="ow">in</span> <span class="n">distribution</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">distribution</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">existing_courts</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 计算每个法院级别的总案件数</span>
</span></span><span class="line"><span class="cl"><span class="n">total_cases_per_court</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 计算比例</span>
</span></span><span class="line"><span class="cl"><span class="n">distribution_ratio</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">total_cases_per_court</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置图表大小</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义一个空列表用于底部高度</span>
</span></span><span class="line"><span class="cl"><span class="n">bottoms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">distribution_ratio</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 按照民初、民再、民终的顺序进行堆叠</span>
</span></span><span class="line"><span class="cl"><span class="n">case_types_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;民初&#39;</span><span class="p">,</span> <span class="s1">&#39;民再&#39;</span><span class="p">,</span> <span class="s1">&#39;民终&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">case_type</span> <span class="ow">in</span> <span class="n">case_types_order</span><span class="p">:</span>  <span class="c1"># 使用正序确保民初在最下面</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">case_type</span> <span class="ow">in</span> <span class="n">distribution</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">distribution_ratio</span><span class="o">.</span><span class="n">index</span><span class="p">)),</span> <span class="n">distribution_ratio</span><span class="p">[</span><span class="n">case_type</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottoms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">case_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 在每个条形图上方显示具体数量</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">distribution</span><span class="p">[</span><span class="n">case_type</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">text_y_position</span> <span class="o">=</span> <span class="n">bottoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">distribution_ratio</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">existing_courts</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">case_type</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 调整文本位置以避免重叠</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">case_type</span> <span class="o">==</span> <span class="s1">&#39;民再&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">text_y_position</span> <span class="o">+=</span> <span class="mi">2</span>  <span class="c1"># 向上移动</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">text_y_position</span> <span class="o">-=</span> <span class="mi">2</span>  <span class="c1"># 向下移动</span>
</span></span><span class="line"><span class="cl">            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">text_y_position</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 更新底部高度</span>
</span></span><span class="line"><span class="cl">        <span class="n">bottoms</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bottoms</span><span class="p">,</span> <span class="n">distribution_ratio</span><span class="p">[</span><span class="n">case_type</span><span class="p">])]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改x轴标签</span>
</span></span><span class="line"><span class="cl"><span class="n">court_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&#34;最高&#34;</span><span class="p">,</span> <span class="s2">&#34;高级&#34;</span><span class="p">,</span> <span class="s2">&#34;中级&#34;</span><span class="p">,</span> <span class="s2">&#34;基层&#34;</span><span class="p">,</span> <span class="s2">&#34;专门&#34;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_courts</span><span class="p">)])}</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_courts</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">court_labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加标题和标签</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;案件类型在不同法院级别的比例分布&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;法院级别&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;比例 (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&#34;案件类型&#34;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 显示图表</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235531039.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250329235531039.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235531039.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235531039.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235531039.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235531039.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250329235531039.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure></p>
<h3 id="均值中位数分布图">均值中位数分布图</h3>
<p>包含均值、中位数、累计比例</p>
<p>使用了参数名称映射</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">mpl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置中文字体和解决负号显示问题</span>
</span></span><span class="line"><span class="cl"><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STZhongsong&#39;</span><span class="p">]</span>    <span class="c1"># 指定默认字体：解决plot不能显示中文问题</span>
</span></span><span class="line"><span class="cl"><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># 解决保存图像是负号&#39;-&#39;显示为方块的问题</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 假设这是你的数据列与其中文名称的映射</span>
</span></span><span class="line"><span class="cl"><span class="n">var_names_zh</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;work_experience_years&#39;</span><span class="p">:</span> <span class="s1">&#39;工作年限（年）&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;work_experience_months&#39;</span><span class="p">:</span> <span class="s1">&#39;工作经历（月）&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;average_cases_per_month&#39;</span><span class="p">:</span> <span class="s1">&#39;平均处理案子数（月）&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加载数据</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\Users\PC\Desktop\hzp_project_re\re_论文开始\最终面板数据\民事上诉样本.csv&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 转换工作经历为年份</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;work_experience_years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;work_experience_months&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 计算平均一个月处理多少案子</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;average_cases_per_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cumulative_count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;work_experience_months&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_statistics</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;在给定的轴上添加平均数和中位数的标注&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mean_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">median_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 添加图例于右下角</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;均值: </span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;中位数: </span><span class="si">{</span><span class="n">median_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_percentage_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;在给定的轴上添加右侧的百分比轴&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">percentage</span> <span class="o">=</span> <span class="n">cumulative</span> <span class="o">/</span> <span class="n">cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># 将累计值转换为百分比</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax_percent</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax_percent</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">percentage</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;累计百分比&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax_percent</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;累计百分比 (%)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax_percent</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">trim_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">99.5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;返回给定百分比范围内的数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lower_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">upper_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">lower_quantile</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">upper_quantile</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;work_experience_years&#39;</span><span class="p">,</span> <span class="s1">&#39;work_experience_months&#39;</span><span class="p">,</span> <span class="s1">&#39;average_cases_per_month&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 使用中文名称</span>
</span></span><span class="line"><span class="cl">    <span class="n">var_zh</span> <span class="o">=</span> <span class="n">var_names_zh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;average_cases_per_month&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">trim_data</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 原始数据分布</span>
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&#34;skyblue&#34;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&#34;black&#34;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_zh</span><span class="si">}</span><span class="s1"> 分布图&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">add_statistics</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">data_to_plot</span><span class="p">)</span>  <span class="c1"># 添加平均数和中位数的标注</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 添加累计百分比轴</span>
</span></span><span class="line"><span class="cl">    <span class="n">add_percentage_axis</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">data_to_plot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235518600.webp" title="如图" data-thumbnail="/img/裁判文书清洗指南.zh-cn-20250329235518600.webp" data-sub-html="<h2> </h2><p>如图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235518600.webp"
            data-srcset="/img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235518600.webp, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235518600.webp 1.5x, /img/%e8%a3%81%e5%88%a4%e6%96%87%e4%b9%a6%e6%b8%85%e6%b4%97%e6%8c%87%e5%8d%97.zh-cn-20250329235518600.webp 2x"
            data-sizes="auto"
            alt="/img/裁判文书清洗指南.zh-cn-20250329235518600.webp" />
    </a><figcaption class="image-caption">如图</figcaption>
    </figure></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2025-01-13</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/zh-cn/posts/cpws_stata/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南" data-hashtags="Stata,Python"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-hashtag="Stata"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://blog.huaxiangshan.com/zh-cn/posts/cpws_stata/" data-title="裁判文书清洗指南" data-image="/img/裁判文书清洗指南.zh-cn-20250113205250946.webp"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/zh-cn/tags/stata/">Stata</a>,&nbsp;<a href="/zh-cn/tags/python/">Python</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/zh-cn/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/zh-cn/posts/econ_math/" class="prev" rel="prev" title="经济学的数学史"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>经济学的数学史</a>
            <a href="/zh-cn/posts/fzqy/" class="next" rel="next" title="《富种起源》：千年暗室，一灯即明">《富种起源》：千年暗室，一灯即明<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app">Giscus</a>.
            </noscript></div></article></div>
            </main><script>

(function() {
  console.log('[Music Player] Enhanced initialization script loaded');

  
  const CDN_SOURCES = [
    'https://cdn.jsdelivr.net/npm/',
    'https://unpkg.com/',
    'https://cdnjs.cloudflare.com/ajax/libs/'
  ];

  const APLAYER_CSS = 'aplayer@1.10.1/dist/APlayer.min.css';
  const APLAYER_JS = 'aplayer@1.10.1/dist/APlayer.min.js';
  const METING_JS = 'meting@2.0.1/dist/Meting.min.js';

  
  function safeHasMusicPlayers() {
    try {
      return document.querySelectorAll('meting-js').length > 0;
    } catch (e) {
      console.warn('[Music Player] Error checking for music players:', e);
      return false;
    }
  }

  function safeResourcesLoaded() {
    try {
      return typeof window.APlayer !== 'undefined' && typeof window.Meting !== 'undefined';
    } catch (e) {
      console.warn('[Music Player] Error checking resources:', e);
      return false;
    }
  }

  
  function loadResource(url, resourceType, retries = 2) {
    return new Promise((resolve, reject) => {
      const isCSS = resourceType === 'css';
      const isJS = resourceType === 'js';

      
      const existing = isCSS
        ? document.querySelector(`link[href*="${url.split('/').pop()}"]`)
        : document.querySelector(`script[src*="${url.split('/').pop()}"]`);

      if (existing) {
        console.log(`[Music Player] Resource already loaded: ${url}`);
        resolve();
        return;
      }

      const element = isCSS ? document.createElement('link') : document.createElement('script');

      if (isCSS) {
        element.rel = 'stylesheet';
        element.href = url;
      } else {
        element.src = url;
      }

      let attempts = 0;

      const attemptLoad = () => {
        attempts++;

        element.onload = () => {
          console.log(`[Music Player] Successfully loaded: ${url}`);
          resolve();
        };

        element.onerror = (err) => {
          console.warn(`[Music Player] Failed to load ${url} (attempt ${attempts}/${retries + 1})`);

          if (attempts <= retries) {
            
            const nextCDN = CDN_SOURCES.find(cdn => url.startsWith(cdn));
            if (nextCDN) {
              const nextUrl = url.replace(nextCDN, CDN_SOURCES[(CDN_SOURCES.indexOf(nextCDN) + 1) % CDN_SOURCES.length]);
              console.log(`[Music Player] Retrying with alternative CDN: ${nextUrl}`);
              if (isCSS) {
                element.href = nextUrl;
              } else {
                element.src = nextUrl;
              }
              setTimeout(attemptLoad, 500);
            } else {
              reject(err);
            }
          } else {
            reject(err);
          }
        };

        
        if (isCSS) {
          document.head.appendChild(element);
        } else {
          document.body.appendChild(element);
        }
      };

      attemptLoad();
    });
  }

  
  function loadDependencies() {
    console.log('[Music Player] Loading dependencies with fallback support...');

    
    const primaryCDN = CDN_SOURCES[0];

    return loadResource(primaryCDN + APLAYER_CSS, 'css', 1)
      .then(() => {
        console.log('[Music Player] APlayer CSS loaded');
        return loadResource(primaryCDN + APLAYER_JS, 'js', 1);
      })
      .then(() => {
        console.log('[Music Player] APlayer JS loaded');
        return loadResource(primaryCDN + METING_JS, 'js', 1);
      })
      .then(() => {
        console.log('[Music Player] All dependencies loaded successfully');
        return true;
      })
      .catch(async (err) => {
        console.error('[Music Player] Primary CDN failed, trying alternative CDNs:', err);

        
        for (let i = 1; i < CDN_SOURCES.length; i++) {
          try {
            const cdn = CDN_SOURCES[i];
            console.log(`[Music Player] Trying CDN: ${cdn}`);

            await loadResource(cdn + APLAYER_CSS, 'css', 0);
            await loadResource(cdn + APLAYER_JS, 'js', 0);
            await loadResource(cdn + METING_JS, 'js', 0);

            console.log('[Music Player] Successfully loaded from alternative CDN');
            return true;
          } catch (altErr) {
            console.warn(`[Music Player] CDN ${CDN_SOURCES[i]} failed:`, altErr);
            continue;
          }
        }

        console.error('[Music Player] All CDN attempts failed');
        return false;
      });
  }

  
  function initializePlayers() {
    try {
      if (!safeResourcesLoaded()) {
        console.error('[Music Player] Cannot initialize: dependencies not loaded');
        return false;
      }

      console.log('[Music Player] Initializing meting-js players...');
      let successCount = 0;
      let errorCount = 0;

      const players = document.querySelectorAll('meting-js');

      players.forEach(el => {
        try {
          if (el.hasAttribute('data-initialized')) {
            console.log('[Music Player] Player already initialized, skipping');
            return;
          }

          
          if (typeof window.Meting !== 'function') {
            throw new Error('Meting constructor not available');
          }

          new window.Meting(el);
          el.setAttribute('data-initialized', 'true');
          successCount++;
          console.log('[Music Player] Successfully initialized meting-js element');
        } catch (err) {
          errorCount++;
          console.error('[Music Player] Error initializing meting-js element:', err);
        }
      });

      console.log(`[Music Player] Initialization complete: ${successCount} successful, ${errorCount} failed`);

      
      if (successCount === 0 && players.length > 0) {
        console.log('[Music Player] No players initialized, scheduling retry...');
        setTimeout(() => {
          console.log('[Music Player] Retrying initialization...');
          initializePlayers();
        }, 1000);
      }

      return successCount > 0;
    } catch (error) {
      console.error('[Music Player] Fatal error during initialization:', error);
      return false;
    }
  }

  
  function initMusicPlayers() {
    console.log('[Music Player] Initialization triggered');

    try {
      if (!safeHasMusicPlayers()) {
        console.log('[Music Player] No meting-js elements found');
        return;
      }

      const playerCount = document.querySelectorAll('meting-js').length;
      console.log(`[Music Player] Found ${playerCount} meting-js element(s)`);

      
      if (safeResourcesLoaded()) {
        console.log('[Music Player] Resources already loaded, initializing...');
        setTimeout(() => initializePlayers(), 50);
        return;
      }

      
      const scripts = Array.from(document.querySelectorAll('script[src]'));
      const hasAPlayerScript = scripts.some(s => s.src.includes('APlayer.min.js'));
      const hasMetingScript = scripts.some(s => s.src.includes('Meting.min.js'));

      if (hasAPlayerScript || hasMetingScript) {
        console.log('[Music Player] Resources detected in DOM, waiting for load...');
        waitForResources();
        return;
      }

      
      console.log('[Music Player] Loading dependencies dynamically...');
      loadDependencies().then(success => {
        if (success) {
          console.log('[Music Player] Dependencies loaded, initializing players...');
          setTimeout(() => initializePlayers(), 100);
        } else {
          console.error('[Music Player] Failed to load dependencies, will retry in 2s');
          setTimeout(initMusicPlayers, 2000);
        }
      });
    } catch (error) {
      console.error('[Music Player] Error in initialization flow:', error);
    }
  }

  
  function waitForResources() {
    const maxWaitTime = 10000; 
    const checkInterval = 250;
    let elapsed = 0;
    let timeoutId = null;

    const check = () => {
      elapsed += checkInterval;

      if (safeResourcesLoaded()) {
        console.log(`[Music Player] Resources loaded after ${elapsed}ms`);
        setTimeout(() => initializePlayers(), 50);
        return;
      }

      if (elapsed >= maxWaitTime) {
        console.warn('[Music Player] Timeout waiting for resources, loading dynamically...');
        loadDependencies().then(success => {
          if (success) {
            setTimeout(() => initializePlayers(), 100);
          }
        });
        return;
      }

      timeoutId = setTimeout(check, checkInterval);
    };

    check();
  }

  
  function startInitialization() {
    
    setTimeout(initMusicPlayers, 100);
  }

  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[Music Player] DOMContentLoaded event fired');
      startInitialization();
    });
  } else {
    console.log('[Music Player] DOM already loaded');
    startInitialization();
  }

  
  if (typeof document.addEventListener === 'function') {
    document.addEventListener('pjax:end', function() {
      console.log('[Music Player] PJAX navigation detected');
      setTimeout(initMusicPlayers, 100);
    });
  }

  
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(() => {
        if (document.querySelectorAll('meting-js').length > 0 && !safeResourcesLoaded()) {
          console.log('[Music Player] Page visible again, checking music players...');
          initMusicPlayers();
        }
      }, 500);
    }
  });

  
  window.initMusicPlayers = initMusicPlayers;
  console.log('[Music Player] Initialization system ready');
})();
</script>



    
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-line">
                <span id="run-time" data-i18n="runtime"></span>
            </div><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.122.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreferrer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div>

            <div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024 - 2026</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/hzp2333/hzp2333.github.io" target="_blank">滑翔闪</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
            </div>

            <style>
                .footerImg {
                    height: 20px;
                }
            </style>
            <div class="footer-line custom">
                <a href="https://icp.gov.moe/?keyword=20244204" target="_blank">萌ICP备20244204号</a>
                <a style="text-decoration:none;color:#55bb8a;" href="https://travel.moe/go.html" title="异次元之旅-跃迁-我们一起去萌站成员的星球旅行吧！" target="_blank">
                    <img src="https://travel.moe/images/icon/icon64green.png" style="width:24px;height:24px" alt="异次元之旅">异次元之旅
                </a>
            </div>

            <div class="footer-line custom">
                <a href="https://www.travellings.cn/go.html" target="_blank">
                    <img src="https://www.travellings.cn/assets/logo.gif" class="footerImg" alt="开往-友链接力 v1.5" title="开往-友链接力 v1.5">
                </a>
                <a href="https://www.foreverblog.cn/" target="_blank">
                    <img src="https://foreverblog.cn/assets/logo/logo_en_default.png" class="footerImg" alt="Forever Blog">
                </a>
                <a href="https://www.foreverblog.cn/go.html" target="_blank">
                    <img src="https://foreverblog.cn/assets/logo/wormhole_2.gif" class="footerImg" alt="穿梭虫洞-随机访问十年之约友链博客" title="穿梭虫洞-随机访问十年之约友链博客">
                </a>
            </div><div class="footer-line">
  <i class="fas fa-book fa-fw" aria-hidden="true"></i>&nbsp;共 97 篇文章，346539 字</div>
    
        
        <script async src=" //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js "></script>
    

    
        
            <section>
                
                    <span id="busuanzi_container_value_site_pv"><i class="far fa-eye fa-fw"></i>
                        
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                

                
                    &nbsp;|&nbsp;              
                

                
                    <span id="busuanzi_container_value_site_uv"><i class="fa fa-user"></i>
                        
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
            </section>
        

        
        
    


</div>
    </footer>
 

    
    <script src="https://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js" 
        data-color="0,0,0" 
        data-count="150" 
        data-zIndex="-1">
    </script>
</body>
</html>



</div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"giscus":{"category":"Announcements","categoryId":"DIC_kwDOLbBjxM4Cdr0n","darkTheme":"dark_dimmed","emitMetadata":"0","inputPosition":"bottom","lang":"zh-CN","lazyLoading":false,"lightTheme":"light","mapping":"pathname","reactionsEnabled":"1","repo":"hzp2333/Giscus","repoId":"R_kgDOLbBjxA"}},"data":{"id-1":"滑翔闪'S BLOG","id-2":"滑翔闪'S BLOG"},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/zh-cn/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js"></script><script type="text/javascript" src="/js/custom.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-CYZVM6VVZ8', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-CYZVM6VVZ8" async></script></body>
</html>
