<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title> 计量：事件研究法 2 - 滑翔闪&#39;S BLOG</title><meta name="Description" content="This is my cool site"><meta property="og:title" content=" 计量：事件研究法 2" />
<meta property="og:description" content="参考《An Introductory Guide to Event Study Models》总结下事件研究法的代码使用。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.huaxiangshan.com/zh-cn/posts/event2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-06-24T07:52:19+08:00" />
<meta property="article:modified_time" content="2024-06-24T07:52:19+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content=" 计量：事件研究法 2"/>
<meta name="twitter:description" content="参考《An Introductory Guide to Event Study Models》总结下事件研究法的代码使用。"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.huaxiangshan.com/zh-cn/posts/event2/" /><link rel="prev" href="https://blog.huaxiangshan.com/zh-cn/posts/event1/" /><link rel="next" href="https://blog.huaxiangshan.com/zh-cn/posts/paf/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": " 计量：事件研究法 2",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.huaxiangshan.com\/zh-cn\/posts\/event2\/"
        },"genre": "posts","keywords": "因果效应, 文献阅读","wordcount":  7442 ,
        "url": "https:\/\/blog.huaxiangshan.com\/zh-cn\/posts\/event2\/","datePublished": "2024-06-24T07:52:19+08:00","dateModified": "2024-06-24T07:52:19+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "滑翔闪"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper">

<script>
window.MathJax = {
  tex: {
    inlineMath: [["$", "$"], ["\\(", "\\)"]],
    displayMath: [["$$","$$"], ["[[", "]]"]]
  },
  svg: { fontCache: "global" }
};

const mathjaxCDNs = [
  "https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.js",
  "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js",
  "https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-chtml.js"
];

function loadMathJax(index=0){
  if(index >= mathjaxCDNs.length){
    console.error("所有 MathJax CDN 加载失败");
    return;
  }
  const script = document.createElement("script");
  script.src = mathjaxCDNs[index];
  script.async = true;
  script.onload = () => console.log("MathJax 加载成功:", mathjaxCDNs[index]);
  script.onerror = () => {
    console.warn("MathJax CDN 加载失败，尝试下一个:", mathjaxCDNs[index]);
    loadMathJax(index+1);
  };
  document.head.appendChild(script);
}


const polyfillCDNs = [
  "https://cdn.bootcdn.net/ajax/libs/polyfill/3.110.0/polyfill.min.js",
  "https://polyfill.io/v3/polyfill.min.js?features=es6"
];
const polyfillScript = document.createElement("script");
polyfillScript.src = polyfillCDNs[0]; 
document.head.appendChild(polyfillScript);


loadMathJax();
</script>












<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sakana 小组件集成</title>
  <style>
     
    #sakana-widget-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 268px;
      height: 268px;
    }
    #sakana-widget {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="sakana-widget-container">
    <div id="sakana-widget"></div>
  </div>

  <script>
    function initSakanaWidget() {
      new SakanaWidget({
        size: 300,
        autoFit: true,
        character: 'chisato',
        controls: true,
        rod: true,
        draggable: true,
        stroke: { color: '#b4b4b4', width: 10 },
        threshold: 0.1,
        rotate: 0,
        title: false
      }).mount('#sakana-widget');

      
      checkScreenWidth();
      window.addEventListener('resize', checkScreenWidth);
    }

    function checkScreenWidth() {
      var screenWidth = window.innerWidth;
      var container = document.getElementById('sakana-widget-container');
      if (screenWidth <= 960) {
        container.style.display = 'none';
      } else {
        container.style.display = 'block';
      }
    }
  </script>

  
  <script 
    async
    onload="initSakanaWidget()"
    src="https://cdn.jsdelivr.net/npm/sakana-widget@2.2.2/lib/sakana.min.js">
  </script>
</body>
</html>




<script type="text/javascript" color="0,174,255" opacity='0.7' zIndex="-2" count="200" src="https://www.liuzehe.top/upload/bkjs/bj.js"></script><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/zh-cn/" title="滑翔闪&#39;S BLOG"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/%E7%9F%9B%E7%9B%BE.png"
        data-srcset="/images/%E7%9F%9B%E7%9B%BE.png, /images/%E7%9F%9B%E7%9B%BE.png 1.5x, /images/%E7%9F%9B%E7%9B%BE.png 2x"
        data-sizes="auto"
        alt="/images/%E7%9F%9B%E7%9B%BE.png"
        title="/images/%E7%9F%9B%E7%9B%BE.png" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/zh-cn/posts/" title="书中自有黄金屋"><i class='fa fa-solid fa-book'></i> 文章 </a><a class="menu-item" href="/zh-cn/tags/" title="定义文章，不定义世界"><i class='fa fa-tag'></i> 标签 </a><a class="menu-item" href="/zh-cn/categories/" title="分类是种视角"><i class='fa fa-archive'></i> 分类 </a><a class="menu-item" href="/zh-cn/friends/" title="有朋自远方来"><i class='fa fa-user-group'></i> 友链  </a><a class="menu-item" href="/zh-cn/about/" title="人穷其一生寻找自己"> <i class='fa fa-address-card'></i> 关于 </a><a class="menu-item" href="https://www.travellings.cn/go.html" title="漫长的列车驶向未来" rel="noopener noreffer" target="_blank"><i class='fa fa-train-subway'></i> 开往  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="吾将上下而求索" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="选择语言">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/zh-cn/posts/event2/" selected>简体中文</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/zh-cn/" title="滑翔闪&#39;S BLOG"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/%E7%9F%9B%E7%9B%BE.png"
        data-srcset="/images/%E7%9F%9B%E7%9B%BE.png, /images/%E7%9F%9B%E7%9B%BE.png 1.5x, /images/%E7%9F%9B%E7%9B%BE.png 2x"
        data-sizes="auto"
        alt="/images/%E7%9F%9B%E7%9B%BE.png"
        title="/images/%E7%9F%9B%E7%9B%BE.png" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="吾将上下而求索" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/zh-cn/posts/" title="书中自有黄金屋"><i class='fa fa-solid fa-book'></i>文章</a><a class="menu-item" href="/zh-cn/tags/" title="定义文章，不定义世界"><i class='fa fa-tag'></i>标签</a><a class="menu-item" href="/zh-cn/categories/" title="分类是种视角"><i class='fa fa-archive'></i>分类</a><a class="menu-item" href="/zh-cn/friends/" title="有朋自远方来"><i class='fa fa-user-group'></i>友链 </a><a class="menu-item" href="/zh-cn/about/" title="人穷其一生寻找自己"> <i class='fa fa-address-card'></i>关于</a><a class="menu-item" href="https://www.travellings.cn/go.html" title="漫长的列车驶向未来" rel="noopener noreffer" target="_blank"><i class='fa fa-train-subway'></i>开往 </a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/zh-cn/posts/event2/" selected>简体中文</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX"> 计量：事件研究法 2</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/hzp2333/hzp2333.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>滑翔闪</a></span>&nbsp;<span class="post-category">收录于 <a href="/zh-cn/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%B9%A0/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>经济学习</a></span></div>

            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2024-06-24">2024-06-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7442 字
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 15 分钟&nbsp;
    

    
        

        
        
            <span id="busuanzi_container_value_page_pv"><i class="far fa-eye fa-fw"></i>
                
                <span id="busuanzi_value_page_pv"></span>&nbsp;次阅读</span>
        
    


</div>

        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624163058043.webp"
        data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624163058043.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624163058043.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624163058043.webp 2x"
        data-sizes="auto"
        alt="/img/stata事件研究法2.zh-cn-20240624163058043.webp"
        title="/img/stata事件研究法2.zh-cn-20240624163058043.webp" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#附录-a区分-did-和-timing-base">附录 A：区分 DID 和 Timing-base</a></li>
    <li><a href="#附录-btiming-based-的参数限制">附录 B：Timing-based 的参数限制</a></li>
    <li><a href="#附录-c估计器的选择">附录 C：估计器的选择</a></li>
    <li><a href="#附录-d-接近原始数据">附录 D: 接近原始数据</a></li>
    <li><a href="#附录-e重复的事件冲击">附录 E：重复的事件冲击</a></li>
    <li><a href="#附录-f时间趋势的控制">附录 F：时间趋势的控制</a>
      <ul>
        <li><a href="#did一个个体两个时间">DID：一个个体，两个时间</a></li>
        <li><a href="#time-based-一个个体两个时间">Time-based ：一个个体，两个时间</a></li>
        <li><a href="#did多个体多时间">DID：多个体，多时间</a></li>
        <li><a href="#time--based多个体多时间">Time -based：多个体，多时间</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><ul>
<li><a href="https://blog.huaxiangshan.com/zh-cn/posts/event1/" target="_blank" rel="noopener noreffer ">计量：事件研究法 1</a></li>
<li><a href="https://blog.huaxiangshan.com/zh-cn/posts/event2/" target="_blank" rel="noopener noreffer ">计量：事件研究法 2</a></li>
<li><a href="https://blog.huaxiangshan.com/zh-cn/posts/event3/" target="_blank" rel="noopener noreffer ">计量：事件研究法 3</a></li>
</ul>
<p>书接上回，本文是《<a href="https://www.aeaweb.org/articles?id=10.1257/jep.37.2.203" target="_blank" rel="noopener noreffer ">An Introductory Guide to Event Study Models</a>》的代码学习记录。</p>
<h2 id="附录-a区分-did-和-timing-base">附录 A：区分 DID 和 Timing-base</h2>
<p>这部分代码属于描述统计，描述样本分布（或者作为政策实施背景）。</p>
<ul>
<li>DID type：既有实验组又有对照组（从未实施过政策）</li>
<li>Timing-based：只有实验组，但实验组内部事件冲击时间不同。</li>
</ul>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623201120575.webp" title="代码结果：第一排Hybrid数据结构；第二排Timing-based数据结构" data-thumbnail="/img/stata事件研究法2.zh-cn-20240623201120575.webp" data-sub-html="<h2> </h2><p>代码结果：第一排Hybrid数据结构；第二排Timing-based数据结构</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623201120575.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623201120575.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623201120575.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623201120575.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240623201120575.webp" />
    </a><figcaption class="image-caption">代码结果：第一排Hybrid数据结构；第二排Timing-based数据结构</figcaption>
    </figure></p>
<p>代码如下，结构是生成数据-画频率图-画累计图。原文累计图先使用 <code>cumul</code> 计算积累比例值，然后通过 <code>twoway</code> 画折线图。太复杂了，这里修改成 <code>cdfplot</code> 命令一步到位。</p>
<p>结果图片和原文不同也不用意外——原文代码在两侧额外插值插入了端点值，我删去了这部分。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">clear</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">生成双重差分面板随机数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="mi">2024</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">obs</span><span class="w"> </span><span class="mi">100</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_n</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">50</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">expand</span><span class="w"> </span><span class="mi">20</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sort</span><span class="w"> </span><span class="n">i</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_n</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xtset</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">t</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">设置处理效应</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">E_i</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">etime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E_i</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">label</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="s2">&#34;个体编号&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">label</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="s2">&#34;日期&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">label</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="s2">&#34;did变量=time*post&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">label</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="s2">&#34;事件冲击时间&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">画出实验组和处理组的分布</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">16</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">51</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">61</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">6</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">62</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">68</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">7</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">69</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">70</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">71</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">75</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">11</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">76</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">12</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">91</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">分界符设置，修改分号；为命令分行符号。
</span></span></span><span class="line"><span class="cl"><span class="cm">如此以来，除非末尾加上分号，即便分行写也看作一排
</span></span></span><span class="line"><span class="cl"><span class="cm">画图命令这样使用会方面很多
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">twoway</span><span class="w">  </span><span class="p">(</span><span class="n">histogram</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">discrete</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="k">start</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">barwidth</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">xscale</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">17</span><span class="p">))</span><span class="w"> </span><span class="n">yscale</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1200</span><span class="p">))</span><span class="w">   </span><span class="n">color</span><span class="p">(</span><span class="n">cranberry</span><span class="o">%</span><span class="mi">100</span><span class="p">))</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">histogram</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">discrete</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="k">start</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">barwidth</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">xscale</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">17</span><span class="p">))</span><span class="w"> </span><span class="n">yscale</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1200</span><span class="p">))</span><span class="w">   </span><span class="n">color</span><span class="p">(</span><span class="n">navy</span><span class="o">%</span><span class="mi">40</span><span class="p">)),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;实验组和对照组事件冲击分布图&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">color</span><span class="p">(</span><span class="n">black</span><span class="p">)</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">small</span><span class="p">))</span><span class="w"> </span><span class="n">legend</span><span class="p">(</span><span class="k">off</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xlabel</span><span class="p">(</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="s2">&#34;6&#34;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="s2">&#34;7&#34;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="s2">&#34;8&#34;</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="s2">&#34;9&#34;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="s2">&#34;10&#34;</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="s2">&#34;11&#34;</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="s2">&#34;12&#34;</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="s2">&#34;NA&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nb">text</span><span class="p">(</span><span class="mi">1100</span><span class="w"> </span><span class="mi">15</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="s2">&#34;从来没接受干预&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="n">small</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="p">(</span><span class="n">histogram4</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="n">cr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">画出实验组和处理组的分布</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">preserve</span><span class="w"> </span><span class="o">//</span><span class="err">保存当前数据集</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cdfplot</span><span class="w"> </span><span class="n">E_i</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;事件时间的累计分布图&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">color</span><span class="p">(</span><span class="n">black</span><span class="p">)</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">small</span><span class="p">))</span><span class="w"> </span><span class="n">legend</span><span class="p">(</span><span class="k">off</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ytitle</span><span class="p">(</span><span class="err">百分比</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="p">(</span><span class="n">CDF4</span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">note</span><span class="p">(</span><span class="n">Hybrid事件数据类型</span><span class="err">，实验组事件时间不同，同时对照组从未受到事件冲击</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="n">cr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">restore</span><span class="w"> </span><span class="o">//</span><span class="err">重新加载保存数据集</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">实验组和处理组的分布</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">treated</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">6</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">21</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">7</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">33</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">37</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">38</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">58</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">11</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">59</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">12</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">65</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">E_i</span><span class="o">=</span><span class="mi">15</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;</span><span class="mi">90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">twoway</span><span class="w">  </span><span class="p">(</span><span class="n">histogram</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">treated</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">discrete</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="k">start</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">barwidth</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">xscale</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">17</span><span class="p">))</span><span class="w"> </span><span class="n">yscale</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">800</span><span class="p">))</span><span class="w">   </span><span class="n">color</span><span class="p">(</span><span class="n">cranberry</span><span class="o">%</span><span class="mi">100</span><span class="p">)),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;实验组和对照组事件冲击分布图&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">color</span><span class="p">(</span><span class="n">black</span><span class="p">)</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">small</span><span class="p">))</span><span class="w"> </span><span class="n">legend</span><span class="p">(</span><span class="k">off</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ylabel</span><span class="p">(</span><span class="mi">0</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="mi">800</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="p">(</span><span class="n">histogram5</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="n">cr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">画出实验组和处理组的累计分布</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cdfplot</span><span class="w"> </span><span class="n">E_i</span><span class="p">,</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;事件时间的累计分布图&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">color</span><span class="p">(</span><span class="n">black</span><span class="p">)</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">small</span><span class="p">))</span><span class="w"> </span><span class="n">legend</span><span class="p">(</span><span class="k">off</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ytitle</span><span class="p">(</span><span class="err">百分比</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">note</span><span class="p">(</span><span class="n">Timing</span><span class="o">-</span><span class="n">based事件数据类型</span><span class="err">，由于实验组事件时间不同，内部也能形成比较</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="p">(</span><span class="n">CDF5</span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="n">cr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*-</span><span class="err">合并展示以上图</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">graph</span><span class="w"> </span><span class="n">combine</span><span class="w"> </span><span class="n">histogram4</span><span class="w"> </span><span class="n">CDF4</span><span class="w"> </span><span class="n">histogram5</span><span class="w"> </span><span class="n">CDF5</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">iscale</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="w"> </span><span class="o">//</span><span class="err">图片比例缩小为四分之一</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="附录-btiming-based-的参数限制">附录 B：Timing-based 的参数限制</h2>
<p>在估计 DID 的事件效应时，一般不加入时间趋势，但会加入个体固定和时间固定，这些固定效应的作用是分解<strong>截距</strong>。处理共线性的方法一般是默认 $t_{-1}$ 为 0 、合并删除部分变量、施加其他约束、非线性化&hellip;&hellip;</p>
<p>对于 Timing-based 的数据形式，由于没有对照组，我们只能在实验组内部进行比较。<strong>需要的加入的参数限制会更多</strong>。</p>
<ul>
<li>事件时间的差异也是提供信息的一部分。</li>
<li>实验组之间事件时间差异最小值越大，信息流失越多。</li>
<li>个体越多，信息越多。</li>
</ul>
<p>于是附录 B 计量代码研究的是——</p>
<p>当研究 Timing-based 数据结构时，对于不同的时间分布和个体分布，需要多少个额外参数才能求解？</p>
<blockquote>
<p>个人理解：这里可能是通过一系列回归建立方程组，通过方程组建立矩阵，再通过矩阵秩来判断，还需要多少个参数约束才能求解。</p>
</blockquote>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623213819615.webp" title="附录B代码结果：一张作者说非常奇怪的结果图" data-thumbnail="/img/stata事件研究法2.zh-cn-20240623213819615.webp" data-sub-html="<h2> </h2><p>附录B代码结果：一张作者说非常奇怪的结果图</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623213819615.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623213819615.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623213819615.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623213819615.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240623213819615.webp" />
    </a><figcaption class="image-caption">附录B代码结果：一张作者说非常奇怪的结果图</figcaption>
    </figure></p>
<p>解释下附录 B 代码的结果图含义。</p>
<p>先给出一个数据集，都受到事件冲击，但事件时间不同。初始样本生成的数据集中，事件冲击时间分别是 4 和 16。此时求解需要的额外约束参数为 12（可以理解为自由度估计还差多少）。</p>
<p>图像的含义是：</p>
<p>先看<strong>蓝色圆点部分第一列</strong>。</p>
<p>当加入其他样本，且样本点<strong>事件冲击时间</strong>为 4 (横坐标)时，此时没有带来额外信息。整体数据集依旧是两类样本——事件冲击时间为 4 或 16，求解需要的<strong>额外参数</strong>依旧为 12(纵坐标)。</p>
<p>同理，<strong>蓝色圆点第二列</strong>的含义是，加入时间冲击时间为 5 的第三组样本，由于事件冲击时间差异减少，信息增多，此时需要的额外参数减少为 1。</p>
<p>红色三角形的含义则是在给定每列圆点数据的基础上，再加入三角形代表的样本，需要的参数又会发生什么变化。</p>
<blockquote>
<p>本来预期，时间差异给定的情况下，个体分组越多，额外参数需求越小，没想到只有第五列出现了这种情况，所以论文情况说这很奇怪，也值得研究，但他也不知道为什么。</p>
</blockquote>
<p>以下代码通过 GPT 加入注释：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cap</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">close</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">trace</span><span class="w"> </span><span class="k">off</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="k">more</span><span class="w"> </span><span class="k">off</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">clear</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="mi">101</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cap</span><span class="w"> </span><span class="n">prog</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="n">runme</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">prog</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">runme</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">args</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">ctrl</span><span class="w"> </span><span class="n">trends</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="n">gendata</span><span class="w"> </span><span class="s2">&#34;`list&#39;&#34;</span><span class="w"> </span><span class="o">`</span><span class="n">ctrl</span><span class="s1">&#39; `trends&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="n">forvalues</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">20</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; = (etime == `i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">生成处理组正向虚拟变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">D_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; = (etime == -1 * `i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">生成处理组负向虚拟变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">summ</span><span class="w"> </span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; ;  // 汇总处理组正向虚拟变量
</span></span></span><span class="line"><span class="cl"><span class="s1">local dropme = (r(mean) == 0) ;
</span></span></span><span class="line"><span class="cl"><span class="s1">if `dropme&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">drop</span><span class="w"> </span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;  ;  // 如果均值为0，则删除处理组正向虚拟变量
</span></span></span><span class="line"><span class="cl"><span class="s1">} ;
</span></span></span><span class="line"><span class="cl"><span class="s1">summ D_m`i&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">汇总处理组负向虚拟变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">dropme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="o">`</span><span class="n">dropme</span><span class="s1">&#39; == 1 { ;
</span></span></span><span class="line"><span class="cl"><span class="s1">drop D_m`i&#39;</span><span class="w">  </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">如果均值为</span><span class="mi">0</span><span class="err">，则删除处理组负向虚拟变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">drop</span><span class="w"> </span><span class="n">D_m0</span><span class="w">  </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">删除处理组负向虚拟变量的基准情况</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">egen</span><span class="w"> </span><span class="n">unittype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">group</span><span class="p">(</span><span class="n">E_i</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">miss</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">根据</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="err">生成单位类型变量，处理缺失值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="n">tab</span><span class="w"> </span><span class="n">unittype</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">gen</span><span class="p">(</span><span class="n">udum</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">汇总单位类型变量，生成对应的虚拟变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="n">tab</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">gen</span><span class="p">(</span><span class="n">tdum</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">汇总时间变量，生成对应的虚拟变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">unab</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">D_</span><span class="o">*</span><span class="w"> </span><span class="n">udum</span><span class="o">*</span><span class="w"> </span><span class="n">tdum</span><span class="o">*</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">生成所有与</span><span class="w"> </span><span class="n">D_</span><span class="o">*</span><span class="err">、</span><span class="n">udum</span><span class="o">*</span><span class="w"> </span><span class="err">和</span><span class="w"> </span><span class="n">tdum</span><span class="o">*</span><span class="w"> </span><span class="err">相关的变量列表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mata</span><span class="p">:</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">调用</span><span class="w"> </span><span class="n">Mata</span><span class="w"> </span><span class="err">函数计算变量的统计信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">获取统计结果中的第一列信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">获取统计结果中的第二列信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">获取统计结果中的第三列信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">di</span><span class="w"> </span><span class="s2">&#34;`list&#39;&#34;</span><span class="w"> </span><span class="n">_column</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">`</span><span class="n">c1</span><span class="s1">&#39; _column(25) `c2&#39;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">_column</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span><span class="w"> </span><span class="o">`</span><span class="n">c3</span><span class="s1">&#39; ;  // 显示变量列表及其统计信息
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">end ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">mata: ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">void count() 
</span></span></span><span class="line"><span class="cl"><span class="s1">{  ;
</span></span></span><span class="line"><span class="cl"><span class="s1">v = st_local(&#34;vars&#34;) ;  // 获取 Stata 定义的局部宏变量 &#34;vars&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">X = st_data(.,v) ;  // 从当前数据集中获取变量数据
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">mycols = cols(X) ;  // 计算数据矩阵的列数
</span></span></span><span class="line"><span class="cl"><span class="s1">myrank = rank(X) ;  // 计算数据矩阵每列的非缺失值数量
</span></span></span><span class="line"><span class="cl"><span class="s1">gap = mycols - myrank ;  // 计算数据矩阵每列的缺失值数量
</span></span></span><span class="line"><span class="cl"><span class="s1">output = (mycols,myrank,gap) ;  // 将统计结果组合成元组
</span></span></span><span class="line"><span class="cl"><span class="s1">st_matrix(&#34;count&#34;,output) ;  // 将统计结果存储到名为 &#34;count&#34; 的矩阵中
</span></span></span><span class="line"><span class="cl"><span class="s1">} ;
</span></span></span><span class="line"><span class="cl"><span class="s1">end ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">cap prog drop gendata ;
</span></span></span><span class="line"><span class="cl"><span class="s1">program define gendata ;
</span></span></span><span class="line"><span class="cl"><span class="s1">args list ctrl trends ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">drop _all ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">local numobs = 48 ;  // 定义观察值数量
</span></span></span><span class="line"><span class="cl"><span class="s1">local treatedunittypes = wordcount(&#34;`list&#39;</span><span class="s2">&#34;) ;  // 计算处理单元类型数量
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* &#34;</span><span class="n">ctrl</span><span class="s2">&#34; is 0/1 whether we have control (untreated) units */
</span></span></span><span class="line"><span class="cl"><span class="s2">/* if we have them, put half of data into control units */
</span></span></span><span class="line"><span class="cl"><span class="s2">local numtreatedobs = round(`numobs&#39; / (1 + `ctrl&#39;)) ;  // 计算处理单元观察值数量
</span></span></span><span class="line"><span class="cl"><span class="s2">local numuntreatedobs = `numobs&#39; - `numtreatedobs&#39; ;  // 计算对照单元观察值数量
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">local obspertype = floor(`numtreatedobs&#39; /
</span></span></span><span class="line"><span class="cl"><span class="s2">`treatedunittypes&#39;) ;  // 计算每种处理单元类型的观察值数量
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">forvalues i = 1/`treatedunittypes&#39; { ;
</span></span></span><span class="line"><span class="cl"><span class="s2">local eventdate_`i&#39; = word(&#34;</span><span class="o">`</span><span class="n">list</span><span class="s1">&#39;&#34;,`i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">获取每种处理单元类型的事件日期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">obs</span><span class="w"> </span><span class="o">`</span><span class="n">numobs</span><span class="s1">&#39; ;/* 观察值数量 */
</span></span></span><span class="line"><span class="cl"><span class="s1">gen i = _n ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">gen treated = i &gt; `numuntreatedobs&#39;</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 处理组单元 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">forvalues</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">/`</span><span class="n">treatedunittypes</span><span class="s1">&#39; { ;
</span></span></span><span class="line"><span class="cl"><span class="s1">local start = (`i&#39;</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*`</span><span class="n">obspertype</span><span class="s1">&#39; + `numuntreatedobs&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;)*`obspertype&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">`</span><span class="n">numuntreatedobs</span><span class="s1">&#39; ;
</span></span></span><span class="line"><span class="cl"><span class="s1">replace E_i = `eventdate_`i&#39;&#39; if i &gt;= `start&#39;</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">`</span><span class="n">stop</span><span class="s1">&#39; ;  // 根据每种处理单元类型设置事件日期
</span></span></span><span class="line"><span class="cl"><span class="s1">} ;
</span></span></span><span class="line"><span class="cl"><span class="s1">replace E_i = `eventdate_`treatedunittypes&#39;&#39; if i &gt; `stop&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">tab</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">miss</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">汇总事件日期变量，显示缺失值情况</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">expand</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 时间期限 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sort</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_n</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xtset</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">定义面板数据的单位和时间变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* make variables that determine the DGP */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">etime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E_i</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 事件时间 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* gen TE = 1 * (etime &gt;= 0) ;/* 步骤功能处理效应 */
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">TE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">etime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">etime</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 无尽的斜坡功能处理效应 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">TE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">Y0_pure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 最简单的反事实情况 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="n">gen</span><span class="w"> </span><span class="n">Y0_pure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 处理组有前趋势 ... */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">*</span><span class="n">gen</span><span class="w"> </span><span class="n">Y0_pure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">E_i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="cm">/* 基于 E_i 的前趋势 ... */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnormal</span><span class="p">()</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y0_pure</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps</span><span class="w"> </span><span class="p">;</span><span class="cm">/* 观察到的 Y */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cap</span><span class="w"> </span><span class="n">prog</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="n">bigone</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">prog</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">bigone</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">runme</span><span class="w"> </span><span class="s2">&#34;10 11&#34;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">forvalues</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">/</span><span class="mi">16</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">runme</span><span class="w"> </span><span class="s2">&#34;4 16 `i&#39; &#34;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">rest_m3_</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; = count[1,3] - 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">runme &#34;4 16 `i&#39;</span><span class="w"> </span><span class="mi">10</span><span class="s2">&#34; 0 0 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">local rest_m4_`i&#39; = count[1,3] - 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">} ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">drop _all ;
</span></span></span><span class="line"><span class="cl"><span class="s2">set obs 7 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen E_i = _n + 3 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">qui gen units3 = . ;
</span></span></span><span class="line"><span class="cl"><span class="s2">qui gen units4 = . ;
</span></span></span><span class="line"><span class="cl"><span class="s2">qui forvalues i = 4/10 { ;
</span></span></span><span class="line"><span class="cl"><span class="s2">replace units3 = `rest_m3_`i&#39;&#39; if E_i == `i&#39; ;
</span></span></span><span class="line"><span class="cl"><span class="s2">replace units4 = `rest_m4_`i&#39;&#39; if E_i == `i&#39; ;
</span></span></span><span class="line"><span class="cl"><span class="s2">} ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">gen E4_i = E_i + 0.15 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">graph twoway (scatter units3 E_i , msymbol(o) msize(medsmall)) 
</span></span></span><span class="line"><span class="cl"><span class="s2">(scatter units4 E4_i , msymbol(triangle) msize(medsmall)) 
</span></span></span><span class="line"><span class="cl"><span class="s2">,
</span></span></span><span class="line"><span class="cl"><span class="s2">ti(&#34;</span><span class="err">需要额外参数限制</span><span class="s2">&#34;) 
</span></span></span><span class="line"><span class="cl"><span class="s2">xtitle(&#34;</span><span class="n">E_3</span><span class="w"> </span><span class="err">的位置</span><span class="s2">&#34;) 
</span></span></span><span class="line"><span class="cl"><span class="s2">note(&#34;</span><span class="o">#</span><span class="w"> </span><span class="n">DiD</span><span class="w"> </span><span class="err">限制之外需要的限制。无对照组。</span><span class="n">T</span><span class="o">=</span><span class="mi">20</span><span class="err">。</span><span class="n">E_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">E_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="err">。</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="err">圆圈显示</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">种单位类型，作为第三种事件日期的函数。三角形显示</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="err">种单位类型，其中</span><span class="w"> </span><span class="n">E_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="err">。</span><span class="s2">&#34;) 
</span></span></span><span class="line"><span class="cl"><span class="s2">;
</span></span></span><span class="line"><span class="cl"><span class="s2">graph export figures/apdx_fig_A03.png , replace ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">end ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">bigone ;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>那么，当我们需要额外约束时，可以怎么添加呢？</p>
<ul>
<li>方法 1：相加为 0—— $r_1+r_2=0$</li>
<li>方法 2：等差数列—— $r_2-r_1=r_0-r_{-1}$</li>
<li>方法 3：不是论文提到的，但有确实见过这种用法：$r1=2r_2$</li>
</ul>
<p>这种约束回归通过 <code>cnsreg</code> 命令实现。</p>
<h2 id="附录-c估计器的选择">附录 C：估计器的选择</h2>
<p>目前有两种种估计器选择：</p>
<ul>
<li>约束事件前一期变量的系数为 0</li>
<li>约束事前虚拟事件变量系数加总为 0</li>
</ul>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623232924003.webp" title="不同约束条件下的估计，两种估计都使用了个体固定效应加总为0" data-thumbnail="/img/stata事件研究法2.zh-cn-20240623232924003.webp" data-sub-html="<h2> </h2><p>不同约束条件下的估计，两种估计都使用了个体固定效应加总为0</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623232924003.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623232924003.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623232924003.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623232924003.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240623232924003.webp" />
    </a><figcaption class="image-caption">不同约束条件下的估计，两种估计都使用了个体固定效应加总为0</figcaption>
    </figure>
这部分的代码是<strong>仿真实验</strong>。</p>
<p>先根据条件生成处理效应，处理效应确定为 1（图中的红色线就是实际生成的处理效应）。然后加入偏差随机数，最后进行回归估计。</p>
<p>左侧的约束条件选择了规范化事件前一期，右侧的约束条件选择了约束事前虚拟时间变量，可以发现右侧更接近实际治疗效应（红线）。</p>
<p>以下代码由 GPT 进行注释，个人进行了部分修正。</p>
<p>代码结构：设置数据结构生成函数和约束条件选择函数，绘图</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="n">delimit</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cap</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">close</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">trace</span><span class="w"> </span><span class="k">off</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="k">more</span><span class="w"> </span><span class="k">off</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">clear</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="mi">2024202431</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cap</span><span class="w"> </span><span class="n">prog</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="n">runme</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">prog</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">runme</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gendata</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 创建估计变量 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 事件时间虚拟变量 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">forvalues</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">20</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; = (etime == `i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">D_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; = (etime == -1 * `i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">summ</span><span class="w"> </span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; ;
</span></span></span><span class="line"><span class="cl"><span class="s1">local dropme = (r(mean) == 0) ;
</span></span></span><span class="line"><span class="cl"><span class="s1">if `dropme&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">drop</span><span class="w"> </span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;  ;
</span></span></span><span class="line"><span class="cl"><span class="s1">} ;
</span></span></span><span class="line"><span class="cl"><span class="s1">summ D_m`i&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">dropme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="o">`</span><span class="n">dropme</span><span class="s1">&#39; == 1 { ;
</span></span></span><span class="line"><span class="cl"><span class="s1">drop D_m`i&#39;</span><span class="w">  </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">drop</span><span class="w"> </span><span class="n">D_m0</span><span class="w">  </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">group2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">trend_group2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">group2</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">summ</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 1 规范化事件事件-1的虚拟变量为0 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">D_m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 2, 所有组的固定效应加总为0 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">6</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 7 处理前的事件时间虚拟变量的平均值设为零*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">D_m10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m4</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">D_m3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D_m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cnsreg</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">D_m</span><span class="o">*</span><span class="w"> </span><span class="n">D_p</span><span class="o">*</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ibn</span><span class="p">.</span><span class="n">t</span><span class="w"> </span><span class="n">ibn</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">cluster</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">nocons</span><span class="w"> </span><span class="k">constraints</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">collinear</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">matrix</span><span class="w"> </span><span class="n">myb_ES1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">matrix</span><span class="w"> </span><span class="n">myV_ES1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cnsreg</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">D_m</span><span class="o">*</span><span class="w"> </span><span class="n">D_p</span><span class="o">*</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ibn</span><span class="p">.</span><span class="n">t</span><span class="w"> </span><span class="n">ibn</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">cluster</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">nocons</span><span class="w"> </span><span class="k">constraints</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="n">collinear</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">matrix</span><span class="w"> </span><span class="n">myb_ES2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">matrix</span><span class="w"> </span><span class="n">myV_ES2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">tempfile</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">save</span><span class="w"> </span><span class="o">`</span><span class="n">main</span><span class="s1">&#39; ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* 画图 */
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">*开始调试;
</span></span></span><span class="line"><span class="cl"><span class="s1">tempfile pooled ;
</span></span></span><span class="line"><span class="cl"><span class="s1">forvalues i = 0/10 { ;
</span></span></span><span class="line"><span class="cl"><span class="s1">drop _all ;
</span></span></span><span class="line"><span class="cl"><span class="s1">set obs 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">gen label = &#34;m`i&#39;</span><span class="s2">&#34; in 1 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">replace label = &#34;</span><span class="n">p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;&#34; in 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">gen etime = -1 * `i&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">replace</span><span class="w"> </span><span class="n">etime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; in 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">foreach j in 1 2 { ;
</span></span></span><span class="line"><span class="cl"><span class="s1">gen cf_m`j&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 设置治疗效应的估计方程 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">truth_m</span><span class="o">`</span><span class="n">j</span><span class="s1">&#39; = (0) in 1 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">replace truth_m`j&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">myb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cap</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">myb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myb_ES</span><span class="o">`</span><span class="n">j</span><span class="s1">&#39;[1,&#34;D_m`i&#39;</span><span class="s2">&#34;] ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen ES_b_m`j&#39; = `myb&#39; in 1 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">local myv = . ;
</span></span></span><span class="line"><span class="cl"><span class="s2">cap local myv = myV_ES`j&#39;[&#34;</span><span class="n">D_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;&#34;,&#34;D_m`i&#39;</span><span class="s2">&#34;] ;
</span></span></span><span class="line"><span class="cl"><span class="s2">local myse = sqrt(`myv&#39;) ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen ES_se_m`j&#39; = `myse&#39; in 1 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">local myb = 0 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">cap local myb = myb_ES`j&#39;[1,&#34;</span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;&#34;] ;
</span></span></span><span class="line"><span class="cl"><span class="s1">replace ES_b_m`j&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">myb</span><span class="s1">&#39; in 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">local myv = . ;
</span></span></span><span class="line"><span class="cl"><span class="s1">cap local myv = myV_ES`j&#39;</span><span class="p">[</span><span class="s2">&#34;D_p`i&#39;&#34;</span><span class="p">,</span><span class="s2">&#34;D_p`i&#39;&#34;</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">myse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="o">`</span><span class="n">myv</span><span class="s1">&#39;) ;
</span></span></span><span class="line"><span class="cl"><span class="s1">replace ES_se_m`j&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">myse</span><span class="s1">&#39; in 2 ;
</span></span></span><span class="line"><span class="cl"><span class="s1">} ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">capture append using `pooled&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">save</span><span class="w"> </span><span class="o">`</span><span class="n">pooled</span><span class="s1">&#39; , replace ;
</span></span></span><span class="line"><span class="cl"><span class="s1">} ;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">drop if label == &#34;m0&#34; ;
</span></span></span><span class="line"><span class="cl"><span class="s1">drop if label == &#34;p10&#34; ;
</span></span></span><span class="line"><span class="cl"><span class="s1">sort etime ;
</span></span></span><span class="line"><span class="cl"><span class="s1">save `pooled&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">note1</span><span class="w"> </span><span class="s2">&#34;gam(-1)=0&#34;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">note2</span><span class="w"> </span><span class="s2">&#34;Avg(gam(-))=0.&#34;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">forvalues</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">top_</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; = ES_b_m`i&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ES_se_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; ; 
</span></span></span><span class="line"><span class="cl"><span class="s1">gen bot_`i&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ES_b_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; - 1.96 * ES_se_m`i&#39;</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">graph</span><span class="w"> </span><span class="n">twoway</span><span class="w"> </span><span class="p">(</span><span class="n">connected</span><span class="w"> </span><span class="n">ES_b_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; truth_m`i&#39;</span><span class="w"> </span><span class="n">etime</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">msize</span><span class="p">(</span><span class="n">medsmall</span><span class="w"> </span><span class="n">medium</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">msymbol</span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="n">oh</span><span class="p">)</span><span class="w"> </span><span class="n">lpattern</span><span class="p">(</span><span class="n">solid</span><span class="w"> </span><span class="n">dot</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">line</span><span class="w"> </span><span class="n">cf_m</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; etime , lpattern(dash) )
</span></span></span><span class="line"><span class="cl"><span class="s1">(line top_`i&#39;</span><span class="w"> </span><span class="n">bot_</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; etime, lpattern(dash dash) lcolor(brown brown))
</span></span></span><span class="line"><span class="cl"><span class="s1">, legend(off) xline(-0.5) 
</span></span></span><span class="line"><span class="cl"><span class="s1">note(&#34;`i&#39;</span><span class="p">:</span><span class="w"> </span><span class="o">`</span><span class="n">note</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;&#39;</span><span class="s2">&#34;) 
</span></span></span><span class="line"><span class="cl"><span class="s2">name(g`i&#39; , replace) yscale(range(-3,3.5)) yline(0 , lpattern(dash) lcolor(black)) ;
</span></span></span><span class="line"><span class="cl"><span class="s2">} ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">graph combine g1 g2 , ti(&#34;</span><span class="err">不同等标准化估计会影响结果</span><span class="s2">&#34;) 
</span></span></span><span class="line"><span class="cl"><span class="s2">note(&#34;</span><span class="k">All</span><span class="w"> </span><span class="n">models</span><span class="p">:</span><span class="w"> </span><span class="k">Avg</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">DiD</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">structure</span><span class="p">.</span><span class="w"> </span><span class="n">T</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">E1</span><span class="o">=</span><span class="mi">11</span><span class="p">.</span><span class="s2">&#34;) ;
</span></span></span><span class="line"><span class="cl"><span class="s2">graph export figures/apdx_fig_A04.png , replace ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">end ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">cap prog drop gendata ;
</span></span></span><span class="line"><span class="cl"><span class="s2">program define gendata ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/*****************
</span></span></span><span class="line"><span class="cl"><span class="s2">主要数据生成过程选项
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* 可能的治疗效应类型 */
</span></span></span><span class="line"><span class="cl"><span class="s2">1 - 零治疗效应
</span></span></span><span class="line"><span class="cl"><span class="s2">2 - 阶梯函数治疗效应
</span></span></span><span class="line"><span class="cl"><span class="s2">3 - 永久爬坡
</span></span></span><span class="line"><span class="cl"><span class="s2">4 - 爬坡到平台
</span></span></span><span class="line"><span class="cl"><span class="s2">5 - AR(1)类型
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* E_i的分布 */
</span></span></span><span class="line"><span class="cl"><span class="s2">T = 19; E_i ~ U(6,14)
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* 是否存在从未被处理的单位？ */
</span></span></span><span class="line"><span class="cl"><span class="s2">是; 否
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* Y0（潜在结果的&#34;</span><span class="err">信号</span><span class="s2">&#34;）动态 */
</span></span></span><span class="line"><span class="cl"><span class="s2">1 - 基本: Y0 = 0
</span></span></span><span class="line"><span class="cl"><span class="s2">2 - 水平变化: Y0_i,t = E_i
</span></span></span><span class="line"><span class="cl"><span class="s2">3 - 趋势变化: Y0_i,t = t * E_i
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">主要选项结束
</span></span></span><span class="line"><span class="cl"><span class="s2">******************/
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">drop _all ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/*
</span></span></span><span class="line"><span class="cl"><span class="s2">/* 经典 ES 数据结构 */
</span></span></span><span class="line"><span class="cl"><span class="s2">set obs 9 ;/* 组数 */
</span></span></span><span class="line"><span class="cl"><span class="s2">gen i = _n ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen E_i = 5 + i ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen treated = 1 ;/* 全部实验组 */
</span></span></span><span class="line"><span class="cl"><span class="s2">expand 20 ;/* 时间段数 */
</span></span></span><span class="line"><span class="cl"><span class="s2">*/
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">set obs 10 ;/* 组数 */
</span></span></span><span class="line"><span class="cl"><span class="s2">gen i = _n ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* NxT DiD 数据结构*/
</span></span></span><span class="line"><span class="cl"><span class="s2">gen treated = i &gt; 5 ;/* 一半实验组 */
</span></span></span><span class="line"><span class="cl"><span class="s2">gen E_i = 11 if treated == 1 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">expand 20 ;/* 时间段数 */
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">sort i ;
</span></span></span><span class="line"><span class="cl"><span class="s2">qui by i: gen t = _n ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">xtset i t ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/* 创建决定 DGP 的变量 */
</span></span></span><span class="line"><span class="cl"><span class="s2">gen D = (t == E_i) ; /* 事件&#34;</span><span class="err">脉冲</span><span class="s2">&#34; */
</span></span></span><span class="line"><span class="cl"><span class="s2">gen etime = (t - E_i) ;/* 事件虚拟时间 */
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">gen TE = 1 * (etime &gt;= 0) ;/* 实验组判断 */
</span></span></span><span class="line"><span class="cl"><span class="s2">*gen TE = (etime &gt;= 0) * (etime+1) ;/* endless ramp function for treatment effect */
</span></span></span><span class="line"><span class="cl"><span class="s2">replace TE = 0 if E_i == . ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">gen treated_post = etime &gt;= 0 ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">gen Y0_pure = 0 + 1 * treated ;/* 偏移量 counterfactual */
</span></span></span><span class="line"><span class="cl"><span class="s2">*gen Y0_pure = 4 * treated +  0.3 * treated * t ;/* treated have a pre-trend ... */
</span></span></span><span class="line"><span class="cl"><span class="s2">*gen Y0_pure = 4 * treated +  0.01 * treated * (t-10) * (E_i - 9);/* pre-trend based on E_i ... */
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">gen eps = sqrt(0.3) * rnormal() ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen actual = Y0_pure + TE * treated ;
</span></span></span><span class="line"><span class="cl"><span class="s2">gen y = actual + eps ;/* observed Y */
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">end ;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">runme ;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>C 部分剩余部分是 Timing-based 的数据仿真实验，代码结结构式一样的，只是数据结构和约束方式不一样，这里不再重复，只放出效果图。</p>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623235118903.webp" title="Timing-based结构数据" data-thumbnail="/img/stata事件研究法2.zh-cn-20240623235118903.webp" data-sub-html="<h2> </h2><p>Timing-based结构数据</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623235118903.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623235118903.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623235118903.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240623235118903.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240623235118903.webp" />
    </a><figcaption class="image-caption">Timing-based结构数据</figcaption>
    </figure></p>
<ul>
<li>左上角是只约束最前期两个时间虚拟变量系数相同。</li>
<li>右上角是约束最前期三个时间虚拟变量系数相同。</li>
<li>左下角是约束事前事后最两侧三期虚拟变量系数相同。</li>
<li>右下角是约束事前预期效应虚拟变量系数加总为 0。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">D_m11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D_m10</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">D_m10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D_m9</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">D_m9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D_m8</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">D_m8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D_m7</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="附录-d-接近原始数据">附录 D: 接近原始数据</h2>
<p>DID 又又又封神啦🤣（</p>
<p>附录 D 本质可以理解为加入了时间趋势（斜率对比）的分解。和前文代码结构依旧相同，这次增加点的是反事实组的预测，通过反事实组再次对比强化因果论证。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="cm">/* 创建反事实预测值 cf_ES2 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">将</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="err">初始化为观测变量</span><span class="w"> </span><span class="n">y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 按时间范围循环处理 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">qui</span><span class="w"> </span><span class="n">summ</span><span class="w"> </span><span class="n">etime</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">求</span><span class="w"> </span><span class="n">etime</span><span class="w"> </span><span class="err">的汇总统计</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">mymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">(</span><span class="k">min</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">获取最小值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">local</span><span class="w"> </span><span class="n">mymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">获取最大值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">forvalues</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">mymin</span><span class="s1">&#39;/`mymax&#39;</span><span class="w"> </span><span class="err">{</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">循环遍历时间范围</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">`</span><span class="n">i</span><span class="s1">&#39; &lt; 0 {  // 如果时间小于0
</span></span></span><span class="line"><span class="cl"><span class="s1">        local j = abs(`i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">取绝对值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">replace</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_b</span><span class="p">[</span><span class="n">D_m</span><span class="o">`</span><span class="n">j</span><span class="s1">&#39;] * D_m`j&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">减去处理效应系数乘以对应的</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="err">变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="err">{</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">如果时间大于等于</span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">replace</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_b</span><span class="p">[</span><span class="n">D_p</span><span class="o">`</span><span class="n">i</span><span class="s1">&#39;] * D_p`i&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">减去处理效应系数乘以对应的</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="err">变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 按单元类型和时间求反事实预测均值 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">egen</span><span class="w"> </span><span class="n">meancf_ES2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">cf_ES2</span><span class="p">),</span><span class="w"> </span><span class="k">by</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="n">unittype</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">按</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="err">和</span><span class="w"> </span><span class="n">unittype</span><span class="w"> </span><span class="err">求</span><span class="w"> </span><span class="n">cf_ES2</span><span class="w"> </span><span class="err">的均值</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624001457407.webp" title="使用前后的系数差异再次相减得到结果" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624001457407.webp" data-sub-html="<h2> </h2><p>使用前后的系数差异再次相减得到结果</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624001457407.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624001457407.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624001457407.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624001457407.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624001457407.webp" />
    </a><figcaption class="image-caption">使用前后的系数差异再次相减得到结果</figcaption>
    </figure></p>
<h2 id="附录-e重复的事件冲击">附录 E：重复的事件冲击</h2>
<p>这部分要解决的问题是。如果一个事件在不同时间重复发生，应该如何选择。此时生成的<font color="#ff0000">真实处理效应是不断衰减的曲线</font>。</p>
<p><strong>做法 1</strong>是约束事件虚拟变量的系数（$\gamma_1=\gamma_2$）相同：</p>
<p>如下约束就是分别为两期一组、三期一组、四期一组的分段。</p>
<p>以下是约束代码的例子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">#</span><span class="n">delimit</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*两期一组*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">D_m10</span><span class="o">=</span><span class="n">D_m9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">D_m8</span><span class="o">=</span><span class="n">D_m7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">D_m6</span><span class="o">=</span><span class="n">D_m5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">D_m4</span><span class="o">=</span><span class="n">D_m3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">D_m2</span><span class="o">=</span><span class="n">D_m1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">D_p0</span><span class="o">=</span><span class="n">D_p1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="n">D_p2</span><span class="o">=</span><span class="n">D_p3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">D_p4</span><span class="o">=</span><span class="n">D_p5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="n">D_p6</span><span class="o">=</span><span class="n">D_p7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="n">D_p8</span><span class="o">=</span><span class="n">D_p9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*三期一组 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">delimit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">D_m1</span><span class="o">=</span><span class="n">D_m2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="n">D_m1</span><span class="o">=</span><span class="n">D_m3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="n">D_m4</span><span class="o">=</span><span class="n">D_m5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">D_m4</span><span class="o">=</span><span class="n">D_m6</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="n">D_m7</span><span class="o">=</span><span class="n">D_m8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="n">D_m7</span><span class="o">=</span><span class="n">D_m9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="n">D_p0</span><span class="o">=</span><span class="n">D_p1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="n">D_p2</span><span class="o">=</span><span class="n">D_p1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="n">D_p3</span><span class="o">=</span><span class="n">D_p4</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="n">D_p3</span><span class="o">=</span><span class="n">D_p5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">D_p6</span><span class="o">=</span><span class="n">D_p7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">D_p6</span><span class="o">=</span><span class="n">D_p8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624121424373.webp" title="做法一：约束事件时间虚拟变量间的值相等" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624121424373.webp" data-sub-html="<h2> </h2><p>做法一：约束事件时间虚拟变量间的值相等</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624121424373.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624121424373.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624121424373.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624121424373.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624121424373.webp" />
    </a><figcaption class="image-caption">做法一：约束事件时间虚拟变量间的值相等</figcaption>
    </figure>
<strong>做法 2</strong> 是约束系数与系数间的斜率（$\gamma_1-\gamma_0=\gamma_2-\gamma_1$）相等</p>
<p>以下是约束代码的例子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">D_m10</span><span class="o">=</span><span class="n">D_m9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">D_m8</span><span class="o">=</span><span class="n">D_m7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">D_m6</span><span class="o">=</span><span class="n">D_m5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">D_m4</span><span class="o">=</span><span class="n">D_m3</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624122552395.webp" title="系数间都斜率相等的约束" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624122552395.webp" data-sub-html="<h2> </h2><p>系数间都斜率相等的约束</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624122552395.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624122552395.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624122552395.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624122552395.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624122552395.webp" />
    </a><figcaption class="image-caption">系数间都斜率相等的约束</figcaption>
    </figure></p>
<ul>
<li>左上角是普通情况。</li>
<li>右上角是两期斜率相等的分组。</li>
<li>左下角是三期斜率相等的分组。</li>
<li>右下角是事前事后两期各自相等的分组。</li>
</ul>
<h2 id="附录-f时间趋势的控制">附录 F：时间趋势的控制</h2>
<p>本文研究的是——是否加入时间趋势的控制和其他约束。</p>
<h3 id="did一个个体两个时间">DID：一个个体，两个时间</h3>
<p>两种约束，一种是加入趋势控制——控制变量加入 <code>trend_group2</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">//</span><span class="err">趋势控制变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">group2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">E_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">11</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">gen</span><span class="w"> </span><span class="n">trend_group2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">group2</span><span class="w"> </span><span class="err">相同的约束</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="err">其他约束类型和前文相同，保证事件虚拟时间系数相等或者斜率相等</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624142702710.webp" title="施加的约束包含加入趋势控制和事件时间虚拟变量的约束" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624142702710.webp" data-sub-html="<h2> </h2><p>施加的约束包含加入趋势控制和事件时间虚拟变量的约束</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624142702710.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624142702710.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624142702710.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624142702710.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624142702710.webp" />
    </a><figcaption class="image-caption">施加的约束包含加入趋势控制和事件时间虚拟变量的约束</figcaption>
    </figure></p>
<h3 id="time-based-一个个体两个时间">Time-based ：一个个体，两个时间</h3>
<p>接下来验证 Time-based 数据形式</p>
<p>DID 形式有对照组辅助生成反事实预测，但是 time-based 缺少对照组。一般有如下几种选择：</p>
<ol>
<li>事前、事末的几期事件虚拟时间系数相同，使图像更加平滑</li>
<li>事前、事末地几期事件虚拟时间系数间的斜率相同，更体现趋势</li>
<li>事前趋势系数加总约束为 0</li>
<li>多个事件时间的趋势加权约束加总为 0</li>
</ol>
<p>可以发现，在下图实验约束条件时，第四个图居然得出来奇怪的结果。
其施加的约束有：</p>
<ol>
<li>个体固定效应加总为 0</li>
<li>事前效应加总为 0</li>
<li>事后末期斜率相同</li>
<li>加权事前趋势为 0</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="err">\\我没看明白这里约束</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="err">的基期怎么来的？</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m7</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m4</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">D_m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624144455930.webp" title="time-based的仿真实验" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624144455930.webp" data-sub-html="<h2> </h2><p>time-based的仿真实验</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624144455930.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624144455930.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624144455930.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624144455930.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624144455930.webp" />
    </a><figcaption class="image-caption">time-based的仿真实验</figcaption>
    </figure></p>
<p>那我们是选择约束<strong>系数斜率相同</strong>还是<strong>系数值相同</strong>呢？</p>
<p>答案是根据情况来。如果一个政策的真实效果不会随时间变动，就选择<strong>系数值相同</strong>的约束，如果政策效果随时间变动就选择<strong>系数斜率相同</strong>。

<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624145615657.webp" title="事件效果不随时间改变的跳跃冲击仿真，此时系数值相同估计更有效" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624145615657.webp" data-sub-html="<h2> </h2><p>事件效果不随时间改变的跳跃冲击仿真，此时系数值相同估计更有效</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624145615657.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624145615657.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624145615657.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624145615657.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624145615657.webp" />
    </a><figcaption class="image-caption">事件效果不随时间改变的跳跃冲击仿真，此时系数值相同估计更有效</figcaption>
    </figure></p>
<blockquote>
<p>个人觉得这个结论变成循环论证了。本来就是通过事件研究法估计处理效应（动态还是静态是需要我们研究的结果），现在倒变成根据结果来选择方法来。</p>
<p>当然，启发无非就是分析政策背景做出假设，进而选择约束方式。</p>
</blockquote>
<h3 id="did多个体多时间">DID：多个体，多时间</h3>
<p>对于多期 DID 来说，加入<strong>多个事件时间的趋势加权约束为 0</strong>则会使得估计更加有效。如图：</p>
<p>第一列是普通估计，没有施加个体时间双向固定以外的限制
第二列是在第一列基础上加入了事件事前趋势加总为 0 的约束：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">//</span><span class="err">事件日期依旧是</span><span class="mi">10</span><span class="err">和</span><span class="mi">5</span><span class="err">两期，个人没有看懂</span><span class="mi">5</span><span class="p">.</span><span class="mi">5</span><span class="err">的基期设置怎么来的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="o">-</span><span class="mi">4</span><span class="p">.</span><span class="mi">5</span><span class="o">*</span><span class="n">D_m10</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="o">*</span><span class="n">D_m9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="o">*</span><span class="w"> </span><span class="n">D_m8</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="o">*</span><span class="w"> </span><span class="n">D_m7</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="o">*</span><span class="n">D_m6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m5</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m4</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="n">D_m3</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="n">D_m2</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="n">D_m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第三列是加入了类型控制</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">gen</span><span class="w"> </span><span class="n">treated_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624151534335.webp" title="DID估计：橙色部分是基于残差预测的反事实组" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624151534335.webp" data-sub-html="<h2> </h2><p>DID估计：橙色部分是基于残差预测的反事实组</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624151534335.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624151534335.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624151534335.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624151534335.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624151534335.webp" />
    </a><figcaption class="image-caption">DID估计：橙色部分是基于残差预测的反事实组</figcaption>
    </figure></p>
<h3 id="time--based多个体多时间">Time -based：多个体，多时间</h3>
<p>
<figure class="center-figure"><a class="lightgallery" href="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624155445274.webp" title="time-based，橙色也是反事实组" data-thumbnail="/img/stata事件研究法2.zh-cn-20240624155445274.webp" data-sub-html="<h2> </h2><p>time-based，橙色也是反事实组</p>">
        <img
            class="lazyload center-image"
            src="/svg/loading.min.svg"
            data-src="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624155445274.webp"
            data-srcset="/img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624155445274.webp, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624155445274.webp 1.5x, /img/stata%e4%ba%8b%e4%bb%b6%e7%a0%94%e7%a9%b6%e6%b3%952.zh-cn-20240624155445274.webp 2x"
            data-sizes="auto"
            alt="/img/stata事件研究法2.zh-cn-20240624155445274.webp" />
    </a><figcaption class="image-caption">time-based，橙色也是反事实组</figcaption>
    </figure>
上面全是实验组的 Time -based 结构中，但是这次多了个体差异。</p>
<p>第二列比第一列多了个体分组和时间加权趋势为 0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="o">//</span><span class="err">个体分组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Egen</span><span class="w"> </span><span class="n">unittype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="p">(</span><span class="n">E_i</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Egen</span><span class="w"> </span><span class="n">meany</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="n">unittype</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="err">时间趋势加权，我还是没看懂</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="err">的基期是怎么出来的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">103</span><span class="w">   </span><span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m5</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D_m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="p">;</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第三列比第二列多了系数约束</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">D_m7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D_m6</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">constraint</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">D_m6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D_m5</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p>事件分析法是 DID 的一种推广。</p>
<blockquote>
<p>个人理解是，事件分析法会基于 DID 进一步进行时间切片。由于时间虚拟变量增多，求解也需要更多的约束，因此我们得根据研究背景添加时间趋势的控制。</p>
</blockquote>
<ol>
<li>DID 和事件研究法互为补充，事件研究法能进一步展现 DID 估计的动态效应（随时间增加，减少，变异后回归正常值）。如果两种估计都方向相反，可能是由于选择了错误的约束条件，或者存在共线性的相关问题。</li>
<li>不同的数据结构，事件分析法应选择不同的额外约束数量和方式。</li>
<li>从附件代码实验来说——</li>
</ol>
<ul>
<li>Time-based 数据集求解需要添加约束，约束的添加根据事件时间数和个体数判断。</li>
<li>事件研究法中，事前趋势标准化一般会比较准确。</li>
<li>只有一个个体、不同时间冲击的数据集，得谨慎添加约束，可能得出相反的结果。</li>
<li>多个个体的数据，无论是 time-based 还是 did，都应该加上组类别控制。</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2024-06-24</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/zh-cn/posts/event2/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://blog.huaxiangshan.com/zh-cn/posts/event2/" data-title=" 计量：事件研究法 2" data-hashtags="因果效应,文献阅读"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://blog.huaxiangshan.com/zh-cn/posts/event2/" data-hashtag="因果效应"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://blog.huaxiangshan.com/zh-cn/posts/event2/" data-title=" 计量：事件研究法 2"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://blog.huaxiangshan.com/zh-cn/posts/event2/" data-title=" 计量：事件研究法 2"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://blog.huaxiangshan.com/zh-cn/posts/event2/" data-title=" 计量：事件研究法 2" data-image="/img/stata事件研究法2.zh-cn-20240624163058043.webp"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/zh-cn/tags/%E5%9B%A0%E6%9E%9C%E6%95%88%E5%BA%94/">因果效应</a>,&nbsp;<a href="/zh-cn/tags/%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB/">文献阅读</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/zh-cn/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/zh-cn/posts/event1/" class="prev" rel="prev" title=" 计量：事件研究法 1"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i> 计量：事件研究法 1</a>
            <a href="/zh-cn/posts/paf/" class="next" rel="next" title=" 养老金和生育率"> 养老金和生育率<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app">Giscus</a>.
            </noscript></div></article></div>
            </main><script>

(function() {
  console.log('[Music Player] Enhanced initialization script loaded');

  
  const CDN_SOURCES = [
    'https://cdn.jsdelivr.net/npm/',
    'https://unpkg.com/',
    'https://cdnjs.cloudflare.com/ajax/libs/'
  ];

  const APLAYER_CSS = 'aplayer@1.10.1/dist/APlayer.min.css';
  const APLAYER_JS = 'aplayer@1.10.1/dist/APlayer.min.js';
  const METING_JS = 'meting@2.0.1/dist/Meting.min.js';

  
  function safeHasMusicPlayers() {
    try {
      return document.querySelectorAll('meting-js').length > 0;
    } catch (e) {
      console.warn('[Music Player] Error checking for music players:', e);
      return false;
    }
  }

  function safeResourcesLoaded() {
    try {
      return typeof window.APlayer !== 'undefined' && typeof window.Meting !== 'undefined';
    } catch (e) {
      console.warn('[Music Player] Error checking resources:', e);
      return false;
    }
  }

  
  function loadResource(url, resourceType, retries = 2) {
    return new Promise((resolve, reject) => {
      const isCSS = resourceType === 'css';
      const isJS = resourceType === 'js';

      
      const existing = isCSS
        ? document.querySelector(`link[href*="${url.split('/').pop()}"]`)
        : document.querySelector(`script[src*="${url.split('/').pop()}"]`);

      if (existing) {
        console.log(`[Music Player] Resource already loaded: ${url}`);
        resolve();
        return;
      }

      const element = isCSS ? document.createElement('link') : document.createElement('script');

      if (isCSS) {
        element.rel = 'stylesheet';
        element.href = url;
      } else {
        element.src = url;
      }

      let attempts = 0;

      const attemptLoad = () => {
        attempts++;

        element.onload = () => {
          console.log(`[Music Player] Successfully loaded: ${url}`);
          resolve();
        };

        element.onerror = (err) => {
          console.warn(`[Music Player] Failed to load ${url} (attempt ${attempts}/${retries + 1})`);

          if (attempts <= retries) {
            
            const nextCDN = CDN_SOURCES.find(cdn => url.startsWith(cdn));
            if (nextCDN) {
              const nextUrl = url.replace(nextCDN, CDN_SOURCES[(CDN_SOURCES.indexOf(nextCDN) + 1) % CDN_SOURCES.length]);
              console.log(`[Music Player] Retrying with alternative CDN: ${nextUrl}`);
              if (isCSS) {
                element.href = nextUrl;
              } else {
                element.src = nextUrl;
              }
              setTimeout(attemptLoad, 500);
            } else {
              reject(err);
            }
          } else {
            reject(err);
          }
        };

        
        if (isCSS) {
          document.head.appendChild(element);
        } else {
          document.body.appendChild(element);
        }
      };

      attemptLoad();
    });
  }

  
  function loadDependencies() {
    console.log('[Music Player] Loading dependencies with fallback support...');

    
    const primaryCDN = CDN_SOURCES[0];

    return loadResource(primaryCDN + APLAYER_CSS, 'css', 1)
      .then(() => {
        console.log('[Music Player] APlayer CSS loaded');
        return loadResource(primaryCDN + APLAYER_JS, 'js', 1);
      })
      .then(() => {
        console.log('[Music Player] APlayer JS loaded');
        return loadResource(primaryCDN + METING_JS, 'js', 1);
      })
      .then(() => {
        console.log('[Music Player] All dependencies loaded successfully');
        return true;
      })
      .catch(async (err) => {
        console.error('[Music Player] Primary CDN failed, trying alternative CDNs:', err);

        
        for (let i = 1; i < CDN_SOURCES.length; i++) {
          try {
            const cdn = CDN_SOURCES[i];
            console.log(`[Music Player] Trying CDN: ${cdn}`);

            await loadResource(cdn + APLAYER_CSS, 'css', 0);
            await loadResource(cdn + APLAYER_JS, 'js', 0);
            await loadResource(cdn + METING_JS, 'js', 0);

            console.log('[Music Player] Successfully loaded from alternative CDN');
            return true;
          } catch (altErr) {
            console.warn(`[Music Player] CDN ${CDN_SOURCES[i]} failed:`, altErr);
            continue;
          }
        }

        console.error('[Music Player] All CDN attempts failed');
        return false;
      });
  }

  
  function initializePlayers() {
    try {
      if (!safeResourcesLoaded()) {
        console.error('[Music Player] Cannot initialize: dependencies not loaded');
        return false;
      }

      console.log('[Music Player] Initializing meting-js players...');
      let successCount = 0;
      let errorCount = 0;

      const players = document.querySelectorAll('meting-js');

      players.forEach(el => {
        try {
          if (el.hasAttribute('data-initialized')) {
            console.log('[Music Player] Player already initialized, skipping');
            return;
          }

          
          if (typeof window.Meting !== 'function') {
            throw new Error('Meting constructor not available');
          }

          new window.Meting(el);
          el.setAttribute('data-initialized', 'true');
          successCount++;
          console.log('[Music Player] Successfully initialized meting-js element');
        } catch (err) {
          errorCount++;
          console.error('[Music Player] Error initializing meting-js element:', err);
        }
      });

      console.log(`[Music Player] Initialization complete: ${successCount} successful, ${errorCount} failed`);

      
      if (successCount === 0 && players.length > 0) {
        console.log('[Music Player] No players initialized, scheduling retry...');
        setTimeout(() => {
          console.log('[Music Player] Retrying initialization...');
          initializePlayers();
        }, 1000);
      }

      return successCount > 0;
    } catch (error) {
      console.error('[Music Player] Fatal error during initialization:', error);
      return false;
    }
  }

  
  function initMusicPlayers() {
    console.log('[Music Player] Initialization triggered');

    try {
      if (!safeHasMusicPlayers()) {
        console.log('[Music Player] No meting-js elements found');
        return;
      }

      const playerCount = document.querySelectorAll('meting-js').length;
      console.log(`[Music Player] Found ${playerCount} meting-js element(s)`);

      
      if (safeResourcesLoaded()) {
        console.log('[Music Player] Resources already loaded, initializing...');
        setTimeout(() => initializePlayers(), 50);
        return;
      }

      
      const scripts = Array.from(document.querySelectorAll('script[src]'));
      const hasAPlayerScript = scripts.some(s => s.src.includes('APlayer.min.js'));
      const hasMetingScript = scripts.some(s => s.src.includes('Meting.min.js'));

      if (hasAPlayerScript || hasMetingScript) {
        console.log('[Music Player] Resources detected in DOM, waiting for load...');
        waitForResources();
        return;
      }

      
      console.log('[Music Player] Loading dependencies dynamically...');
      loadDependencies().then(success => {
        if (success) {
          console.log('[Music Player] Dependencies loaded, initializing players...');
          setTimeout(() => initializePlayers(), 100);
        } else {
          console.error('[Music Player] Failed to load dependencies, will retry in 2s');
          setTimeout(initMusicPlayers, 2000);
        }
      });
    } catch (error) {
      console.error('[Music Player] Error in initialization flow:', error);
    }
  }

  
  function waitForResources() {
    const maxWaitTime = 10000; 
    const checkInterval = 250;
    let elapsed = 0;
    let timeoutId = null;

    const check = () => {
      elapsed += checkInterval;

      if (safeResourcesLoaded()) {
        console.log(`[Music Player] Resources loaded after ${elapsed}ms`);
        setTimeout(() => initializePlayers(), 50);
        return;
      }

      if (elapsed >= maxWaitTime) {
        console.warn('[Music Player] Timeout waiting for resources, loading dynamically...');
        loadDependencies().then(success => {
          if (success) {
            setTimeout(() => initializePlayers(), 100);
          }
        });
        return;
      }

      timeoutId = setTimeout(check, checkInterval);
    };

    check();
  }

  
  function startInitialization() {
    
    setTimeout(initMusicPlayers, 100);
  }

  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[Music Player] DOMContentLoaded event fired');
      startInitialization();
    });
  } else {
    console.log('[Music Player] DOM already loaded');
    startInitialization();
  }

  
  if (typeof document.addEventListener === 'function') {
    document.addEventListener('pjax:end', function() {
      console.log('[Music Player] PJAX navigation detected');
      setTimeout(initMusicPlayers, 100);
    });
  }

  
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(() => {
        if (document.querySelectorAll('meting-js').length > 0 && !safeResourcesLoaded()) {
          console.log('[Music Player] Page visible again, checking music players...');
          initMusicPlayers();
        }
      }, 500);
    }
  });

  
  window.initMusicPlayers = initMusicPlayers;
  console.log('[Music Player] Initialization system ready');
})();
</script>



    
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-line">
                <span id="run-time" data-i18n="runtime"></span>
            </div><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.122.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreferrer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div>

            <div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024 - 2026</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/hzp2333/hzp2333.github.io" target="_blank">滑翔闪</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
            </div>

            <style>
                .footerImg {
                    height: 20px;
                }
            </style>
            <div class="footer-line custom">
                <a href="https://icp.gov.moe/?keyword=20244204" target="_blank">萌ICP备20244204号</a>
                <a style="text-decoration:none;color:#55bb8a;" href="https://travel.moe/go.html" title="异次元之旅-跃迁-我们一起去萌站成员的星球旅行吧！" target="_blank">
                    <img src="https://travel.moe/images/icon/icon64green.png" style="width:24px;height:24px" alt="异次元之旅">异次元之旅
                </a>
            </div>

            <div class="footer-line custom">
                <a href="https://www.travellings.cn/go.html" target="_blank">
                    <img src="https://www.travellings.cn/assets/logo.gif" class="footerImg" alt="开往-友链接力 v1.5" title="开往-友链接力 v1.5">
                </a>
                <a href="https://www.foreverblog.cn/" target="_blank">
                    <img src="https://foreverblog.cn/assets/logo/logo_en_default.png" class="footerImg" alt="Forever Blog">
                </a>
                <a href="https://www.foreverblog.cn/go.html" target="_blank">
                    <img src="https://foreverblog.cn/assets/logo/wormhole_2.gif" class="footerImg" alt="穿梭虫洞-随机访问十年之约友链博客" title="穿梭虫洞-随机访问十年之约友链博客">
                </a>
            </div><div class="footer-line">
  <i class="fas fa-book fa-fw" aria-hidden="true"></i>&nbsp;共 97 篇文章，346368 字</div>
    
        
        <script async src=" //busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js "></script>
    

    
        
            <section>
                
                    <span id="busuanzi_container_value_site_pv"><i class="far fa-eye fa-fw"></i>
                        
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                

                
                    &nbsp;|&nbsp;              
                

                
                    <span id="busuanzi_container_value_site_uv"><i class="fa fa-user"></i>
                        
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
            </section>
        

        
        
    


</div>
    </footer>
 

    
    <script src="https://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js" 
        data-color="0,0,0" 
        data-count="150" 
        data-zIndex="-1">
    </script>
</body>
</html>



</div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"giscus":{"category":"Announcements","categoryId":"DIC_kwDOLbBjxM4Cdr0n","darkTheme":"dark_dimmed","emitMetadata":"0","inputPosition":"bottom","lang":"zh-CN","lazyLoading":false,"lightTheme":"light","mapping":"pathname","reactionsEnabled":"1","repo":"hzp2333/Giscus","repoId":"R_kgDOLbBjxA"}},"data":{"id-1":"滑翔闪'S BLOG","id-2":"滑翔闪'S BLOG"},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/zh-cn/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js"></script><script type="text/javascript" src="/js/custom.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-CYZVM6VVZ8', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-CYZVM6VVZ8" async></script></body>
</html>
